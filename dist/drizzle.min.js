/*!
 * DrizzleJS v0.4.10
 * -------------------------------------
 * Copyright (c) 2016 Jaco Koo <jaco.koo@guyong.in>
 * Distributed under MIT license
 */
!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.Drizzle=e()}(this,function(){"use strict";function t(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function e(t,e,n,i){var r=n.replace(v[0],v[1]).replace(v[2],v[3]);this.pattern=new RegExp("^"+r+"$",t.options.caseSensitiveHash?"g":"gi"),this.app=t,this.router=e,this.path=n,this.fn=i}var n=function(){function t(t,e){var n=[],i=!0,r=!1,o=void 0;
try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);i=!0);}catch(u){r=!0,o=u}finally{try{!i&&s["return"]&&s["return"]()}finally{if(r)throw o}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t;
},r={},o=r,a=[].slice,s=function(t,e){var n=[];if(!t)return n;if(t.map)return t.map(e);for(var i=0;i<t.length;i++)n.push(e(t[i],i,t));return n},u=function(t,e){var n=[],i=void 0;if(!t)return n;for(i in t)o.hasOwnProperty.call(t,i)&&n.push(e(t[i],i,t));return n},c=function y(t){if(o.isObject(t)){var e=function(){var e={};return u(t,function(t,n){return e[n]=y(t)}),{v:e}}();if("object"===("undefined"==typeof e?"undefined":i(e)))return e.v}return o.isArray(t)?s(t,function(t){return y(t)}):t},l=function(t){
for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];var r=t;return r&&s(n,function(t){return t&&u(t,function(t,e){return r[e]=t})}),r},h=function(t,e,n){function i(){this.constructor=t}var r=t;return l(r,e),i.prototype=e.prototype,r.prototype=new i,l(r.prototype,n),r.__super__=e.prototype,r},d={View:{},Region:{},Module:{},Model:{},Store:{},register:function(t,e,n){this[t][e]=n},create:function(t,e){for(var n=this[t][e]||o[t],i=arguments.length,r=Array(i>2?i-2:0),a=2;a<i;a++)r[a-2]=arguments[a];
return new(Function.prototype.bind.apply(n,[null].concat(r)))}},_=0,p=null;"undefined"!=typeof window&&(p=window),s(["Function","Array","String","Object"],function(t){var e="[object "+t+"]";o["is"+t]=function(t){return o.toString.call(t)===e}}),s(["Module","View","Region","Model","Store"],function(t){o["register"+t]=function(e,n){return d.register(t,e,n)},d["create"+t]=function(e){for(var n=arguments.length,i=Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];return d.create.apply(d,[t,e].concat(i));
}}),l(o,{assign:l,uniqueId:function(){var t=arguments.length<=0||void 0===arguments[0]?"":arguments[0];return""+t+ ++_},adapt:function(t){l(o.Adapter,t)},extend:h}),o.Adapter={Promise:Promise,ajax:function(t){var e=new XMLHttpRequest,n="";t.data&&(n=u(t.data,function(t,e){return e+"="+encodeURIComponent(t)}).join("&")),e.open(t.type,n&&"GET"===t.type?t.url+"?"+n:t.url,!0);var i=new Promise(function(t,n){e.onload=function(){return this.status>=200&&this.status<400?void t(JSON.parse(this.response)):void n(e);
},e.onerror=function(){n(e)}});return n&&e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.beforeRequest&&t.beforeRequest(e),e.send(n),i},exportError:function(){},ajaxResult:function(t){return t[0]},getFormData:function(t){throw new Error("getFormData is not implemented",t)},addEventListener:function(t,e,n,i){t.addEventListener(e,n,i)},removeEventListener:function(t,e,n){t.removeEventListener(e,n)},hasClass:function(t,e){return t.classList.contains(e)},addClass:function(t,e){
t.classList.add(e)},removeClass:function(t,e){t.classList.remove(e)}},o.Promise=function(t){this.context=t},o.assign(o.Promise.prototype,{create:function(t){var e=this;return new o.Adapter.Promise(function(n,i){t.call(e.context,n,i)})},resolve:function(t){return o.Adapter.Promise.resolve(t)},reject:function(t){return o.Adapter.Promise.reject(t)},parallel:function(t){for(var e=this,n=arguments.length,i=Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];return this.create(function(n,r){var a=[],c=[],l={};
return s(t,function(t,n){var s=void 0;try{s=o.isFunction(t)?t.apply(e.context,i):t}catch(u){return o.Adapter.exportError(u),void r(u)}s&&s.then?(l[c.length]=n,c.push(s)):a[n]=s}),0===c.length?n(a):void o.Adapter.Promise.all(c).then(function(t){u(l,function(e,n){return a[n]=t[e]}),n(a)},function(t){r(t)})})},chain:function(){for(var e=this,n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];var a=null,s=function u(n,i,r,s){var c=function(t){a=t,0===n.length?r(a):u(n,n.shift(),r,s)};if(o.isArray(i))0===i.length?c([]):e.parallel.apply(e,[i].concat(t(null!=a?[a]:[]))).then(c,s);else{
var l=void 0;try{l=o.isFunction(i)?i.apply(e.context,null!=a?[a]:[]):i}catch(h){return o.Adapter.exportError(h),void s(h)}l&&l.then?l.then(c,s):c(l)}};return 0===i.length?this.resolve():this.create(function(t,e){s(i,i.shift(),t,e)})}}),o.Event={on:function(t,e,n){this._events||(this._events={}),(this._events[t]||(this._events[t]=[])).push({fn:e,ctx:n})},off:function(t,e){if(this._events&&t&&this._events[t]){if(!e)return void delete this._events[t];var n=[];return s(this._events[t],function(t){t.fn!==e&&n.push(t);
}),0===n.length?void delete this._events[t]:void(this._events[t]=n)}},trigger:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return t&&this._events&&this._events[t]?void s(this._events[t],function(t){return t.fn.apply(t.ctx,n)}):this},delegateEvent:function(t){var e=this,n="--"+t.id,i=t;return l(i,{_listeners:{},listenTo:function(t,e,n,r){(i._listeners[e]||(i._listeners[e]=[])).push({fn:n,obj:t}),t.on(e,n,r||i)},stopListening:function(t,e,n){u(i._listeners,function(r,o){
var a=[];s(r,function(i){var r=n&&i.fn===n&&e===o&&t===i.obj;return r=r||!n&&e&&e===o&&t===i.obj,r=r||!n&&!e&&t&&t===i.obj,(r=r||!n&&!e&&!t)?void i.obj.off(o,i.fn):void a.push(i)}),i._listeners[o]=a,0===a.length&&delete i._listeners[o]})},on:function(t,r,o){i.listenTo(e,t+n,r,o)},off:function(t,r){i.stopListening(e,t&&t+n,r)},trigger:function(t){if(!t)return i;for(var r=arguments.length,o=Array(r>1?r-1:0),a=1;a<r;a++)o[a-1]=arguments[a];o.unshift(t+n)&&e.trigger.apply(e,o)}}),this}},o.Request={get:function(t,e){
return this._ajax("GET",t,t.getParams(),e)},post:function(t,e){return this._ajax("POST",t,t.data,e)},put:function(t,e){return this._ajax("PUT",t,t.data,e)},del:function(t,e){return this._ajax("DELETE",t,t.data,e)},save:function(t,e){return t.data&&t.data[t._idKey]?this.put(t,e):this.post(t,e)},_url:function(t){var e=[],n=t.module._option("urlPrefix",t)||"",i=t.app._option("urlRoot",t)||"",r=t.app._option("urlSuffix",t)||"",o=t._url()||"";for(i&&e.push(i),n&&e.push(n),e.push(t.module.name);0===o.indexOf("../");)e.pop(),
o=o.slice(3);return o&&e.push(o),t.data&&t.data[t._idKey]&&e.push(t.data[t._idKey]),r&&e.push(e.pop()+r),e.join("/")},_ajax:function(t,e,n,i){var r=l({type:t},i);return r.data=l({},n,r.data),r.url=this._url(e),e.Promise.create(function(t,n){o.Adapter.ajax(r,e).then(function(){for(var n=arguments.length,i=Array(n),a=0;a<n;a++)i[a]=arguments[a];e.set(o.Adapter.ajaxResult(i),!r.slient),t(i)},function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];return n(e)})})}},o.ComponentManager={
_handlers:{},_componentCache:{},setDefaultHandler:function(t){var e=arguments.length<=1||void 0===arguments[1]?function(){}:arguments[1];this._defaultHandler={creator:t,destructor:e}},register:function(t,e){var n=arguments.length<=2||void 0===arguments[2]?function(){}:arguments[2];this._handlers[t]={creator:e,destructor:n}},_create:function(t,e){var n=this,i=e.name,r=e.id,a=e.selector,s=e.options;i||t._error("Component name can not be null");var u=this._handlers[i]||this._defaultHandler;u||t._error("No handler for component:",i);
var c=a?t.$$(a):t.$(r),l=r?r:o.uniqueId("comp");return t.chain(u.creator(t,c,s),function(e){var i=t.id+l,a=n._componentCache[i],c={id:i,handler:u,index:o.uniqueId(i),options:s};return o.isArray(a)?a.push(c):n._componentCache[i]=a?[a,c]:c,{id:r,component:e,index:c.index}})},_destroy:function(t,e){var n=this,i=t.id+e.id,r=this._componentCache[i],a=r;o.isArray(r)?(this._componentCache[i]=[],s(r,function(t){t.index!==e.index?n._componentCache[i].push(t):a=t}),0===this._componentCache[i].length&&delete this._componentCache[i]):delete this._componentCache[i],
a.handler.destructor(t,e.component,a.options)}},o.Base=function(t){var e=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],n=arguments[2];this.options=e,this.id=o.uniqueId("D"),this.name=t,this.Promise=new o.Promise(this),l(this,n),e.mixin&&this._mixin(e.mixin),this._loadedPromise=this._initialize()},o.assign(o.Base.prototype,{_initialize:function(){},_option:function(t){for(var e=this.options[t],n=arguments.length,i=Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];return o.isFunction(e)?e.apply(this,i):e;
},_error:function(t){if(!o.isString(t))throw t;for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];throw new Error("["+(this.module?this.module.name+":":"")+this.name+"] "+t+" "+n.join(" "))},_mixin:function(t){var e=this;u(t,function(t,n){var i=e[n];return i?void(o.isFunction(i)&&(e[n]=function(){for(var n=arguments.length,r=Array(n),o=0;o<n;o++)r[o]=arguments[o];return r.unshift(i),t.apply(e,r)})):void(e[n]=t)})},chain:function(){var t;return(t=this.Promise).chain.apply(t,arguments);
}}),o.Renderable=function(t,e,n,i,r){o.Renderable.__super__.constructor.call(this,t,r,{app:e,module:n,components:{},_loader:i,_componentMap:{},_events:{}}),this._eventHandlers=this._option("handlers"),e.delegateEvent(this)},h(o.Renderable,o.Base,{_initialize:function(){var t=this;return this._templateEngine=this._option("templateEngine")||this.module&&this.module._templateEngine||this.app._templateEngine,this.chain([this._templateEngine._load(this),this._initializeEvents()],function(e){var i=n(e,1),r=i[0];
return t._template=r})},render:function(t){return this._render(null==t?this.renderOptions:t,!0)},$:function(t){return this.$$("#"+this._wrapDomId(t))[0]},$$:function(t){return this._getElement().querySelectorAll(t)},_render:function(t,e){var n=this;return this._region||this._error("Region is null"),this.renderOptions=null==t?this.renderOptions||{}:t,this.chain(this._loadedPromise,this._destroyComponents,function(){return n.trigger("beforeRender")},function(){return n._option("beforeRender")},this._beforeRender,this._serializeData,function(t){
return n._renderTemplate(t,e)},this._renderComponents,this._afterRender,function(){return n._option("afterRender")},function(){return n.trigger("afterRender")},this)},_setRegion:function(t){this._region=t,this._bindEvents()},_close:function(){var t=this;return this._region?this.chain(function(){return t.trigger("beforeClose")},function(){return t._option("beforeClose")},this._beforeClose,[this._unbindEvents,this._destroyComponents,function(){return t._region._empty(t)}],this._afterClose,function(){
return t._option("afterClose")},function(){return t.trigger("afterClose")},function(){return delete t._region},this):this.Promise.resolve(this)},_getElement:function(){return this._region?this._region._getElement(this):null},_serializeData:function(){return{Global:this.app.global,Self:this}},_renderTemplate:function(t,e){this._templateEngine._execute(this,t,this._template,e)},_initializeEvents:function(t){var e=this;u(t||this._option("events"),function(t,n){var i=n.replace(/(^\s+)|(\s+$)/g,"").split(/\s+/),r={
key:n};2!==i.length&&e._error("Invalid event key"),r.eventType=i[0],"*"===i[1].slice(-1)?(r.id=e._wrapDomId(i[1].slice(0,-1)),r.haveStar=!0,r.selector="[id^="+r.id+"]"):(r.id=e._wrapDomId(i[1]),r.selector="#"+r.id),r.handler=e._createEventHandler(t,r),e._events[n]=r})},_getEventTarget:function(t,e){for(var n=this._getElement(),i=t;i!==n;){var r=i.getAttribute("id");if(r&&r.slice(0,e.length)===e)return i;i=i.parentNode}},_createEventHandler:function(t,e){var n=this,i=e.haveStar,r=e.id,a=this.app.options.disabledClass;
return function(){for(var e=arguments.length,s=Array(e),u=0;u<e;u++)s[u]=arguments[u];n._eventHandlers[t]||n._error("No event handler for name:",t);var c=s[0],l=n._getEventTarget(c.target,r);o.Adapter.hasClass(l,a)||(i&&s.unshift(l.getAttribute("id").slice(r.length)),n._eventHandlers[t].apply(n,s))}},_bindEvents:function(){var t=this;u(this._events,function(e){t._region._delegateDomEvent(t,e.eventType,e.selector,e.handler)})},_unbindEvents:function(){this._region._undelegateDomEvents(this)},_renderComponents:function(){
var t=this;return this.chain(s(this._option("components"),function(e){var n=o.isFunction(e)?e.call(t):e;return n?o.ComponentManager._create(t,n):null}),function(e){return s(e,function(e){if(e){var n=e.id,i=e.component,r=e.index,a=t.components[n];o.isArray(a)?a.push(i):t.components[n]=a?[a,i]:i,t._componentMap[r]=e}})})},_destroyComponents:function(){var t=this;this.components={},u(this._componentMap,function(e){return o.ComponentManager._destroy(t,e)}),this._componentMap={}},_wrapDomId:function(t){
return this.id+t},_beforeRender:function(){},_afterRender:function(){},_beforeClose:function(){},_afterClose:function(){}}),o.RenderableContainer=function(){o.RenderableContainer.__super__.constructor.apply(this,arguments)},h(o.RenderableContainer,o.Renderable,{_initialize:function(){var t=o.RenderableContainer.__super__._initialize.call(this);return this.items={},this.chain(t,this._initializeItems)},_afterRender:function(){return this.chain(this._initializeRegions,this._renderItems)},_afterClose:function(){
return this._closeRegions()},_initializeItems:function(){var t=this;this.chain(u(this._option("items"),function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=arguments[1],i=o.isFunction(e)?e.call(t):e;return o.isString(i)&&(i={region:i}),t.app[e.isModule?"_createModule":"_createView"](n,t).then(function(e){var r=e;return r.moduleOptions=i,t.items[n]=e,e})}))},_initializeRegions:function(){var t=this;return this.regions={},this.chain(this.closeRegions,s(this.$$("[data-region]"),function(e){
var n=t._createRegion(e);t.regions[n.name]=n}))},_renderItems:function(){var t=this;return this.chain(u(this.items,function(e){var n=e.moduleOptions.region;return n?(t.regions[n]||t._error("Region: "+n+" is not defined"),t.regions[n].show(e)):null}),this)},_createRegion:function(t){var e=t.getAttribute("data-region");return this.app._createRegion(t,e,this)},_closeRegions:function(){var t=this.regions;return t?(delete this.regions,this.chain(u(t,function(t){return t.close()}),this)):this}}),o.ActionCreator=function(){
o.ActionCreator.__super__.constructor.apply(this,arguments)},o.extend(o.ActionCreator,o.Renderable,{_initializeEvents:function(){var t=o.ActionCreator.__super__._initializeEvents;t.call(this),t.call(this,this._option("actions"))},_createEventHandler:function(t,e){var n=o.ActionCreator.__super__._createEventHandler,i=!!(this._option("actions")||{})[e.key];return i?this._createAction(t,e):n.call(this,t,e)},_createAction:function(t,e){var n=this,i=e.id,r=this.app.options.disabledClass,a=this._option("dataForActions")||{},s=a[t],u=this._option("actionCallbacks")||{},c=u[t];
return function(e){var a=n._getEventTarget(e.target,i);if(!o.Adapter.hasClass(a,r)){o.Adapter.addClass(a,r);var u=n._getActionPayload(a);n.chain(o.isFunction(s)?s.call(n,u,e):u,function(e){return e!==!1&&n.module.dispatch(t,e)},function(t){return t!==!1&&(c&&c.call(n,t))}).then(function(){return o.Adapter.removeClass(a,r)},function(){return o.Adapter.removeClass(a,r)})}}},_getActionPayload:function(t){for(var e=this._getElement(),n=t,i=!1;n&&n!==e&&"FORM"!==n.tagName;)n=n.parentNode;n||(n=e);var r="FORM"===n.tagName?o.Adapter.getFormData(n):{};
return s(n.querySelectorAll("[data-name][data-value]"),function(e){if(e===t)return i=t.getAttribute("data-name"),void(r[i]=t.getAttribute("data-value"));var n=e.getAttribute("data-name");if(!i||i!==n){var a=e.getAttribute("data-value"),s=r[n];o.isArray(s)?s.push(a):r[n]=null==s?a:[s,a]}}),r}}),o.View=function(){o.View.__super__.constructor.apply(this,arguments)},h(o.View,o.ActionCreator,{_initialize:function(){return this.bindings={},this.chain(o.View.__super__._initialize.call(this),this._initializeDataBinding);
},_initializeDataBinding:function(){var t=this;this._dataBinding={},u(this._option("bindings"),function(e,n){var i=t.bindings[n]=t.module.store.models[n];i||t._error("No model:",n),e&&(t._dataBinding[n]={model:i,value:e,fn:function(){e===!0&&t._region&&t.render(t.renderOptions),o.isString(e)&&t._option(e)}})})},_bindData:function(){var t=this;u(this._dataBinding,function(e){return t.listenTo(e.model,"changed",e.fn)})},_unbindData:function(){this.stopListening()},_setRegion:function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];
o.View.__super__._setRegion.apply(this,e),this._bindData()},_close:function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];this.chain(o.View.__super__._close.apply(this,e),this._unbindData,this)},_serializeData:function(){var t=this,e=o.View.__super__._serializeData.call(this);return u(this.bindings,function(t,n){return e[n]=t.get(!0)}),u(this._option("dataForTemplate"),function(n,i){return e[i]=n.call(t,e)}),e}}),o.Module=function(){o.Module.__super__.constructor.apply(this,arguments);
},o.extend(o.Module,o.RenderableContainer,{_initialize:function(){return this.app._modules[this.name+"--"+this.id]=this,this._initializeStore(),o.Module.__super__._initialize.call(this)},dispatch:function(t,e){return this.store.dispatch(t,e)},_initializeStore:function(){this.store=this.app._createStore(this,this._option("store"))},_afterClose:function(){return delete this.app._modules[this.name+"--"+this.id],this.store._destory(),o.Module.__super__._afterClose.call(this)},_beforeRender:function(){
var t=this;return this.chain(o.Module.__super__._beforeRender.call(this),function(){return t.store._loadEagerModels()})},_afterRender:function(){var t=this;return this.chain(o.Module.__super__._afterRender.call(this),function(){return t.store._loadLazyModels()})}});var f=["blur","focus","scroll","resize"];o.Region=function(t,e,n,i){o.Region.__super__.constructor.call(this,i||"Region",{},{app:t,module:e,_el:n,_delegated:{}}),this._el||this._error("The DOM element for region is required"),t.delegateEvent(this);
},h(o.Region,o.Base,{show:function(t,e){var i=this;return this._isCurrent(t)?e&&e.forceRender===!1?this.Promise.resolve(this._current):this._current._render(e,!0):this.chain(o.isString(t)?this.app._createModule(t):t,function(t){return t instanceof o.Renderable||i._error("The item is expected to be an instance of Renderable"),t},[function(t){return i.chain(t._region&&t._region.close(),t)},function(){return i._current&&i.close()}],function(t){var e=n(t,1),r=e[0];i._current=r;var o=r.module?r.module.name+":"+r.name:r.name;
return i._getElement().setAttribute("data-current",o),r._setRegion(i),r},function(t){return t._render(e,!1)})},close:function(){var t=this;return this.chain(this._current&&this._current._close(),function(){return delete t._current},this)},$$:function(t){return this._getElement().querySelectorAll(t)},_isCurrent:function(t){return!!this._current&&(this._current.name===t||!(!t||t.id!==this._current.id))},_getElement:function(){return this._el},_empty:function(){this._getElement().innerHTML=""},_createDelegateListener:function(t){
var e=this;return function(){for(var n=arguments.length,i=Array(n),r=0;r<n;r++)i[r]=arguments[r];if(e._delegated[t]){var o=i[0],a=o.target;s(e._delegated[t].items,function(t){for(var n=e._getElement().querySelectorAll(t.selector),r=!1,o=0;o<n.length;o++){var s=n[o];if(s===a||s.contains(a)){r=s;break}}r&&t.fn.apply(t.renderable,i)})}}},_delegateDomEvent:function(t,e,n,i){var r=this._delegated[e];r||(r=this._delegated[e]={listener:this._createDelegateListener(e),items:[]},o.Adapter.addEventListener(this._getElement(),e,r.listener,f.indexOf(e)!==-1)),
r.items.push({selector:n,fn:i,renderable:t})},_undelegateDomEvents:function(t){var e=this;u(this._delegated,function(n,i){var r=[],a=n;s(a.items,function(e){e.renderable!==t&&r.push(e)}),a.items=r,0===r.length&&(delete e._delegated[i],o.Adapter.removeEventListener(e._getElement(),i,a.listener))})}}),o.TemplateEngine=function(t){o.TemplateEngine.__super__.constructor.call(this,"Template Engine",t,{_templateCache:{}})},h(o.TemplateEngine,o.Base,{executeIdReplacement:function(t,e){var n=this,i={};s(t.querySelectorAll("[id]"),function(t){
var r=t.getAttribute("id");i[r]&&n._error("Dom ID: "+r+" is already used"),i[r]=!0,t.setAttribute("id",e._wrapDomId(r))});var r=this._option("attributesReferToId")||["for","data-target","data-parent"];s(r,function(n){return s(t.querySelectorAll("["+n+"]"),function(t){var i=t.getAttribute(n),r="#"===i.charAt(0),o=r?"#"+e._wrapDomId(i.slice(1)):e._wrapDomId(i);t.setAttribute(n,o)})})},_load:function(t){var e=t.id;return this._templateCache[e]?this._templateCache[e]:this._templateCache[e]=this._loadIt(t);
},_loadIt:function(t){return t instanceof r.Module?t._loader.loadModuleResource(t,"templates"):function(){return t.module._template}},_execute:function(t,e,n){var i=t._getElement();i.innerHTML=n(e),this.executeIdReplacement(i,t)}}),o.Store=function(t,e){var n=this;o.Store.__super__.constructor.call(this,"Store",e,{app:t.app,module:t,models:{}}),this.app.delegateEvent(this),this._callbacks=this._option("callbacks"),u(this._callbacks,function(t,e){if("app."===e.slice(0,4))return void n.listenTo(n.app,e,function(e){
return t.call(n._callbackContext,e)});if("shared."===e.slice(0,7)){var i=e.slice(7),r=n.models[i];r&&r.store!==n||n._error("Can not bind to model: "+e),n.listenTo(r,"changed",function(){return t.call(n._callbackContext)})}})},h(o.Store,o.Base,{dispatch:function(t,e){var n=void 0,i=t,r=e;return o.isObject(i)&&(r=i.payload,i=i.name),n=this._callbacks[i],n||this._error("No action callback for name: "+t),this.chain(n.call(this._callbackContext,r))},_initialize:function(){this._initializeModels(),this._callbackContext=l({
app:this.app,models:this.models,module:this.module,chain:this.chain},o.Request),this._callbackContext.Promise=new o.Promise(this._callbackContext)},_initializeModels:function(){var t=this;u(this._option("models"),function(e,n){var i=(o.isFunction(e)?e.call(t):e)||{};return i.shared===!0?t.app.viewport?void(t.models[n]=t.app.viewport.store.models[n]):(t.module.name===t.app._option("viewport")&&t._error("Can not define shared model in viewport"),void(t.module.module&&t.module.module.name===t.app._option("viewport")&&(t.models[n]=t.module.module.store.models[n]))):void(t.models[n]=t.app._createModel(t,i));
})},_loadEagerModels:function(){var t=this;return this.chain(u(this.models,function(e){return e.store!==t?null:e.options.autoLoad===!0?o.Request.get(e):null}))},_loadLazyModels:function(){var t=this;return this.chain(u(this.models,function(e){if(e.store!==t)return null;var n=e.options.autoLoad;return n&&n!==!0?o.Request.get(e):null}))},_destory:function(){this.stopListening()}}),o.Model=function(t,e){o.Model.__super__.constructor.call(this,"Model",e,{app:t.module.app,module:t.module,store:t}),this.data=this._option("data")||{},
this._idKey=this._option("idKey")||this.app.options.idKey,this.params=l({},this._option("params")),this.app.delegateEvent(this)},o.extend(o.Model,o.Base,{getFullUrl:function(){return o.Request._url(this)},set:function(t,e){var n=this.options.parse?this._option("parse",t):t;this.data=this.options.root?n[this.options.root]:n,e&&this.changed()},getParams:function(){return this.params},get:function(t){return t?c(this.data):this.data},clear:function(t){this.data=o.isArray(this.data)?[]:{},t&&this.changed();
},changed:function(){this.trigger("changed")},_url:function(){return this._option("url")||""}}),o.Loader=function(t,e){o.Loader.__super__.constructor.call(this,"Loader",e,{app:t})},o.assign(o.Loader,{_analyse:function(t){if(!o.isString(t))return{loader:null,name:t};var e=t.split(":"),n=e.length>1?e.shift():null;return{loader:n,name:e.shift(),args:e}}}),o.extend(o.Loader,o.Base,{loadResource:function(t){var e=this,n=this.app.options,i=n.scriptRoot,r=n.getResource,o=n.amd,a=i+"/"+t;return this.Promise.create(function(t,n){
o?require([a],t,n):t(r?r.call(e.app,a):require("./"+a))})},loadModuleResource:function(t,e){return this.loadResource(t.name+"/"+e)},loadModule:function(t){return this.loadResource(t+"/index")},loadView:function(t,e){return this.loadModuleResource(e,"view-"+t)},loadRouter:function(t){var e="router";return this.loadResource(t?t+"/"+e:e)}}),o.Application=function(t){o.Application.__super__.constructor.call(this,t&&t.name||"Application",l({scriptRoot:"app",urlRoot:"",urlSuffix:"",caseSensitiveHash:!1,
container:p&&p.document.body,disabledClass:"disabled",getResource:null,idKey:"id",viewport:"viewport"},t),{global:{},_modules:{},_loaders:{}})},o.extend(o.Application,o.Base,{_initialize:function(){this._templateEngine=this._option("templateEngine")||new o.TemplateEngine,this.registerLoader("default",new o.Loader(this),!0),this._region=this._createRegion(this._option("container"),"Region")},registerLoader:function(t,e,n){return this._loaders[t]=e,n&&(this._defaultLoader=e),this},start:function(e){
var n,i=this;return e&&(this._router=new o.Router(this)),this.chain(!!e&&(n=this._router)._mountRoutes.apply(n,t(this._option("routers"))),this._region.show(this._option("viewport")),function(t){return i.viewport=t},function(){return e&&i._router._start(e)},this)},stop:function(){this.off(),this._region.close(),this._router&&this._router._stop()},navigate:function(t,e){this._router&&this._router.navigate(t,e)},dispatch:function(t,e){var n=o.isObject(t)?t.name:t,i=o.isObject(t)?t.payload:e;this.trigger("app."+n,i);
},show:function(t,e,n){return this.viewport.regions[t].show(e,n)},_getLoader:function(t,e){return t&&this._loaders[t]||e&&e._loader||this._defaultLoader},_createModule:function(t,e){var n=this,i=o.Loader._analyse(t),r=i.name,a=i.loader,s=this._getLoader(a,parent);return this.chain(s.loadModule(r),function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return d.createModule(t.type,r,n,e,s,t)})},_createView:function(t,e){var n=this,i=o.Loader._analyse(t),r=i.name,a=i.loader,s=this._getLoader(a,e);
return this.chain(s.loadView(r,e),function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return d.createView(t.type,r,n,e,s,t)})},_createRegion:function(t,e,n){var i=o.Loader._analyse(e),r=i.name,a=i.loader;return d.createRegion(a,this,n,t,r)},_createStore:function(t){var e=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return d.createStore(e.type,t,e)},_createModel:function(t){var e=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return d.createModel(e.type,t,e);
}}),l(o.Application.prototype,o.Event);var g=p&&p.history&&"pushState"in p.history,v=[/:([\w\d]+)/g,"([^/]+)",/\*([\w\d]+)/g,"(.*)"];l(e.prototype,{match:function(t){return this.pattern.lastIndex=0,this.pattern.test(t)},handle:function(e){var n,i=this;this.pattern.lastIndex=0;var r=this.pattern.exec(e).slice(1),o=this.router._getInterceptors(this.path);return o.push(this.fn),(n=this.router).chain.apply(n,t(s(o,function(t,e){return function(n){return t.apply(i.router,e>0?[n].concat(r):r)}})))}}),o.Router=function(t){
var e=this;o.Router.__super__.constructor.call(this,"Router",{},{app:t,_routes:[],_interceptors:{},_started:!1}),this._EVENT_HANDLER=function(){return e._dispath(e._getHash())}},h(o.Router,o.Base,{navigate:function(t,e){this._started&&(g?p.history.pushState({},p.document.title,"#"+t):p.location.replace("#"+t),e!==!1&&this._dispath(t))},_start:function(t){if(!this._started&&p){o.Adapter.addEventListener(p,"hashchange",this._EVENT_HANDLER,!1);var e=this._getHash()||t;this._started=!0,e&&this.navigate(e);
}},_stop:function(){this._started&&(o.Adapter.removeEventListener(p,"hashchange",this._EVENT_HANDLER),this._started=!1)},_dispath:function(t){if(t!==this._previousHash){this._previousHash=t;for(var e=0;e<this._routes.length;e++){var n=this._routes[e];if(n.match(t))return void n.handle(t)}}},_mountRoutes:function(){var t=this,e=a.call(arguments);return this.chain(s(e,function(e){return t.app._getLoader(e).loadRouter(e)}),function(n){return s(n,function(n,i){return t._addRoute(e[i],n)})})},_addRoute:function(t,n){
var i=this,r=n.routes,a=n.interceptors;u(o.isFunction(r)?r.apply(this):r,function(r,o){var a=(t+"/"+o).replace(/^\/|\/$/g,"");i._routes.unshift(new e(i.app,i,a,n[r]))}),u(o.isFunction(a)?a.apply(this):a,function(e,r){var o=(t+"/"+r).replace(/^\/|\/$/g,"");i._interceptors[o]=n[e]})},_getInterceptors:function(t){var e=[],n=t.split("/");for(n.pop();n.length>0;){var i=n.join("/");this._interceptors[i]&&e.unshift(this._interceptors[i]),n.pop()}return this._interceptors[""]&&e.unshift(this._interceptors[""]),
e},_getHash:function(){return p.location.hash.slice(1)}});var m={pageSize:10,pageKey:"_page",pageSizeKey:"pageSize",recordCountKey:"recordCount",params:function(t){return t}};return o.PageableModel=function(t,e){o.PageableModel.__super__.constructor.call(this,t,e),this.data=this._option("data")||[],this._p={page:this._option("page")||1,pageCount:0,pageSize:this._option("pageSize")||m.pageSize,pageKey:this._option("pageKey")||m.pageKey,pageSizeKey:this._option("pageSizeKey")||m.pageSizeKey,recordCountKey:this._option("recordCountKey")||m.recordCountKey
}},l(o.PageableModel,{setDefault:function(t){l(m,t)}}),h(o.PageableModel,o.Model,{set:function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],e=arguments[1];this._p.recordCount=t[this._p.recordCountKey]||0,this._p.pageCount=Math.ceil(this._p.recordCount/this._p.pageSize),o.PageableModel.__super__.set.call(this,t,e)},getParams:function(){var t=this._p,e=t.page,n=t.pageKey,i=t.pageSizeKey,r=t.pageSize,o=this.params;return o[n]=e,o[i]=r,m.params(o)},clear:function(t){this._p.page=1,
this._p.recordCount=0,this._p.pageCount=0,o.PageableModel.__super__.clear.call(this,t)},turnToPage:function(t){return t<=this._p.pageCount&&t>=1&&(this._p.page=t),this},firstPage:function(){return this.turnToPage(1)},lastPage:function(){return this.turnToPage(this._p.pageCount)},nextPage:function(){return this.turnToPage(this._p.page+1)},prevPage:function(){return this.turnToPage(this._p.page-1)},getPageInfo:function(){var t=this._p,e=t.page,n=t.pageSize,i=t.recordCount,r=void 0;return r=this.data&&this.data.length>0?{
page:e,start:(e-1)*n+1,end:e*n,total:i}:{page:e,start:0,end:0,total:0},r.end>r.total&&(r.end=r.total),r}}),o.registerModel("pageable",o.PageableModel),o.MultiRegion=function(){o.MultiRegion.__super__.constructor.apply(this,arguments)},o.extend(o.MultiRegion,o.Region,{_initialize:function(){this._items={},this._elements={}},activate:function(){},show:function(t){var e=this,i=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=t.moduleOptions,a=o.isString(t),s=i.key;a||t instanceof o.Renderable||this._error("The item is expected to be an instance of Renderable"),
!s&&r&&r.key&&(s=r.key),s||this._error("Region key is required");var u=this._items[s];return this._isCurrent(s,u,t)?i.forceRender===!1?this.Promise.resolve(u):u.render(i):this.chain(a?this.app._createModule(t):t,[function(t){return e.chain(t._region&&t._region.close(),t)},function(){return e.chain(u&&u._close(),function(){delete e._items[s],delete e._elements[s]})}],function(t){var r=n(t,1),o=r[0],a=o.module?o.module.name+":"+o.name:o.name,u=e._getElement(o,s);return e._items[s]=o,u.setAttribute("data-current",a),
o._setRegion(e),o._render(i,!1)})},_createElement:function(){var t=p.document.createElement("div");return this._el.appendChild(t),t},_getElement:function(t,e){if(!t)return this._el;var n=e||t.renderOptions.key||t.moduleOptions.key;return this._elements[n]||(this._elements[n]=this._createElement(n,t)),this._elements[n]},_isCurrent:function(t,e,n){return!!e&&(e.name===n||n&&n.id===e.id)},_empty:function(t){if(!t)return void o.MultiRegion.__super__._empty.call(this);var e=this._getElement(t);e.parentNode.removeChild(e);
},close:function(){var t=this;return this.chain(u(this._items,function(t){return t._close()}),function(){t._elements={},t._items={},delete t._current},this)}}),r});
//# sourceMappingURL=drizzle.min.js.map
