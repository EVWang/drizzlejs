// DrizzleJS v0.2.0
// -------------------------------------
// Copyright (c) 2014 Jaco Koo <jaco.koo@guyong.in>
// Distributed under MIT license


var __slice=[].slice,__hasProp={}.hasOwnProperty,__extends=function(a,b){function c(){this.constructor=a}for(var d in b)__hasProp.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};!function(a,b){var c,d;return"function"==typeof define&&define.amd?define(["jquery","handlebars"],function(c,d){return b(a,c,d)}):module&&module.exports?(c=require("jquery"),d=require("handlebars"),module.exports=b(a,c,d)):a.Drizzle=b(a,c)}(this,function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B;for(f=g={version:"0.2.0"},t=a.Drizzle,r=0,A=["Function","Object","String","Array","Number","Boolean","Date","RegExp","Undefined","Null"],u=function(a){return f["is"+a]=function(b){return Object.prototype.toString.call(b)==="[object "+a+"]"}},w=0,y=A.length;y>w;w++)s=A[w],u(s);for(f.extend=function(){var a,b,c,d,e,g,h;if(d=arguments[0],c=2<=arguments.length?__slice.call(arguments,1):[],!f.isObject(d))return d;for(g=0,h=c.length;h>g;g++){b=c[g];for(a in b)e=b[a],d[a]=e}return d},f.extend(f,{uniqueId:function(a){return(a?a:"")+ ++r},noConflict:function(){return a.Drizzle=oldReferrence,f},joinPath:function(){var a;return a=1<=arguments.length?__slice.call(arguments,0):[],a.join("/").replace(/\/+/g,"/")}}),f.Deferred={createDeferred:function(){return f.deferredCount||(f.deferredCount=1),f.deferredCount++,b.Deferred()},createRejectedDeferred:function(){var a,b;return a=1<=arguments.length?__slice.call(arguments,0):[],b=this.createDeferred(),b.reject.apply(b,a),b},createResolvedDeferred:function(){var a,b;return a=1<=arguments.length?__slice.call(arguments,0):[],b=this.createDeferred(),b.resolve.apply(b,a),b},deferred:function(){var a,b,c;return b=arguments[0],a=2<=arguments.length?__slice.call(arguments,1):[],f.isFunction(b)&&(b=b.apply(this,a)),(null!=b?b.promise:void 0)?b.promise():(c=this.createDeferred(),c.resolve(b),c.promise())},chain:function(){var a,c,d,e;return e=1<=arguments.length?__slice.call(arguments,0):[],d=this.createDeferred(),0===e.length?(d.resolve(),d.promise()):(c=[],a=function(g){return function(h,i){var j,k,l,m;return k=function(a){return!f.isArray(h)&&a.length<2&&(a=a[0]),c.push(a)},(f.isArray(h)?(m=function(){var a,b,d;for(d=[],a=0,b=h.length;b>a;a++)l=h[a],j=[l],i>0&&j.push(c[i-1]),d.push(this.deferred.apply(this,j));return d}.call(g),b.when.apply(b,m)):(j=[h],i>0?j.push(c[i-1]):void 0,g.deferred.apply(g,j))).done(function(){var b;return b=1<=arguments.length?__slice.call(arguments,0):[],k(b),0===e.length?d.resolve(c[c.length-1]):a(e.shift(),++i)}).fail(function(){var a;return a=1<=arguments.length?__slice.call(arguments,0):[],k(a),d.reject.apply(d,c)})}}(this),a(e.shift(),0),d.promise())}},f.Event={on:function(a,b,c){var d;return this.registeredEvents||(this.registeredEvents={}),((d=this.registeredEvents)[a]||(d[a]=[])).push({fn:b,context:c}),this},off:function(a,b,c){var d;return this.registeredEvents&&(d=this.registeredEvents[a])?(this.registeredEvents[a]=function(){var a,e,f;for(f=[],a=0,e=d.length;e>a;a++)s=d[a],(s.fn!==b||c&&c!==s.context)&&f.push(s);return f}(),0===this.registeredEvents[a].length&&delete this.registeredEvents[a],this):this},trigger:function(){var a,b,c,d,e;if(c=arguments[0],a=2<=arguments.length?__slice.call(arguments,1):[],!this.registeredEvents||!(b=this.registeredEvents[c]))return this;for(d=0,e=b.length;e>d;d++)s=b[d],s.fn.apply(s.context,a);return this},delegateEvent:function(a){return f.extend(a,{on:function(b){return function(c,d,e){return a.listenTo(b,""+c+"."+a.id,d,e),a}}(this),off:function(b){return function(){var c;return c=1<=arguments.length?__slice.call(arguments,0):[],c.length>0&&c.unshift(""+c.shift()+"."+a.id),c.unshift(b),a.stopListening.apply(a,c),a}}(this),trigger:function(b){return function(){var c,d;return d=arguments[0],c=2<=arguments.length?__slice.call(arguments,1):[],c.unshift(""+d+"."+a.id),b.trigger.apply(b,c),a}}(this),listenTo:function(a,b,c,d){var e,f;return e=d||this,this.registeredListeners||(this.registeredListeners={}),((f=this.registeredListeners)[b]||(f[b]=[])).push({fn:c,obj:a,context:e}),a.on(b,c,e),this},stopListening:function(a,b,c){var d,e,f,g,h,i,j,k;if(!this.registeredListeners)return this;if(!a){j=this.registeredListeners;for(d in j)for(e=j[d],f=0,h=e.length;h>f;f++)s=e[f],s.obj.off(d,s.fn,this);return this.registeredListeners={},this}k=this.registeredListeners;for(d in k)if(e=k[d],!b||b===d){for(this.registeredListeners[d]=[],g=0,i=e.length;i>g;g++)s=e[g],s.obj!==a||c&&c!==s.fn?this.registeredListeners[d].push(s):s.obj.off(d,s.fn,s.context);0===this.registeredListeners[d].length&&delete this.registeredListeners[d]}return this}})}},f.Request={url:function(a){var b,c;for(c=[f.Config.urlRoot],a.module.options.urlPrefix&&c.push(a.module.options.urlPrefix),c.push(a.module.name),b=a.url||"",f.isFunction(b)&&(b=b.apply(a));0===b.indexOf("../");)paths.pop(),b=b.slice(3);return c.push(b),a.data.id&&c.push(a.data.id),f.joinPath.apply(f,c)},get:function(a,b){return this.ajax({type:"GET"},a,a.getParams(),b)},post:function(a,b){return this.ajax({type:"POST"},a,a.data,b)},put:function(a,b){return this.ajax({type:"PUT"},a,a.data,b)},del:function(a,b){return this.ajax({type:"DELETE"},a,a.data,b)},ajax:function(a,c,d,e){var g;return null==e&&(e={}),g=this.url(c),a=f.extend(a,{contentType:f.Config.defaultContentType},e),d=f.extend(d,e.data),a.url=g,a.data=d,f.Deferred.chain(b.ajax(a),function(a){return c.setData(a)})}},g.Base=e=function(){function a(a){this.id=g.uniqueId(a),this.initialize()}return a.include=function(){var a,b,c,d,e,f;for(c=1<=arguments.length?__slice.call(arguments,0):[],e=0,f=c.length;f>e;e++){b=c[e];for(a in b)d=b[a],this.prototype[a]=d}return this},a.include(g.Deferred),a.prototype.initialize=function(){},a.prototype.getOptionResult=function(a){return f.isFunction(a)?a.apply(this):a},a.prototype.extend=function(a){var b,c,d,e;if(a){b=function(a){return function(b,c){var d;return g.isFunction(c)?(d=a[b],a[b]=function(){var a;return a=1<=arguments.length?__slice.call(arguments,0):[],d&&a.unshift(d),c.apply(this,a)}):a[b]?void 0:a[b]=c}}(this),e=[];for(c in a)d=a[c],e.push(b(c,d));return e}},a}(),f.Application=d=function(a){function d(a){this.options=null!=a?a:{},this.modules=new k.Container,this.global={},this.loaders={},this.regions=[],d.__super__.constructor.call(this,"a"),this.modules.delegateEvent(this)}return __extends(d,a),d.prototype.initialize=function(){var a,c,d;this.registerLoader(new f.SimpleLoader(this)),this.registerLoader(new f.Loader(this),!0),d=f.Helpers;for(a in d)c=d[a],this.registerHelper(a,c);return this.setRegion(new f.Region(this,null,b(document.body)))},d.prototype.registerLoader=function(a,b){return this.loaders[a.name]=a,b?this.defaultLoader=a:void 0},d.prototype.registerHelper=function(a,b){var d;return d=this,c.registerHelper(a,function(){var a;return a=1<=arguments.length?__slice.call(arguments,0):[],b.apply(this,[d,c].concat(a))})},d.prototype.getLoader=function(a){var b;return b=i.analyse(a).loader,b&&this.loaders[b]?this.loaders[b]:this.defaultLoader},d.prototype.setRegion=function(a){return this.region=a,this.regions.unshift(this.region)},d.prototype.startRoute=function(){var a,b,c;return a=arguments[0],b=2<=arguments.length?__slice.call(arguments,1):[],this.router||(this.router=new f.Router(this)),this.chain((c=this.router).mountRoutes.apply(c,b),function(){return this.router.start(a)})},d.prototype.navigate=function(a,b){return this.router.navigate(a,b)},d.prototype.load=function(){var a,b;return b=1<=arguments.length?__slice.call(arguments,0):[],this.chain(function(){var c,d,e;for(e=[],c=0,d=b.length;d>c;c++)a=b[c],e.push(this.getLoader(a).loadModule(a));return e}.call(this))},d.prototype.show=function(a,b){return this.region.show(a,b)},d.prototype.destory=function(){var a;return this.chain(function(){var b,c,d,e;for(d=this.regions,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.close());return e}.call(this))},d.prototype.message={success:function(a,b){return alert(b||a)},info:function(a,b){return b||(b=a),alert(b||a)},error:function(a,b){return b||(b=a),alert(b||a)}},d}(f.Base),f.Model=j=function(a){function b(a,c,d){var e,g;this.app=a,this.module=c,this.options=null!=d?d:{},this.data=this.options.data||{},this.params={},d.pageable&&(e=f.Config.pagination,g=this.pagination={page:d.page||1,pageCount:0,pageSize:d.pageSize||e.pageSize,pageKey:d.pageKey||e.pageKey,pageSizeKey:d.pageSizeKey||e.pageSizeKey,recordCountKey:d.recordCountKey||e.recordCountKey}),b.__super__.constructor.call(this,"d"),this.module.container.delegateEvent(this)}return __extends(b,a),b.prototype.set=function(a){var b;return this.data=f.isFunction(this.options.parse)?this.options.parse(a):a,(b=this.pagination)&&(b.recordCount=this.data[b.recordCountKey],b.pageCount=Math.ceil(b.recordCount/b.pageSize)),this.options.root&&(this.data=this.data[this.options.root]),this},b.prototype.append=function(a){return f.isObject(this.data)?f.extend(this.data,a):f.isArray(this.data)&&(this.data=this.data.concat(f.isArray(a)?a:[a])),this},b.prototype.find=function(a,b){var c,d,e,g;if(!f.isArray(this.data))return null;for(e=this.data,g=[],c=0,d=e.length;d>c;c++)s=e[c],s[a]===b&&g.push(s);return g},b.prototype.findOne=function(a,b){var c,d,e;if(!f.isArray(this.data))return null;for(e=this.data,c=0,d=e.length;d>c;c++)if(s=e[c],s[a]===b)return s},b.prototype.url=function(){return this.getOptionResult(this.options.url)||""},b.prototype.toJSON=function(){return this.data},b.prototype.getParams=function(){var a,b;return a={},(b=this.pagination)&&(a[b.pageKey]=b.page,a[b.pageSizeKey]=b.pageSize),f.extend(a,this.params,this.options.params)},b.prototype.clear=function(){var a;return this.data={},(a=this.pagination)?(a.page=1,a.pageCount=0):void 0},b.prototype.turnToPage=function(a,b){var c;return(c=this.pagination&&a<=c.pageCount&&a>=1)?(c.page=a,this.get(b)):this.createRejectedDeferred()},b.prototype.firstPage=function(a){return this.turnToPage(1,a)},b.prototype.lastPage=function(a){return this.turnToPage(this.pagination.pageCount,a)},b.prototype.nextPage=function(a){return this.turnToPage(this.pagination.page+1,a)},b.prototype.prevPage=function(a){return this.turnToPage(this.pagination.page-1,a)},b.prototype.getPageInfo=function(){var a,b;return(b=this.pagination)?(a=this.data.length>0?{start:(b.page-1)*b.pageSize+1,end:b.page*b.pageSize,total:b.recordCount}:{start:0,end:0,total:0},a.end>a.total&&(a.end=a.total),a):{}},b}(f.Base),B=["get","post","put","del"],v=function(a){return f.Model.prototype[a]=function(b){return this.chain(f.Request[a](this,b),function(){return this.trigger("sync")})}},x=0,z=B.length;z>x;x++)s=B[x],v(s);return f.Region=m=function(a){function c(a,d,e){if(this.app=a,this.module=d,this.el=e instanceof b?e:b(e),c.__super__.constructor.call(this,"r"),0===this.el.size())throw new Error("Can not find DOM element: "+e)}return __extends(c,a),c.types={},c.register=function(a,b){return this.types[a]=b},c.create=function(a,b,d,e){var f;return new(f=this.types[a]||c)(b,d,e)},c.prototype.getEl=function(){return this.el},c.prototype.getCurrentItem=function(){return this.currentItem},c.prototype.setCurrentItem=function(a){return this.currentItem=a},c.prototype.show=function(a,b){var c;return null==b&&(b={}),(c=this.getCurrentItem(a,b))&&(f.isObject(a)&&a.id===c.id||f.isString(a)&&f.Loader.analyse(a).name===c.name)?this.chain(c.render(b),c):this.chain(f.isString(a)?this.app.getLoader(a).loadModule(a):a,function(a){if(!a.render||!a.setRegion)throw new Error("Can not show item: "+a);return a},[function(a){return a.region&&a.region.close(),a},function(){return this.close(c)}],function(a){var c;return c=a[0],c.setRegion(this),this.setCurrentItem(c,b),c},function(a){return a.render(b)})},c.prototype.close=function(){return s=this.currentItem,delete this.currentItem,this.chain(function(){return s?s.close():void 0},this)},c.prototype.delegateEvent=function(a,b,c,d){var e;return e=""+b+".events"+this.id+a.id,c?this.el.on(e,c,d):this.el.on(e,d)},c.prototype.undelegateEvents=function(a){return this.el.off(".events"+this.id+a.id)},c.prototype.$$=function(a){return this.el.find(a)},c.prototype.setHtml=function(a){return this.el.html(a)},c.prototype.empty=function(){return this.el.empty()},c}(f.Base),f.View=q=function(a){function c(a,b,d,e){this.name=a,this.module=b,this.loader=d,this.options=null!=e?e:{},this.app=this.module.app,this.eventHandlers={},c.__super__.constructor.call(this,"v"),this.module.container.delegateEvent(this)}return __extends(c,a),c.ComponentManager={handlers:{},register:function(a,b,c,d){return null==c&&(c=function(){}),null==d&&(d=function(){}),this.handlers[a]={creator:b,destructor:c,initializer:d,initialized:!1}},create:function(a,b){var c,d,e,f,g,h,i;if(null==b&&(b={}),e=b.id,f=b.name,i=b.selector,h=b.options,!f)throw new Error("Component name can not be null");if(!e)throw new Error("Component id can not be null");return c=i?a.$$(i):e?a.$(e):a.getEl(),d=this.handlers[f]||{creator:function(a,b,c){if(!b[f])throw new Error("No component handler for name: "+f);return b[f](c)},destructor:function(a,b){return b[f]("destroy")},initialized:!0},g=!d.initialized&&d.initializer?d.initializer():null,d.initialized=!0,a.chain(g,d.creator(a,c,h),function(a){return{id:e,component:a,info:{destructor:d.destructor,options:h}}})},destroy:function(a,b,c){return"function"==typeof c.destructor?c.destructor(a,b,c.options):void 0}},c.prototype.initialize=function(){return this.options.extend&&this.extend(this.options.extend),this.loadDeferred=this.chain([this.loadTemplate(),this.loadHandlers()])},c.prototype.loadTemplate=function(){var a;return this.module.separatedTemplate!==!0?this.chain(this.module.loadDeferred,function(){return this.template=this.module.template}):(a=this.getOptionResult(this.options.template)||this.name,this.chain(this.app.getLoader(a).loadSeparatedTemplate(this,a),function(a){return this.template=a}))},c.prototype.loadHandlers=function(){var a;return a=this.getOptionResult(this.options.handlers)||this.name,this.chain(this.app.getLoader(a).loadHandlers(this,a),function(a){return f.extend(this.eventHandlers,a)})},c.prototype.bindData=function(){return this.module.loadDeferred.done(function(a){return function(){var b,c,d,e,f,g,h,i;b=a.getOptionResult(a.options.bind)||{},a.data={},e=function(b,c){var d,e,f;return f=c.split("#"),d=f[0],e=f[1],a.listenTo(b,d,function(){var a;if(a=1<=arguments.length?__slice.call(arguments,0):[],!d||!e)throw new Error("Incorrect binding string format:"+c);return"function"==typeof this[e]?this[e].apply(this,a):void 0})};for(f in b){if(g=b[f],a.data[f]=a.module.data[f],!a.data[f])throw new Error("Model: "+f+" doesn't exists");if(!g)return;for(d=g.replace(/\s+/g,"").split(","),h=0,i=d.length;i>h;h++)c=d[h],e(a.data[f],c)}}}(this))},c.prototype.unbindData=function(){return this.stopListening(),delete this.data},c.prototype.wrapDomId=function(a){return""+this.id+a},c.prototype.setRegion=function(a){var b,c,d,e,g,h,i,j,k;this.region=a,b=this.getOptionResult(this.options.events)||{},k=[];for(e in b){if(i=b[e],!f.isString(i))throw new Error("The value defined in events must be a string");j=e.replace(/(^\s+)|(\s+$)/g,"").split(/\s+/),g=j[0],d=j[1],d&&(h="*"===d.charAt(d.length-1)?"[id^="+(d=this.wrapDomId(d.slice(0,-1)))+"]":"#"+(d=this.wrapDomId(d))),c=this.createHandler(g,d,h,i),k.push(this.region.delegateEvent(this,g,h,c))}return k},c.prototype.createHandler=function(a,c,d,e){var g;return g=this,function(){var a,h,i,j,k;return a=1<=arguments.length?__slice.call(arguments,0):[],i=b(this),i.hasClass("disabled")?void 0:(d&&"#"!==d.charAt(0)&&(j=i.attr("id"),a.unshift(j.slice(c.length))),"defer"===i.data("after-click")&&(h=g.createDeferred(),i.addClass("disabled"),h.always(function(){return i.removeClass("disabled")}),null!=(k=g.options.clickDeferred||f.Config.clickDeferred)&&k.call(this,h,i),a.unshift(h)),g.loadDeferred.done(function(){var b;if(b=g.eventHandlers[e],!b)throw new Error("No handler defined with name: "+e);return b.apply(g,a)}))}},c.prototype.getEl=function(){return this.region?this.region.getEl(this):null},c.prototype.$=function(a){if(!this.region)throw new Error("Region is null");return this.region.$$("#"+this.wrapDomId(a))},c.prototype.$$=function(a){if(!this.region)throw new Error("Region is null");return this.getEl().find(a)},c.prototype.close=function(){return this.region?this.chain(function(){var a;return null!=(a=this.options.beforeClose)?a.apply(this):void 0},[function(){return this.region.undelegateEvents(this)},function(){return this.unbindData()},function(){return this.destroyComponents()},function(){return this.unexportRegions()},function(){return this.region.empty(this)}],function(){var a;return null!=(a=this.options.afterClose)?a.apply(this):void 0},this):this.createResolvedDeferred(this)},c.prototype.render=function(){if(!this.region)throw new Error("No region to render in");return this.chain(this.loadDeferred,[this.unbindData,this.destroyComponents,this.unexportRegions],this.bindData,function(){var a;return null!=(a=this.options.beforeRender)?a.apply(this):void 0},this.beforeRender,this.serializeData,this.options.adjustData||function(a){return a},this.executeTemplate,this.executeIdReplacement,this.renderComponent,this.exportRegions,this.afterRender,function(){var a;return null!=(a=this.options.afterRender)?a.apply(this):void 0},this)},c.prototype.beforeRender=function(){},c.prototype.destroyComponents=function(){var a,b,d;a=this.components||{};for(b in a)d=a[b],c.ComponentManager.destroy(this,d,this.componentInfos[b]);return this.components={},this.componentInfos={}},c.prototype.serializeData=function(){var a,b,c,d;a={},d=this.data;for(b in d)c=d[b],a[b]=c.toJSON();return a},c.prototype.executeTemplate=function(a){var b;return a.Global=this.app.global,a.View=this,b=this.template(a),this.region.setHtml(b,this)},c.prototype.executeIdReplacement=function(){var a,c,d,e,g,h;for(c={},this.$$("[id]").each(function(a){return function(d,e){var f;if(e=b(e),f=e.attr("id"),c[f])throw new Error("The id:"+f+" is used more than once.");return c[f]=!0,e.attr("id",a.wrapDomId(f))}}(this)),g=f.Config.attributesReferToId||[],h=[],d=0,e=g.length;e>d;d++)a=g[d],h.push(this.$$("["+a+"]").each(function(c){return function(d,e){var f,g;return e=b(e),f=e.attr(a),g="#"===f.charAt(0),g?e.attr(a,"#"+c.wrapDomId(f.slice(1))):e.attr(a,c.wrapDomId(f))}}(this)));return h},c.prototype.renderComponent=function(){var a,b,d;return b=this.getOptionResult(this.options.components)||[],d=function(){var d,e,f;for(f=[],d=0,e=b.length;e>d;d++)a=b[d],a=this.getOptionResult(a),f.push(a?c.ComponentManager.create(this,a):void 0);return f}.call(this),this.chain(d,function(a){return function(b){var c,d,e,f,g;for(g=[],e=0,f=b.length;f>e;e++)c=b[e],c&&(d=c.id,a.components[d]=c.component,g.push(a.componentInfos[d]=c.info));return g}}(this))},c.prototype.exportRegions=function(){return this.exportedRegions={},this.$$("[data-region]").each(function(a){return function(c,d){var e;return d=b(d),e=d.data("region"),a.exportedRegions[e]=a.module.addRegion(e,d)}}(this))},c.prototype.unexportRegions=function(){var a,b;return this.chain(function(){var c,d;c=this.exportedRegions,d=[];for(a in c)b=c[a],d.push(b.close());return d}.call(this),function(){var c,d;c=this.exportedRegions,d=[];for(a in c)b=c[a],d.push(this.module.removeRegion(a));return d}.call(this))},c.prototype.afterRender=function(){},c}(e),l=function(a){function b(){this.modules={},b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.include(f.Event),b.prototype.checkId=function(a){if(!a||!f.isString(a))throw new Error("id: "+a+" is invalid");if(this.modules[a])throw new Error("id: "+a+" is already used")},b.prototype.get=function(a){return this.modules[a]},b.prototype.changeId=function(a,b){var c;if(a!==b){if(this.checkId(b),c=this.modules[a],!c)throw new Error("module id: "+a+" not exists");return delete this.modules[a],c.id=b,this.modules[b]=c}},b.prototype.add=function(a){return this.checkId(a.id),this.modules[a.id]=a},b.prototype.remove=function(a){return delete this.modules[a]},b}(f.Base),h=function(a){function b(){return b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.prototype.initialize=function(){return this.isLayout=!0,this.loadDeferred=this.chain([this.loadTemplate(),this.loadHandlers()]),delete this.bindData},b.prototype.setRegion=function(){return b.__super__.setRegion.apply(this,arguments),this.regionInfo=this.module.regionInfo},b}(f.View),f.Module=k=function(a){function b(a,c,d,e){var f;this.name=a,this.app=c,this.loader=d,this.options=null!=e?e:{},f=this.name.split("/"),this.baseName=f[f.length-1],this.container=this.options.container||this.app.modules,this.separatedTemplate=this.options.separatedTemplate===!0,this.regions={},b.__super__.constructor.call(this,"m"),this.container.add(this),this.container.delegateEvent(this)}return __extends(b,a),b.Container=l,b.Layout=h,b.prototype.initialize=function(){return this.options.extend&&this.extend(this.options.extend),this.loadDeferred=this.createDeferred(),this.chain([this.loadTemplate(),this.loadLayout(),this.loadData(),this.loadItems()],function(){return this.loadDeferred.resolve()})},b.prototype.loadTemplate=function(){return this.separatedTemplate?void 0:this.chain(this.loader.loadTemplate(this),function(a){return this.template=a})},b.prototype.loadLayout=function(){var a,b;return a=this.getOptionResult(this.options.layout),b=f.isString(a)?a:null!=a?a.name:void 0,b||(b="layout"),this.chain(this.app.getLoader(b).loadLayout(this,b,a),function(a){return function(b){return a.layout=b}}(this))},b.prototype.loadData=function(){var a,b,c,d,e;this.data={},d=[],c=this.getOptionResult(this.options.data)||{},this.autoLoadDuringRender=[],this.autoLoadAfterRender=[],a=function(a){return function(b,c){var e;return e=f.Loader.analyse(b).name,c=a.getOptionResult(c),c&&("after"===c.autoLoad||"afterRender"===c.autoLoad?a.autoLoadAfterRender.push(e):c.autoLoad&&a.autoLoadDuringRender.push(e)),d.push(a.chain(a.app.getLoader(b).loadModel(c,a),function(a){return this.data[e]=a}))}}(this);for(b in c)e=c[b],a(b,e);return this.chain(d)},b.prototype.loadItems=function(){var a,b,c,d;this.items={},this.inRegionItems=[],d=[],b=this.getOptionResult(this.options.items)||[],a=function(a){return function(b,c){var e,g;return c=a.getOptionResult(c),c&&f.isString(c)&&(c={region:c}),e=c.isModule,g=a.chain(a.app.getLoader(b)[e?"loadModule":"loadView"](b,a,c),function(b){return a.items[b.name]=b,b.regionInfo=c,c.region?a.inRegionItems.push(b):void 0}),d.push(g)}}(this);for(c in b)s=b[c],a(c,s);return this.chain(d)},b.prototype.addRegion=function(a,b){var c;return c=b.data("region-type"),this.regions[a]=m.create(c,this.app,this.module,b)},b.prototype.removeRegion=function(a){return delete this.regions[a]},b.prototype.render=function(a){if(null==a&&(a={}),!this.region)throw new Error("No region to render in");return this.renderOptions=a,a.id&&this.container.changeId(this.id,a.id),this.chain(this.loadDeferred,function(){var a;return null!=(a=this.options.beforeRender)?a.apply(this):void 0},function(){return this.layout.setRegion(this.region)},this.fetchDataDuringRender,function(){return this.layout.render()},function(){var a;return null!=(a=this.options.afterLayoutRender)?a.apply(this):void 0},function(){var a,b,c,d,e,f,g;for(f=this.inRegionItems,g=[],d=0,e=f.length;e>d;d++){if(c=f[d],a=c.regionInfo.region,b=this.regions[a],!b)throw new Error("Can not find region: "+a);g.push(b.show(c))}return g},function(){var a;return null!=(a=this.options.afterRender)?a.apply(this):void 0},this.fetchDataAfterRender,this)},b.prototype.setRegion=function(a){this.region=a},b.prototype.close=function(){return this.chain(function(){var a;return null!=(a=this.options.beforeClose)?a.apply(this):void 0},function(){return this.layout.close()},function(){var a,b,c,d;c=this.regions,d=[];for(a in c)b=c[a],d.push(b.close());return d},function(){var a;return null!=(a=this.options.afterClose)?a.apply(this):void 0},function(){return this.container.remove(this.id)},this)},b.prototype.fetchDataDuringRender=function(){var a;return this.chain(function(){var b,c,d,e,f;for(e=this.autoLoadDuringRender,f=[],c=0,d=e.length;d>c;c++)a=e[c],f.push("function"==typeof(b=this.data[a]).get?b.get():void 0);return f}.call(this))},b.prototype.fetchDataAfterRender=function(){var a;return this.chain(function(){var b,c,d,e,f;for(e=this.autoLoadAfterRender,f=[],c=0,d=e.length;d>c;c++)a=e[c],f.push("function"==typeof(b=this.data[a]).get?b.get():void 0);return f}.call(this))},b}(f.Base),f.Loader=i=function(a){function b(a){this.app=a,this.name="default",this.fileNames=f.Config.fileNames,b.__super__.constructor.apply(this,arguments)}return __extends(b,a),b.TemplateCache={},b.analyse=function(a){var b,c,d;return f.isString(a)?(d=a.split(":"),c=d[0],a=d[1],b=3<=d.length?__slice.call(d,2):[],a||(a=c,c=null),{loader:c,name:a,args:b}):{loader:null,name:a}},b.prototype.loadResource=function(a,b){var c,d;return a=f.joinPath(f.Config.scriptRoot,a),b&&(a=b+"!"+a),c=this.createDeferred(),d=function(b){var d;if((null!=(d=b.requireModules)?d[0]:void 0)===a)return define(a,null),require.undef(a),require([a],function(){}),c.resolve(null);throw c.reject(null),b},require([a],function(a){return function(b){return f.isFunction(b)&&(b=b(a.app)),c.resolve(b)}}(this),d),c.promise()},b.prototype.loadModuleResource=function(a,b,c){return this.loadResource(f.joinPath(a.name,b),c)},b.prototype.loadModule=function(a){var c;return c=b.analyse(a).name,this.chain(this.loadResource(f.joinPath(c,this.fileNames.module)),function(a){return function(b){return new f.Module(c,a.app,a,b)}}(this))},b.prototype.loadView=function(a,c){return a=b.analyse(a).name,this.chain(this.loadModuleResource(c,this.fileNames.view+a),function(b){return function(d){return new f.View(a,c,b,d)}}(this))},b.prototype.loadLayout=function(a,c,d){return null==d&&(d={}),c=b.analyse(c).name,this.chain(d.templateOnly===!1?this.loadModuleResource(a,c):{},function(b){return function(e){return new f.Module.Layout(c,a,b,f.extend(d,e))}}(this))},b.prototype.innerLoadTemplate=function(a,d){var e,g;return e=d+this.fileNames.templateSuffix,g=b.TemplateCache[a.name+e],g||(g=b.TemplateCache[a.name+e]=this.loadModuleResource(a,e,"text")),this.chain(g,function(a){return f.isString(a)&&(a=b.TemplateCache[e]=c.compile(a)),a})},b.prototype.loadTemplate=function(a){var b;return b=this.fileNames.templates,this.innerLoadTemplate(a,b)},b.prototype.loadSeparatedTemplate=function(a,b){var c;return c=this.fileNames.template+b,this.innerLoadTemplate(a.module,c)},b.prototype.loadModel=function(a,b){return null==a&&(a=""),a instanceof f.Model?a:(f.isString(a)&&(a={url:a}),new f.Model(this.app,b,a))},b.prototype.loadHandlers=function(a){return a.options.handlers||{}},b.prototype.loadRouter=function(a){var c;return c=b.analyse(a).name,a=f.joinPath(c,this.fileNames.router),"/"===a.charAt(0)&&(a=a.slice(1)),this.loadResource(a)},b}(f.Base),f.SimpleLoader=p=function(a){function b(){b.__super__.constructor.apply(this,arguments),this.name="simple"}return __extends(b,a),b.prototype.loadModule=function(a){var b;return b=i.analyse(a).name,this.deferred(new f.Module(b,this.app,this,{separatedTemplate:!0}))},b.prototype.loadView=function(a,b){return a=i.analyse(a).name,this.deferred(new f.View(a,b,this,{}))},b}(f.Loader),n=function(){function a(a,b,c,d){var e;this.app=a,this.router=b,this.path=c,this.fn=d,e=c.replace(this.regExps[0],this.regExps[1]).replace(this.regExps[2],this.regExps[3]),this.pattern=new RegExp("^"+e+"$",f.Config.caseSensitiveHash?"g":"gi")}return a.prototype.regExps=[/:([\w\d]+)/g,"([^/]+)",/\*([\w\d]+)/g,"(.*)"],a.prototype.match=function(a){return this.pattern.lastIndex=0,this.pattern.test(a)},a.prototype.handle=function(a){var b,c,d,e,f,g;return this.pattern.lastIndex=0,b=this.pattern.exec(a).slice(1),f=this.router.getDependencies(this.path),f.push(this),c=function(){var a,c,g;for(g=[],d=a=0,c=f.length;c>a;d=++a)e=f[d],g.push(function(a,c){return function(d){return a.fn.apply(a,c>0?[d].concat(b):b)}}(e,d));return g}(),(g=this.router).chain.apply(g,c)},a}(),f.Router=o=function(c){function d(a){this.app=a,this.routes=[],this.routeMap={},this.dependencies={},this.started=!1,d.__super__.constructor.call(this,"ro")}return __extends(d,c),d.prototype.initialize=function(){return this.addRoute("/",f.Config.defaultRouter)},d.prototype.getHash=function(){return a.location.hash.slice(1)},d.prototype.start=function(c){var d;if(!this.started)return this.started=!0,b(a).on("popstate.dr",function(a){return function(){return a.dispatch(a.getHash())}}(this)),(d=this.getHash())?this.navigate(d,!0):c?this.navigate(c,!0):void 0},d.prototype.stop=function(){return b(a).off(".dr"),this.started=!1},d.prototype.dispatch=function(a){var b,c,d,e;if(this.previousHash!==a)for(this.previousHash=a,e=this.routes,c=0,d=e.length;d>c;c++)if(b=e[c],b.match(a))return b.handle(a)},d.prototype.navigate=function(b,c){return a.history.pushState({},a.document.title,"#"+b),c?this.dispatch(b):void 0},d.prototype.mountRoutes=function(){var a,b;return b=1<=arguments.length?__slice.call(arguments,0):[],this.chain(function(){var c,d,e;for(e=[],c=0,d=b.length;d>c;c++)a=b[c],e.push(this.app.getLoader(a).loadRouter(a));return e}.call(this),function(a){var c,d,e,f,g;for(g=[],c=e=0,f=a.length;f>e;c=++e)d=a[c],g.push(this.addRoute(b[c],d));return g})},d.prototype.addRoute=function(a,b){var c,d,e,g,h,i,j,k;h=this.getOptionResult(b.routes),c=this.getOptionResult(b.deps);for(d in c)j=c[d],e=f.joinPath(a,d).replace(/^\//,""),i="/"===j.charAt(0)?j.slice(1):f.joinPath(a,j),this.dependencies[e]=i.replace(/^\//,"");k=[];for(d in h)j=h[d],e=f.joinPath(a,d).replace(/(^\/|\/$)/g,""),g=new n(this.app,this,e,b[j]),this.routes.unshift(g),k.push(this.routeMap[e]=g);return k},d.prototype.getDependencies=function(a){var b,c;for(c=[],b=this.dependencies[a];null!=b;)c.unshift(this.routeMap[b]),b=this.dependencies[b];return c},d}(f.Base),g.Config={scriptRoot:"app",urlRoot:"",urlSuffix:"",defaultContentType:"application/json",caseSensitiveHash:!1,attributesReferToId:["for","data-target","data-parent"],fileNames:{module:"index",templates:"templates",view:"view-",template:"template-",handler:"handler-",model:"model-",collection:"collection-",router:"router",templateSuffix:".html"},pagination:{defaultPageSize:10,pageKey:"_page",pageSizeKey:"_pageSize",recordCountKey:"recordCount"},defaultRouter:{routes:{"module/*name":"showModule"},showModule:function(a){return this.app.show(a)}},clickDeferred:function(){}},f.Helpers={layout:function(a,b,c){return this.View.isLayout?c.fn(this):""},view:function(a,b,c,d){return this.View.isLayout||this.View.name!==c?"":d.fn(this)}},g});
//# sourceMappingURL=drizzle.min.js.map