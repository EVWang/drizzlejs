/*!
 * DrizzleJS v0.4.3
 * -------------------------------------
 * Copyright (c) 2016 Jaco Koo <jaco.koo@guyong.in>
 * Distributed under MIT license
 */
!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.Drizzle=t()}(this,function(){"use strict";function e(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function t(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{
value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function n(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function O(e,t,n){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,t);if(void 0===r){var i=Object.getPrototypeOf(e);return null===i?void 0:O(i,t,n);
}if("value"in r)return r.value;var o=r.get;if(void 0!==o)return o.call(n)},o=function(){function e(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(u){i=!0,o=u}finally{try{!r&&s["return"]&&s["return"]()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=function(){
function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},u={},l=u,c=[].slice,h=function(e,t){var n=[];if(!e)return n;if(e.map)return e.map(t);for(var r=0;r<e.length;r++)n.push(t(e[r],r,e));
return n},p=function(e,t){var n=[],r=void 0;if(!e)return n;for(r in e)l.hasOwnProperty.call(e,r)&&n.push(t(e[r],r,e));return n},d=function E(e){if(l.isObject(e)){var t=function(){var t={};return p(e,function(e,n){return t[n]=E(e)}),{v:t}}();if("object"===("undefined"==typeof t?"undefined":s(t)))return t.v}return l.isArray(e)?h(e,function(e){return E(e)}):e},f=function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];var i=e;return i&&h(n,function(e){return e&&p(e,function(e,t){
return i[t]=e})}),i},_={View:{},Region:{},Module:{},Model:{},Store:{},register:function(e,t,n){this[e][t]=n},create:function(e,t){for(var n=this[e][t]||l[e],r=arguments.length,i=Array(r>2?r-2:0),o=2;r>o;o++)i[o-2]=arguments[o];return new(Function.prototype.bind.apply(n,[null].concat(i)))}},v=0,g=null;"undefined"!=typeof window&&(g=window),h(["Function","Array","String","Object"],function(e){var t="[object "+e+"]";l["is"+e]=function(e){return l.toString.call(e)===t}}),h(["Module","View","Region","Model","Store"],function(e){
l["register"+e]=function(t,n){return _.register(e,t,n)},_["create"+e]=function(t){for(var n=arguments.length,r=Array(n>1?n-1:0),i=1;n>i;i++)r[i-1]=arguments[i];return _.create.apply(_,[e,t].concat(r))}}),f(l,{assign:f,uniqueId:function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];return""+e+ ++v},adapt:function(e){f(l.Adapter,e)},extend:function(e,t,n){var r=e;return f(r,t),r.prototype=Object.create(t.prototype,{constructor:r}),f(r.prototype,n),r.__super__=t.prototype,r}}),l.Adapter={
Promise:Promise,ajax:function(e){var t=new XMLHttpRequest,n="";e.data&&(n=p(e.data,function(e,t){return t+"="+encodeURIComponent(e)}).join("&")),t.open(e.type,n&&"GET"===e.type?e.url+"?"+n:e.url,!0);var r=new Promise(function(e,n){t.onload=function(){return this.status>=200&&this.status<400?void e(JSON.parse(this.response)):void n(t)},t.onerror=function(){n(t)}});return n&&t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),e.beforeRequest&&e.beforeRequest(t),t.send(n),r},ajaxResult:function(e){
return e[0]},getFormData:function(e){throw new Error("getFormData is not implemented",e)},addEventListener:function(e,t,n,r){e.addEventListener(t,n,r)},removeEventListener:function(e,t,n){e.removeEventListener(e,t,n)},hasClass:function(e,t){return e.classList.contains(t)},addClass:function(e,t){e.classList.add(t)},removeClass:function(e,t){e.classList.remove(t)}},l.Promise=function(){function e(t){r(this,e),this.context=t}return a(e,[{key:"create",value:function(e){var t=this;return new l.Adapter.Promise(function(n,r){
e.call(t.context,n,r)})}},{key:"resolve",value:function(e){return l.Adapter.Promise.resolve(e)}},{key:"reject",value:function(e){return l.Adapter.Promise.reject(e)}},{key:"parallel",value:function(e){for(var t=this,n=arguments.length,r=Array(n>1?n-1:0),i=1;n>i;i++)r[i-1]=arguments[i];return this.create(function(n,i){var o=[],a=[],s={};return h(e,function(e,n){var u=void 0;try{u=l.isFunction(e)?e.apply(t.context,r):e}catch(c){return void i(c)}u&&u.then?(s[a.length]=n,a.push(u)):o[n]=u}),0===a.length?n(o):void l.Adapter.Promise.all(a).then(function(e){
p(s,function(t,n){return o[n]=e[t]}),n(o)},function(e){i(e)})})}},{key:"chain",value:function(){for(var e=this,t=arguments.length,r=Array(t),i=0;t>i;i++)r[i]=arguments[i];var o=null,a=function s(t,r,i,a){var u=function(e){o=e,0===t.length?i(o):s(t,t.shift(),i,a)};if(l.isArray(r))0===r.length?u([]):e.parallel.apply(e,[r].concat(n(null!=o?[o]:[]))).then(u,a);else{var c=void 0;try{c=l.isFunction(r)?r.apply(e.context,null!=o?[o]:[]):r}catch(h){return void a(h)}c&&c.then?c.then(u,a):u(c)}};return 0===r.length?this.resolve():this.create(function(e,t){
a(r,r.shift(),e,t)})}}]),e}(),l.Event={on:function(e,t,n){this._events||(this._events={}),(this._events[e]||(this._events[e]=[])).push({fn:t,ctx:n})},off:function(e,t){if(this._events&&e&&this._events[e]){if(!t)return void delete this._events[e];var n=[];return h(this._events[e],function(e){e.fn!==t&&n.push(e)}),0===n.length?void delete this._events[e]:void(this._events[e]=n)}},trigger:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];return e&&this._events&&this._events[e]?void h(this._events[e],function(e){
return e.fn.apply(e.ctx,n)}):this},delegateEvent:function(e){var t=this,n="--"+e.id,r=e;return f(r,{_listeners:{},listenTo:function(e,t,n,i){(r._listeners[t]||(r._listeners[t]=[])).push({fn:n,obj:e}),e.on(t,n,i||r)},stopListening:function(e,t,n){p(r._listeners,function(i,o){var a=[];h(i,function(r){var i=n&&r.fn===n&&t===o&&e===r.obj;return i=i||!n&&t&&t===o&&e===r.obj,i=i||!n&&!t&&e&&e===r.obj,(i=i||!n&&!t&&!e)?void r.obj.off(o,r.fn):void a.push(r)}),r._listeners[o]=a,0===a.length&&delete r._listeners[o];
})},on:function(e,i,o){r.listenTo(t,e+n,i,o)},off:function(e,i){r.stopListening(t,e&&e+n,i)},trigger:function(e){if(!e)return r;for(var i=arguments.length,o=Array(i>1?i-1:0),a=1;i>a;a++)o[a-1]=arguments[a];o.unshift(e+n)&&t.trigger.apply(t,o)}}),this}},l.Request={get:function(e,t){return this._ajax("GET",e,e.params,t)},post:function(e,t){return this._ajax("POST",e,e.data,t)},put:function(e,t){return this._ajax("PUT",e,e.data,t)},del:function(e,t){return this._ajax("DELETE",e,e.data,t)},save:function(e,t){
return e.data&&e.data[e._idKey]?this.put(e,t):this.post(e,t)},_url:function(e){var t=[],n=e.module._option("urlPrefix",e)||"",r=e.app._option("urlRoot",e)||"",i=e.app._option("urlSuffix",e)||"",o=e._url()||"";for(r&&t.push(r),n&&t.push(n),t.push(e.module.name);0===o.indexOf("../");)t.pop(),o=o.slice(3);return o&&t.push(o),e.data&&e.data[e._idKey]&&t.push(e.data[e._idKey]),i&&t.push(t.pop()+i),t.join("/")},_ajax:function(e,t,n,r){var i=f({type:e},r);return i.data=f({},n,i.data),i.url=this._url(t),
t.Promise.create(function(e,n){l.Adapter.ajax(i).then(function(){for(var n=arguments.length,r=Array(n),o=0;n>o;o++)r[o]=arguments[o];t.set(l.Adapter.ajaxResult(r),!i.slient),e(r)},function(){for(var e=arguments.length,t=Array(e),r=0;e>r;r++)t[r]=arguments[r];return n(t)})})}},l.ComponentManager={_handlers:{},_componentCache:{},setDefaultHandler:function(e){var t=arguments.length<=1||void 0===arguments[1]?function(){}:arguments[1];this._defaultHandler={creator:e,destructor:t}},register:function(e,t){
var n=arguments.length<=2||void 0===arguments[2]?function(){}:arguments[2];this._handlers[e]={creator:t,destructor:n}},_create:function(e,t){var n=this,r=t.name,i=t.id,o=t.selector,a=t.options;r||e._error("Component name can not be null");var s=this._handlers[r]||this._defaultHandler;s||e._error("No handler for component:",r);var u=o?e.$$(o):e.$(i),c=i?i:l.uniqueId("comp");return e.chain(s.creator(e,u,a),function(t){var r=e.id+c,o=n._componentCache[r],u={id:r,handler:s,index:l.uniqueId(r),options:a
};return l.isArray(o)?o.push(u):n._componentCache[r]=o?[o,u]:u,{id:i,component:t,index:u.index}})},_destroy:function(e,t){var n=this,r=e.id+t.id,i=this._componentCache[r],o=i;l.isArray(i)?(this._componentCache[r]=[],h(i,function(e){e.index!==t.index?n._componentCache[r].push(e):o=e}),0===this._componentCache[r].length&&delete this._componentCache[r]):delete this._componentCache[r],o.handler.destructor(e,t.component,o.options)}},l.Base=function(){function e(t){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],i=arguments[2];
r(this,e),this.options=n,this.id=l.uniqueId("D"),this.name=t,this.Promise=new l.Promise(this),f(this,i),n.mixin&&this._mixin(n.mixin),this._loadedPromise=this._initialize()}return a(e,[{key:"_initialize",value:function(){}},{key:"_option",value:function(e){for(var t=this.options[e],n=arguments.length,r=Array(n>1?n-1:0),i=1;n>i;i++)r[i-1]=arguments[i];return l.isFunction(t)?t.apply(this,r):t}},{key:"_error",value:function(e){if(!l.isString(e))throw e;for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;t>r;r++)n[r-1]=arguments[r];
throw new Error("["+(this.module?this.module.name+":":"")+this.name+"] "+e+" "+n.join(" "))}},{key:"_mixin",value:function(e){var t=this;p(e,function(e,n){var r=t[n];return r?void(l.isFunction(r)&&(t[n]=function(){for(var n=arguments.length,i=Array(n),o=0;n>o;o++)i[o]=arguments[o];return i.unshift(r),e.apply(t,i)})):void(t[n]=e)})}},{key:"chain",value:function(){var e;return(e=this.Promise).chain.apply(e,arguments)}}]),e}(),l.Renderable=function(n){function i(t,n,o,a,s){r(this,i);var u=e(this,Object.getPrototypeOf(i).call(this,t,s,{
app:n,module:o,components:{},_loader:a,_componentMap:{},_events:{}}));return u._eventHandlers=u._option("handlers"),n.delegateEvent(u),u}return t(i,n),a(i,[{key:"_initialize",value:function(){var e=this;return this._templateEngine=this._option("templateEngine")||this.module&&this.module._templateEngine||this.app._templateEngine,this.chain([this._templateEngine._load(this),this._initializeEvents()],function(t){var n=o(t,1),r=n[0];return e._template=r})}},{key:"render",value:function(e){return this._render(null==e?this.renderOptions:e,!0);
}},{key:"$",value:function(e){return this.$$("#"+this._wrapDomId(e))[0]}},{key:"$$",value:function(e){return this._element.querySelectorAll(e)}},{key:"_render",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=arguments[1];return this._region||this._error("Region is null"),this.renderOptions=t,this.chain(this._loadedPromise,this._destroyComponents,function(){return e.trigger("beforeRender")},function(){return e._option("beforeRender")},this._beforeRender,this._serializeData,function(t){
return e._renderTemplate(t,n)},this._renderComponents,this._afterRender,function(){return e._option("afterRender")},function(){return e.trigger("afterRender")},this)}},{key:"_setRegion",value:function(e){this._region=e,this._bindEvents()}},{key:"_close",value:function(){var e=this;return this._region?this.chain(function(){return e.trigger("beforeClose")},function(){return e._option("beforeClose")},this._beforeClose,[this._unbindEvents,this._destroyComponents,function(){return e._region._empty(e)}],this._afterClose,function(){
return e._option("afterClose")},function(){return e.trigger("afterClose")},function(){return delete e._region},this):this.Promise.resolve(this)}},{key:"_serializeData",value:function(){return{Global:this.app.global,Self:this}}},{key:"_renderTemplate",value:function(e,t){this._templateEngine._execute(this,e,this._template,t)}},{key:"_initializeEvents",value:function(e){var t=this;p(e||this._option("events"),function(e,n){var r=n.replace(/(^\s+)|(\s+$)/g,"").split(/\s+/),i={key:n};2!==r.length&&t._error("Invalid event key"),
i.eventType=r[0],"*"===r[1].slice(-1)?(i.id=t._wrapDomId(r[1].slice(0,-1)),i.haveStar=!0,i.selector="[id^="+i.id+"]"):(i.id=t._wrapDomId(r[1]),i.selector="#"+i.id),i.handler=t._createEventHandler(e,i),t._events[n]=i})}},{key:"_getEventTarget",value:function(e,t){for(var n=this._element,r=e;r!==n;){var i=r.getAttribute("id");if(i&&i.slice(0,t.length)===t)return r;r=r.parentNode}}},{key:"_createEventHandler",value:function(e,t){var n=this,r=t.haveStar,i=t.id,o=this.app.options.disabledClass;return function(t){
n._eventHandlers[e]||n._error("No event handler for name:",e);var a=n._getEventTarget(t.target,i),s=[t];l.Adapter.hasClass(a,o)||(r&&s.unshift(a.getAttribute("id").slice(i.length)),n._eventHandlers[e].apply(n,s))}}},{key:"_bindEvents",value:function(){var e=this;p(this._events,function(t){e._region._delegateDomEvent(e,t.eventType,t.selector,t.handler)})}},{key:"_unbindEvents",value:function(){this._region._undelegateDomEvents(this)}},{key:"_renderComponents",value:function(){var e=this;return this.chain(h(this._option("components"),function(t){
var n=l.isFunction(t)?t.call(e):t;return n?l.ComponentManager._create(e,n):null}),function(t){return h(t,function(t){if(t){var n=t.id,r=t.component,i=t.index,o=e.components[n];l.isArray(o)?o.push(r):e.components[n]=o?[o,r]:r,e._componentMap[i]=t}})})}},{key:"_destroyComponents",value:function(){var e=this;this.components={},p(this._componentMap,function(t){return l.ComponentManager._destroy(e,t)}),this._componentMap={}}},{key:"_wrapDomId",value:function(e){return this.id+e}},{key:"_beforeRender",
value:function(){}},{key:"_afterRender",value:function(){}},{key:"_beforeClose",value:function(){}},{key:"_afterClose",value:function(){}},{key:"_element",get:function(){return this._region?this._region._getElement(this):null}}]),i}(l.Base),l.RenderableContainer=function(n){function o(){return r(this,o),e(this,Object.getPrototypeOf(o).apply(this,arguments))}return t(o,n),a(o,[{key:"_initialize",value:function(){var e=i(Object.getPrototypeOf(o.prototype),"_initialize",this).call(this);return this._items={},
this.chain(e,this._initializeItems)}},{key:"_afterRender",value:function(){return this.chain(this._initializeRegions,this._renderItems)}},{key:"_afterClose",value:function(){return this._closeRegions()}},{key:"_initializeItems",value:function(){var e=this;this.chain(p(this._option("items"),function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=arguments[1],r=l.isFunction(t)?t.call(e):t;return l.isString(r)&&(r={region:r}),e.app[t.isModule?"_createModule":"_createView"](n,e).then(function(t){
var i=t;return i.moduleOptions=r,e._items[n]=t,t})}))}},{key:"_initializeRegions",value:function(){var e=this;return this._regions={},this.chain(this.closeRegions,h(this.$$("[data-region]"),function(t){var n=e._createRegion(t);e._regions[n.name]=n}))}},{key:"_renderItems",value:function(){var e=this;return this.chain(p(this.items,function(t){var n=t.moduleOptions.region;n&&(e.regions[n]||e._error("Region: "+n+" is not defined"),e.regions[n].show(t))}),this)}},{key:"_createRegion",value:function(e){
var t=e.getAttribute("data-region");return this.app._createRegion(e,t,this)}},{key:"_closeRegions",value:function(){var e=this._regions;return e?(delete this._regions,this.chain(p(e,function(e){return e.close()}),this)):this}},{key:"items",get:function(){return this._items||{}}},{key:"regions",get:function(){return this._regions||{}}}]),o}(l.Renderable),l.ActionCreator=function(n){function o(){return r(this,o),e(this,Object.getPrototypeOf(o).apply(this,arguments))}return t(o,n),a(o,[{key:"_initializeEvents",
value:function(){i(Object.getPrototypeOf(o.prototype),"_initializeEvents",this).call(this),i(Object.getPrototypeOf(o.prototype),"_initializeEvents",this).call(this,this._option("actions"))}},{key:"_createEventHandler",value:function(e,t){var n=!!(this._option("actions")||{})[t.key];return n?this._createAction(e,t):i(Object.getPrototypeOf(o.prototype),"_createEventHandler",this).call(this,e,t)}},{key:"_createAction",value:function(e,t){var n=this,r=t.id,i=this.app.options.disabledClass,o=this._option("dataForActions")||{},a=o[e],s=this._option("actionCallbacks")||{},u=s[e];
return function(t){var o=n._getEventTarget(t.target,r);if(!l.Adapter.hasClass(o,i)){l.Adapter.addClass(o,i);var s=n._getActionPayload(o);n.chain(l.isFunction(a)?a.call(n,s,t):s,function(t){return t!==!1?n.module.dispatch(e,t):!1},function(e){return e!==!1?u&&u.call(n,e):!1}).then(function(){return l.Adapter.removeClass(o,i)},function(){return l.Adapter.removeClass(o,i)})}}}},{key:"_getActionPayload",value:function(e){for(var t=this._element,n=e,r=!1;n&&n!==t&&"FORM"!==n.tagName;)n=n.parentNode;n||(n=t);
var i="FORM"===n.tagName?l.Adapter.getFormData(n):{};return h(n.querySelectorAll("[data-name][data-value]"),function(t){if(t===e)return r=e.getAttribute("data-name"),void(i[r]=e.getAttribute("data-value"));var n=t.getAttribute("data-name");if(!r||r!==n){var o=t.getAttribute("data-value"),a=i[n];l.isArray(a)?a.push(o):i[n]=null==a?o:[a,o]}}),i}}]),o}(l.Renderable),l.View=function(n){function o(){return r(this,o),e(this,Object.getPrototypeOf(o).apply(this,arguments))}return t(o,n),a(o,[{key:"_initialize",
value:function(){return this.bindings={},this.chain(i(Object.getPrototypeOf(o.prototype),"_initialize",this).call(this),this._initializeDataBinding)}},{key:"_initializeDataBinding",value:function(){var e=this;this._dataBinding={},p(this._option("bindings"),function(t,n){var r=e.bindings[n]=e.module.store.models[n];r||e._error("No model:",n),t&&(e._dataBinding[n]={model:r,value:t,fn:function(){t===!0&&e._region&&e.render(e.renderOptions),l.isString(t)&&e._option(t)}})})}},{key:"_bindData",value:function(){
var e=this;p(this._dataBinding,function(t){return e.listenTo(t.model,"changed",t.fn)})}},{key:"_unbindData",value:function(){this.stopListening(),this.bindings={}}},{key:"_setRegion",value:function(){for(var e,t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];(e=i(Object.getPrototypeOf(o.prototype),"_setRegion",this)).call.apply(e,[this].concat(n)),this._bindData()}},{key:"_close",value:function(){for(var e,t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];this.chain((e=i(Object.getPrototypeOf(o.prototype),"_close",this)).call.apply(e,[this].concat(n)),this._unbindData,this);
}},{key:"_serializeData",value:function(){var e=this,t=i(Object.getPrototypeOf(o.prototype),"_serializeData",this).call(this);return p(this.bindings,function(e,n){return t[n]=e.get(!0)}),p(this._option("dataForTemplate"),function(n,r){return t[r]=n.call(e,t)}),t}}]),o}(l.ActionCreator),l.Module=function(n){function o(){return r(this,o),e(this,Object.getPrototypeOf(o).apply(this,arguments))}return t(o,n),a(o,[{key:"_initialize",value:function(){return this.app._modules[this.name+"--"+this.id]=this,
this._initializeStore(),i(Object.getPrototypeOf(o.prototype),"_initialize",this).call(this)}},{key:"dispatch",value:function(e,t){return this._store.dispatch(e,t)}},{key:"_initializeStore",value:function(){this._store=this.app._createStore(this,this._option("store"))}},{key:"_afterClose",value:function(){return delete this.app._modules[this.name+"--"+this.id],this._store._destory(),i(Object.getPrototypeOf(o.prototype),"_afterClose",this).call(this)}},{key:"_beforeRender",value:function(){var e=this;
return this.chain(i(Object.getPrototypeOf(o.prototype),"_beforeRender",this).call(this),function(){return e._store._loadEagerModels()})}},{key:"_afterRender",value:function(){var e=this;return this.chain(i(Object.getPrototypeOf(o.prototype),"_afterRender",this).call(this),function(){return e._store._loadLazyModels()})}},{key:"store",get:function(){return this._store}}]),o}(l.RenderableContainer);var m=["blur","focus","scroll","resize"];l.Region=function(n){function i(t,n,o,a){r(this,i);var s=e(this,Object.getPrototypeOf(i).call(this,a||"Region",{},{
app:t,module:n,_el:o,_delegated:{}}));return s._el||s._error("The DOM element for region is required"),t.delegateEvent(s),s}return t(i,n),a(i,[{key:"show",value:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return this._isCurrent(e)?n.forceRender===!1?this.Promise.resolve(this._current):this._current._render(n,!0):this.chain(l.isString(e)?this.app._createModule(e):e,function(e){return e instanceof l.Renderable||t._error("The item is expected to be an instance of Renderable"),
e},[function(e){return t.chain(e._region&&e._region.close(),e)},function(){return t._current&&t.close()}],function(e){var n=o(e,1),r=n[0];t._current=r;var i=r.module?r.module.name+":"+r.name:r.name;return t._getElement().setAttribute("data-current",i),r._setRegion(t),r},function(e){return e._render(n,!1)})}},{key:"close",value:function(){var e=this;return this.chain(this._current&&this._current._close(),function(){return delete e._current},this)}},{key:"$$",value:function(e){return this._getElement().querySelectorAll(e);
}},{key:"_isCurrent",value:function(e){return this._current?this._current.name===e?!0:e&&e.id===this._current.id?!0:!1:!1}},{key:"_getElement",value:function(){return this._el}},{key:"_empty",value:function(){this._getElement().innerHTML=""}},{key:"_createDelegateListener",value:function(e){var t=this;return function(n){if(t._delegated[e]){var r=n.target;h(t._delegated[e].items,function(e){for(var i=t._getElement().querySelectorAll(e.selector),o=!1,a=0;a<i.length;a++){var s=i[a];if(s===r||s.contains(r)){
o=s;break}}o&&e.fn.call(e.renderable,n)})}}}},{key:"_delegateDomEvent",value:function(e,t,n,r){var i=this._delegated[t];i||(i=this._delegated[t]={listener:this._createDelegateListener(t),items:[]},l.Adapter.addEventListener(this._getElement(),t,i.listener,-1!==m.indexOf(t))),i.items.push({selector:n,fn:r,renderable:e})}},{key:"_undelegateDomEvents",value:function(e){var t=this;p(this._delegated,function(n,r){var i=[],o=n;h(o.items,function(t){t.renderable!==e&&i.push(t)}),o.items=i,0===i.length&&(delete t._delegated[r],
l.Adapter.removeEventListener(t._getElement(),r,o.listener))})}}]),i}(l.Base),l.TemplateEngine=function(n){function i(t){return r(this,i),e(this,Object.getPrototypeOf(i).call(this,"Template Engine",t,{_templateCache:{}}))}return t(i,n),a(i,[{key:"executeIdReplacement",value:function(e,t){var n=this,r={};h(e.querySelectorAll("[id]"),function(e){var i=e.getAttribute("id");r[i]&&n._error("Dom ID: "+i+" is already used"),r[i]=!0,e.setAttribute("id",t._wrapDomId(i))});var i=this._option("attributesReferToId")||["for","data-target","data-parent"];
h(i,function(n){return h(e.querySelectorAll("["+n+"]"),function(e){var r=e.getAttribute(n),i="#"===r.charAt(0),o=i?"#"+t._wrapDomId(r.slice(1)):t._wrapDomId(r);e.setAttribute(n,o)})})}},{key:"_load",value:function(e){var t=e.id;return this._templateCache[t]?this._templateCache[t]:this._templateCache[t]=this._loadIt(e)}},{key:"_loadIt",value:function(e){return e instanceof u.Module?e._loader.loadModuleResource(e,"templates"):function(){return e.module._template}}},{key:"_execute",value:function(e,t,n){
var r=e._element;r.innerHTML=n(t),this.executeIdReplacement(r,e)}}]),i}(l.Base),l.Store=function(n){function i(t,n){r(this,i);var o=e(this,Object.getPrototypeOf(i).call(this,"Store",n,{app:t.app,module:t,_models:{}}));return o.app.delegateEvent(o),o._callbacks=o._option("callbacks"),p(o._callbacks,function(e,t){"app."===t.slice(0,4)&&o.listenTo(o.app,t,function(t){return e.call(o._callbackContext,t)})}),o}return t(i,n),a(i,[{key:"dispatch",value:function(e,t){var n=void 0,r=e,i=t;return l.isObject(r)&&(i=r.payload,
r=r.name),n=this._callbacks[r],n||this._error("No action callback for name: "+e),this.chain(n.call(this._callbackContext,i))}},{key:"_initialize",value:function(){this._initializeModels(),this._callbackContext=f({models:this.models,module:this.module,app:this.app},l.Request)}},{key:"_initializeModels",value:function(){var e=this;p(this._option("models"),function(t,n){var r=(l.isFunction(t)?t.call(e):t)||{};return r.shared===!0?e.app.viewport?void(e._models[n]=e.app.viewport.store.models[n]):(e.module.name===e.app._option("viewport")&&e._error("Can not define shared model in viewport"),
void(e.module.module&&e.module.module.name===e.app._option("viewport")&&(e._models[n]=e.module.module.store.models[n]))):void(e._models[n]=e.app._createModel(e,r))})}},{key:"_loadEagerModels",value:function(){var e=this;return this.chain(p(this._models,function(t){return t.store!==e?null:t.options.autoLoad===!0?l.Request.get(t):null}))}},{key:"_loadLazyModels",value:function(){var e=this;return this.chain(p(this._models,function(t){if(t.store!==e)return null;var n=t.options.autoLoad;return n&&n!==!0?l.Request.get(t):null;
}))}},{key:"_destory",value:function(){this.stopListening()}},{key:"models",get:function(){return this._models}}]),i}(l.Base),l.Model=function(n){function i(t,n){r(this,i);var o=e(this,Object.getPrototypeOf(i).call(this,"Model",n,{app:t.module.app,module:t.module,store:t}));return o._data=o._option("data")||{},o._idKey=o._option("idKey")||o.app.options.idKey,o._params=f({},o._option("params")),o.app.delegateEvent(o),o}return t(i,n),a(i,[{key:"set",value:function(e,t){var n=this.options.parse?this._option("parse",e):e;
this._data=this.options.root?n[this.options.root]:n,t&&this.changed()}},{key:"get",value:function(e){return e?d(this._data):this._data}},{key:"clear",value:function(e){this._data=l.isArray(this._data)?[]:{},e&&this.changed()}},{key:"changed",value:function(){this.trigger("changed")}},{key:"_url",value:function(){return this._option("url")||""}},{key:"fullUrl",get:function(){return l.Request._url(this)}},{key:"params",get:function(){return this._params}},{key:"data",get:function(){return this._data;
}}]),i}(l.Base),l.Loader=function(n){function i(t,n){return r(this,i),e(this,Object.getPrototypeOf(i).call(this,"Loader",n,{app:t}))}return t(i,n),a(i,null,[{key:"_analyse",value:function(e){if(!l.isString(e))return{loader:null,name:e};var t=e.split(":"),n=t.length>1?t.shift():null;return{loader:n,name:t.shift(),args:t}}}]),a(i,[{key:"loadResource",value:function(e){var t=this,n=this.app.options,r=n.scriptRoot,i=n.getResource,o=n.amd,a=r+"/"+e;return this.Promise.create(function(e,n){o?require([a],e,n):e(i?i.call(t.app,a):require("./"+a));
})}},{key:"loadModuleResource",value:function(e,t){return this.loadResource(e.name+"/"+t)}},{key:"loadModule",value:function(e){return this.loadResource(e+"/index")}},{key:"loadView",value:function(e,t){return this.loadModuleResource(t,"view-"+e)}},{key:"loadRouter",value:function(e){var t="router";return this.loadResource(e?e+"/"+t:t)}}]),i}(l.Base),l.Application=function(i){function o(t){return r(this,o),e(this,Object.getPrototypeOf(o).call(this,t&&t.name||"Application",f({scriptRoot:"app",urlRoot:"",
urlSuffix:"",caseSensitiveHash:!1,container:g&&g.document.body,disabledClass:"disabled",getResource:null,idKey:"id",viewport:"viewport"},t),{global:{},_modules:{},_loaders:{}}))}return t(o,i),a(o,[{key:"_initialize",value:function(){this._templateEngine=this._option("templateEngine")||new l.TemplateEngine,this.registerLoader("default",new l.Loader(this),!0),this._region=this._createRegion(this._option("container"),"Region")}},{key:"registerLoader",value:function(e,t,n){return this._loaders[e]=t,n&&(this._defaultLoader=t),
this}},{key:"start",value:function(e){var t,r=this;return e&&(this._router=new l.Router(this)),this.chain(e?(t=this._router)._mountRoutes.apply(t,n(this._option("routers"))):!1,this._region.show(this._option("viewport")),function(e){return r.viewport=e},function(){return e&&r._router._start(e)},this)}},{key:"stop",value:function(){this.off(),this._region.close(),this._router&&this._router._stop()}},{key:"navigate",value:function(e,t){this._router&&this._router.navigate(e,t)}},{key:"dispatch",value:function(e,t){
var n=l.isObject(e)?e.name:e,r=l.isObject(e)?e.payload:t;this.trigger("app."+n,r)}},{key:"show",value:function(e,t,n){return this.viewport.regions[e].show(t,n)}},{key:"_getLoader",value:function(e,t){return e&&this._loaders[e]||t&&t._loader||this._defaultLoader}},{key:"_createModule",value:function(e,t){var n=this,r=l.Loader._analyse(e),i=r.name,o=r.loader,a=this._getLoader(o,parent);return this.chain(a.loadModule(i),function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return _.createModule(e.type,i,n,t,a,e);
})}},{key:"_createView",value:function(e,t){var n=this,r=l.Loader._analyse(e),i=r.name,o=r.loader,a=this._getLoader(o,t);return this.chain(a.loadView(i,t),function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return _.createView(e.type,i,n,t,a,e)})}},{key:"_createRegion",value:function(e,t,n){var r=l.Loader._analyse(t),i=r.name,o=r.loader;return _.createRegion(o,this,n,e,i)}},{key:"_createStore",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];
return _.createStore(t.type,e,t)}},{key:"_createModel",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return _.createModel(t.type,e,t)}}]),o}(l.Base),f(l.Application.prototype,l.Event);var y=g&&g.history&&"pushState"in g.history,k=[/:([\w\d]+)/g,"([^/]+)",/\*([\w\d]+)/g,"(.*)"],b=function(){function e(t,n,i,o){r(this,e);var a=i.replace(k[0],k[1]).replace(k[2],k[3]);this.pattern=new RegExp("^"+a+"$",t.options.caseSensitiveHash?"g":"gi"),this.app=t,this.router=n,
this.path=i,this.fn=o}return a(e,[{key:"match",value:function(e){return this.pattern.lastIndex=0,this.pattern.test(e)}},{key:"handle",value:function(e){var t,r=this;this.pattern.lastIndex=0;var i=this.pattern.exec(e).slice(1),o=this.router._getInterceptors(this.path);return o.push(this.fn),(t=this.router).chain.apply(t,n(h(o,function(e,t){return function(n){return e.apply(r.router,t>0?[n].concat(i):i)}})))}}]),e}();l.Router=function(n){function i(t){r(this,i);var n=e(this,Object.getPrototypeOf(i).call(this,"Router",{},{
app:t,_routes:[],_interceptors:{},_started:!1}));return n._EVENT_HANDLER=function(){return n._dispath(n._getHash())},n}return t(i,n),a(i,[{key:"navigate",value:function(e,t){this._started&&(y?g.history.pushState({},g.document.title,"#"+e):g.location.replace("#"+e),t!==!1&&this._dispath(e))}},{key:"_start",value:function(e){if(!this._started&&g){l.Adapter.addEventListener(g,"hashchange",this._EVENT_HANDLER,!1);var t=this._getHash()||e;this._started=!0,t&&this.navigate(t)}}},{key:"_stop",value:function(){
this._started&&(l.Adapter.removeEventListener(g,"hashchange",this._EVENT_HANDLER),this._started=!1)}},{key:"_dispath",value:function(e){if(e!==this._previousHash){this._previousHash=e;for(var t=0;t<this._routes.length;t++){var n=this._routes[t];if(n.match(e))return void n.handle(e)}}}},{key:"_mountRoutes",value:function(){var e=this,t=c.call(arguments);return this.chain(h(t,function(t){return e.app._getLoader(t).loadRouter(t)}),function(n){return h(n,function(n,r){return e._addRoute(t[r],n)})})}},{
key:"_addRoute",value:function(e,t){var n=this,r=t.routes,i=t.interceptors;p(l.isFunction(r)?r.apply(this):r,function(r,i){var o=(e+"/"+i).replace(/^\/|\/$/g,"");n._routes.unshift(new b(n.app,n,o,t[r]))}),p(l.isFunction(i)?i.apply(this):i,function(r,i){var o=(e+"/"+i).replace(/^\/|\/$/g,"");n._interceptors[o]=t[r]})}},{key:"_getInterceptors",value:function(e){var t=[],n=e.split("/");for(n.pop();n.length>0;){var r=n.join("/");this._interceptors[r]&&t.unshift(this._interceptors[r]),n.pop()}return this._interceptors[""]&&t.unshift(this._interceptors[""]),
t}},{key:"_getHash",value:function(){return g.location.hash.slice(1)}}]),i}(l.Base);var R={pageSize:10,pageKey:"_page",pageSizeKey:"pageSize",recordCountKey:"recordCount",params:function(e){return e}};return l.PageableModel=function(n){function o(t,n){r(this,o);var i=e(this,Object.getPrototypeOf(o).call(this,t,n));return i._data=i._option("data")||[],i._p={page:i._option("page")||1,pageCount:0,pageSize:i._option("pageSize")||R.pageSize,pageKey:i._option("pageKey")||R.pageKey,pageSizeKey:i._option("pageSizeKey")||R.pageSizeKey,
recordCountKey:i._option("recordCountKey")||R.recordCountKey},i}return t(o,n),a(o,null,[{key:"setDefault",value:function(e){f(R,e)}}]),a(o,[{key:"set",value:function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],t=arguments[1];this._p.recordCount=e[this._p.recordCountKey]||0,this._p.pageCount=Math.ceil(this._p.recordCount/this._p.pageSize),i(Object.getPrototypeOf(o.prototype),"set",this).call(this,e,t)}},{key:"clear",value:function(e){this._p.page=1,this._p.recordCount=0,this._p.pageCount=0,
i(Object.getPrototypeOf(o.prototype),"clear",this).call(this,e)}},{key:"turnToPage",value:function(e){return e<=this._p.pageCount&&e>=1&&(this._p.page=e),this}},{key:"firstPage",value:function(){return this.turnToPage(1)}},{key:"lastPage",value:function(){return this.turnToPage(this._p.pageCount)}},{key:"nextPage",value:function(){return this.turnToPage(this._p.page+1)}},{key:"prevPage",value:function(){return this.turnToPage(this._p.page-1)}},{key:"params",get:function(){var e=this._p,t=e.page,n=e.pageKey,r=e.pageSizeKey,a=e.pageSize,s=i(Object.getPrototypeOf(o.prototype),"params",this);
return s[n]=t,s[r]=a,R.params(s)}},{key:"pageInfo",get:function(){var e=this._p,t=e.page,n=e.pageSize,r=e.recordCount,i=void 0;return i=this.data&&this.data.length>0?{page:t,start:(t-1)*n+1,end:t*n,total:r}:{page:t,start:0,end:0,total:0},i.end>i.total&&(i.end=i.total),i}}]),o}(l.Model),l.registerModel("pageable",l.PageableModel),l.MultiRegion=function(n){function s(){return r(this,s),e(this,Object.getPrototypeOf(s).apply(this,arguments))}return t(s,n),a(s,[{key:"_initialize",value:function(){this._items={},
this._elements={}}},{key:"activate",value:function(){}},{key:"show",value:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=e.moduleOptions,i=l.isString(e),a=n.key;i||e instanceof l.Renderable||this._error("The item is expected to be an instance of Renderable"),!a&&r&&r.key&&(a=r.key),a||this._error("Region key is required");var s=this._items[a];return this._isCurrent(a,s,e)?n.forceRender===!1?this.Promise.resolve(s):s.render(n):this.chain(i?this.app._createModule(e):e,[function(e){
return t.chain(e._region&&e._region.close(),e)},function(){return t.chain(s&&s._close(),function(){delete t._items[a],delete t._elements[a]})}],function(e){var r=o(e,1),i=r[0],s=i.module?i.module.name+":"+i.name:i.name,u=t._getElement(i,a);return t._items[a]=i,u.setAttribute("data-current",s),i._setRegion(t),i._render(n,!1)})}},{key:"_createElement",value:function(){var e=g.document.createElement("div");return this._el.appendChild(e),e}},{key:"_getElement",value:function(e,t){if(!e)return this._el;
var n=t||e.renderOptions.key||e.moduleOptions.key;return this._elements[n]||(this._elements[n]=this._createElement(n,e)),this._elements[n]}},{key:"_isCurrent",value:function(e,t,n){return t?t.name===n||n&&n.id===t.id:!1}},{key:"_empty",value:function(e){if(!e)return void i(Object.getPrototypeOf(s.prototype),"_empty",this).call(this);var t=this._getElement(e);t.parentNode.removeChild(t)}},{key:"close",value:function(){var e=this;return this.chain(p(this._items,function(e){return e._close()}),function(){
e._elements={},e._items={},delete e._current},this)}}]),s}(l.Region),u});
//# sourceMappingURL=drizzle.min.js.map
