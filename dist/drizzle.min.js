!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.Drizzle=t()}(this,function(){"use strict";function e(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function t(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function n(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var r=function O(e,t,n){null===e&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,t);if(void 0===i){var r=Object.getPrototypeOf(e);return null===r?void 0:O(r,t,n)}if("value"in i)return i.value;var o=i.get;if(void 0!==o)return o.call(n)},o=function(){function e(e,t){var n=[],i=!0,r=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);i=!0);}catch(u){r=!0,o=u}finally{try{!i&&s["return"]&&s["return"]()}finally{if(r)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},u={},l=u,c=[].slice,h=function(){},f=function(e,t){var n=[];if(!e)return n;if(e.map)return e.map(t);for(var i=0;i<e.length;i++)n.push(t(e[i],i,e));return n},d=function(e,t){var n=[],i=void 0;if(!e)return n;for(i in e)l.hasOwnProperty.call(e,i)&&n.push(t(e[i],i,e));return n},p=function R(e){if(l.isObject(e)){var t=function(){var t={};return d(e,function(e,n){t[n]=R(e)}),{v:t}}();if("object"===("undefined"==typeof t?"undefined":s(t)))return t.v}return l.isArray(e)?f(e,function(e){return R(e)}):e},_={View:{},Region:{},Module:{},Model:{},Store:{},register:function(e,t,n){this[e][t]=n},create:function(e,t){for(var n=this[e][t]||l[e],i=arguments.length,r=Array(i>2?i-2:0),o=2;i>o;o++)r[o-2]=arguments[o];return new(Function.prototype.bind.apply(n,[null].concat(r)))}},v=0,g=null;"undefined"!=typeof window&&(g=window),f(["Function","Array","String","Object"],function(e){l["is"+e]=function(t){return l.toString.call(t)==="[object "+e+"]"}}),f(["Module","View","Region","Model","Store"],function(e){l["register"+e]=function(t,n){return _.register(e,t,n)},_["create"+e]=function(t){for(var n=arguments.length,i=Array(n>1?n-1:0),r=1;n>r;r++)i[r-1]=arguments[r];return _.create.apply(_,[e,t].concat(i))}}),Object.assign(l,{uniqueId:function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];return""+e+ ++v},adapt:function(e){Object.assign(l.Adapter,e)}}),l.Adapter={Promise:Promise,ajax:function(e){var t=new XMLHttpRequest;t.open(e.type,e.url,!0);var n=new Promise(function(e,n){t.onload=function(){return this.status>=200&&this.status<4e3?void e(JSON.parse(this.response)):void n(t)},t.onerror=function(){n(t)}});return t.send(e.data),n},ajaxResult:function(e){return e[0]},getEventTarget:function(e){return e.target},getFormData:function(e){throw new Error("getFormData is not implemented",e)},addEventListener:function(e,t,n,i){e.addEventListener(t,n,i)},removeEventListener:function(e,t,n){e.removeEventListener(e,t,n)},hasClass:function(e,t){return e.classList.contains(t)},addClass:function(e,t){e.classList.add(t)},removeClass:function(e,t){e.classList.remove(t)}},l.Promise=function(){function e(t){i(this,e),this.context=t}return a(e,[{key:"create",value:function(e){var t=this;return new l.Adapter.Promise(function(n,i){e.call(t.context,n,i)})}},{key:"resolve",value:function(e){return l.Adapter.Promise.resolve(e)}},{key:"reject",value:function(e){return l.Adapter.Promise.reject(e)}},{key:"parallel",value:function(e){for(var t=this,n=arguments.length,i=Array(n>1?n-1:0),r=1;n>r;r++)i[r-1]=arguments[r];return this.create(function(n,r){var o=[],a=[],s={};return f(e,function(e,n){var r=l.isFunction(e)?e.apply(t.context,i):e;r&&r.then?(s[a.length]=n,a.push(r)):o[n]=r}),0===a.length?n(o):void l.Adapter.Promise.all(a).then(function(e){d(s,function(t,n){return o[n]=e[t]}),n(o)},function(e){r(e)})})}},{key:"chain",value:function(){for(var e=this,t=arguments.length,i=Array(t),r=0;t>r;r++)i[r]=arguments[r];var o=null,a=function s(t,i,r,a){var u=function(e){o=e,0===t.length?r(o):s(t,t.shift(),r,a)};if(l.isArray(i))0===i.length?u([]):e.parallel.apply(e,[i].concat(n(null!=o?[o]:[]))).then(u,a);else{var c=l.isFunction(i)?i.apply(e.context,null!=o?[o]:[]):i;c&&c.then?c.then(u,a):u(c)}};return 0===i.length?this.resolve():this.create(function(e,t){a(i,i.shift(),e,t)})}}]),e}(),l.Event={on:function(e,t,n){this._events||(this._events={}),(this._events[e]||(this._events[e]=[])).push({fn:t,ctx:n})},off:function(e,t){if(this._events&&e&&this._events[e]){if(!t)return void delete this._events[e];var n=[];return f(this._events[e],function(e){e.fn!==t&&n.push(e)}),0===n.length?void delete this._events[e]:void(this._events[e]=n)}},trigger:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;t>i;i++)n[i-1]=arguments[i];return e&&this._events&&this._events[e]?void f(this._events[e],function(e){return e.fn.apply(e.ctx,n)}):this},delegateEvent:function(e){var t=this,n="--"+e.id,i=e;return Object.assign(i,{_listeners:{},listenTo:function(e,t,n){(i._listeners[t]||(i._listeners[t]=[])).push({fn:n,obj:e}),e.on(t,n,i)},stopListening:function(e,n,r){if(!e)return d(i._listeners,function(e,t){return f(e,function(e){return e.obj.off(t,e.fn)})}),void(i._listeners={});if(!n)return d(i._listeners,function(e,n){return f(e,function(e){return t.off(n,e)})}),void(i._listeners={});var o=[];f(i._listeners[n],function(e){return r&&r!==e?o.push(e):t.off(n,e)}),i._listeners[n]=o,0===o.length&&delete i._listeners[n]},on:function(e,r){i.listenTo(t,e+n,r)},off:function(e,r){i.stopListening(t,e&&e+n,r)},trigger:function(e){if(!e)return i;for(var r=arguments.length,o=Array(r>1?r-1:0),a=1;r>a;a++)o[a-1]=arguments[a];o.unshift(e+n)&&t.trigger.apply(t,o)}}),this}},l.Request={get:function(e,t){return this._ajax("GET",e,e.params,t)},post:function(e,t){return this._ajax("POST",e,e.data,t)},put:function(e,t){return this._ajax("PUT",e,e.data,t)},del:function(e,t){return this._ajax("DELETE",e,e.data,t)},save:function(e,t){return e.data&&e.data[e._idKey]?this.put(e,t):this.post(e,t)},_url:function(e){var t=[],n=e.module._option("urlPrefix",e)||"",i=e.app._option("urlRoot",e)||"",r=e.app._option("urlSuffix",e)||"",o=e._url()||"";for(i&&t.push(i),n&&t.push(n),t.push(e.module.name);0===o.indexOf("../");)t.pop(),o=o.slice(3);return o&&t.push(o),e.data&&e.data[e._idKey]&&t.push(e.data[e._idKey]),r&&t.push(r),t.join("/")},_ajax:function(e,t,n,i){var r=Object.assign({type:e},i);return r.data=Object.assign({},n,r.data),r.url=this._url(t),t.Promise.create(function(e,n){l.Adapter.ajax(r).then(function(){for(var n=arguments.length,i=Array(n),o=0;n>o;o++)i[o]=arguments[o];t.set(l.Adapter.ajaxResult(i),!r.slient),e(i)},function(){for(var e=arguments.length,t=Array(e),i=0;e>i;i++)t[i]=arguments[i];return n(t)})})}},l.ComponentManager={_handlers:{},_componentCache:{},setDefaultHandler:function(e){var t=arguments.length<=1||void 0===arguments[1]?h:arguments[1];this._defaultHandler={creator:e,destructor:t}},register:function(e,t,n){this.handlers[e]={creator:t,destructor:n||h}},_create:function(e,t){var n=this,i=t.name,r=t.id,o=t.selector,a=t.options;i||e._error("Component name can not be null");var s=this._handlers[i]||this._defaultHandler;s||e._error("No handler for component:",i);var u=o?e.$$(o):e.$(r),c=r?r:l.uniqueId("comp");return e.chain(s.creator(e,u,a),function(t){var i=e.id+c,o=n._componentCache[i],u={id:i,handler:s,index:l.uniqueId(i),options:a};return l.isArray(o)?o.push(u):n._componentCache[i]=o?[o,u]:u,{id:r,component:t,index:u.index}})},_destroy:function(e,t){var n=this,i=e.id+t.id,r=this._componentCache[i],o=r;l.isArray(r)?(this._componentCache[i]=[],f(r,function(e){e.index!==t.index?n._componentCache[i].push(e):o=e}),0===this._componentCache[i].length&&delete this._componentCache[i]):delete this._componentCache[i],o.handler.destructor(e,t.component,o.options)}},l.Base=function(){function e(t){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=arguments[2];i(this,e),this.options=n,this.id=l.uniqueId("D"),this.name=t,this.Promise=new l.Promise(this),Object.assign(this,r),n.mixin&&this._mixin(n.mixin),this._loadedPromise=this._initialize()}return a(e,[{key:"_initialize",value:function(){}},{key:"_option",value:function(e){for(var t=this.options[e],n=arguments.length,i=Array(n>1?n-1:0),r=1;n>r;r++)i[r-1]=arguments[r];return l.isFunction(t)?t.apply(this,i):t}},{key:"_error",value:function(e){if(!l.isString(e))throw e;for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;t>i;i++)n[i-1]=arguments[i];throw new Error("["+(this.module?this.module.name+":":"")+this.name+"] "+e+" "+n.join(" "))}},{key:"_mixin",value:function(e){var t=this,n=arguments;d(e,function(e,i){var r=t[i];return r?void(l.isFunction(r)&&(t[i]=function(){var i=c.call(n);return i.unshift(r),e.apply(t,i)})):void(t[i]=e)})}},{key:"chain",value:function(){var e;return(e=this.Promise).chain.apply(e,arguments)}}]),e}(),l.Renderable=function(n){function r(t,n,o,a,s){i(this,r);var u=e(this,Object.getPrototypeOf(r).call(this,t,s,{app:n,module:o,components:{},_loader:a,_componentMap:{},_events:{}}));return u._eventHandlers=u._option("handlers"),n.delegateEvent(u),u}return t(r,n),a(r,[{key:"_initialize",value:function(){var e=this;return this._templateEngine=this._option("templateEngine")||this.module&&this.module._templateEngine||this.app._templateEngine,this.chain([this._templateEngine._load(this),this._initializeEvents()],function(t){var n=o(t,1),i=n[0];return e._template=i})}},{key:"render",value:function(e){return this._render(e,!0)}},{key:"$",value:function(e){return this.$$("#"+this._wrapDomId(e))[0]}},{key:"$$",value:function(e){return this._element.querySelectorAll(e)}},{key:"_render",value:function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=arguments[1];return this._region||this._error("Region is null"),this.renderOptions=t,this.chain(this._loadedPromise,this._destroyComponents,function(){return e.trigger("beforeRender")},function(){return e._option("beforeRender")},this._beforeRender,this._serializeData,function(t){return e._renderTemplate(t,n)},this._renderComponents,this._afterRender,function(){return e._option("afterRender")},function(){return e.trigger("afterRender")},this)}},{key:"_setRegion",value:function(e){this._region=e,this._bindEvents()}},{key:"_close",value:function(){var e=this;return this._region?this.chain(function(){return e.trigger("beforeClose")},function(){return e._option("beforeClose")},this._beforeClose,[this._unbindEvents,this.destroyComponents,function(){return e._region._empty(e)}],this._afterClose,function(){return e._option("afterClose")},function(){return e.trigger("afterClose")},function(){return delete e._region},this):this.Promise.resolve(this)}},{key:"_serializeData",value:function(){return{Global:this.app.global,Self:this}}},{key:"_renderTemplate",value:function(e,t){this._templateEngine._execute(this,e,this._template,t)}},{key:"_initializeEvents",value:function(e){var t=this;d(e||this._option("events"),function(e,n){var i=n.replace(/(^\s+)|(\s+$)/g,"").split(/\s+/),r={key:n};2!==i.length&&t._error("Invalid event key"),r.eventType=i[0],"*"===i[1].slice(-1)?(r.id=t._wrapDomId(i[1].slice(0,-1)),r.haveStar=!0,r.selector="[id^="+r.id+"]"):(r.id=t._wrapDomId(i[1]),r.selector="#"+r.id),r.handler=t._createEventHandler(e,r),t._events[n]=r})}},{key:"_createEventHandler",value:function(e,t){var n=this,i=t.haveStar,r=t.id,o=this.app.options.disabledClass;return function(t){n._eventHandlers[e]||n._error("No event handler for name:",e);var a=l.Adapter.getEventTarget(t),s=[t];l.Adapter.hasClass(a,o)||(i&&s.unshift(a.getAttribute("id").slice(r.length)),n._eventHandlers[e].apply(n,s))}}},{key:"_bindEvents",value:function(){var e=this;d(this._events,function(t){e._region._delegateDomEvent(e,t.eventType,t.selector,t.handler)})}},{key:"_unbindEvents",value:function(){this._region._undelegateDomEvents(this)}},{key:"_renderComponents",value:function(){var e=this;this.chain(f(this._option("components"),function(t){var n=l.isFunction(t)?t.call(e):t;return n?l.ComponentManager.create(e,n):null}),function(t){return f(t,function(t){if(t){var n=t.id,i=t.component,r=t.index,o=e.components[n];l.isArray(o)?o.push(i):e.components[n]=o?[o,i]:i,e._componentMap[r]=t}})})}},{key:"_destroyComponents",value:function(){var e=this;this.components={},d(this._componentMap,function(t){return l.ComponentManager.destroy(e,t)})}},{key:"_wrapDomId",value:function(e){return this.id+e}},{key:"_beforeRender",value:function(){}},{key:"_afterRender",value:function(){}},{key:"_beforeClose",value:function(){}},{key:"_afterClose",value:function(){}},{key:"_element",get:function(){return this._region?this._region._getElement(this):null}}]),r}(l.Base),l.RenderableContainer=function(n){function o(){return i(this,o),e(this,Object.getPrototypeOf(o).apply(this,arguments))}return t(o,n),a(o,[{key:"_initialize",value:function(){var e=r(Object.getPrototypeOf(o.prototype),"_initialize",this).call(this);return this._items={},this.chain(e,this._initializeItems)}},{key:"_afterRender",value:function(){return this.chain(this._initializeRegions,this._renderItems)}},{key:"_afterClose",value:function(){return this._closeRegions()}},{key:"_initializeItems",value:function(){var e=this;this.chain(d(this._option("items"),function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=arguments[1],i=l.isFunction(t)?t.call(e):t;return l.isString(i)&&(i={region:i}),e.app[t.isModule?"_createModule":"_createView"](n,e).then(function(t){var r=t;return r.moduleOptions=i,e._items[n]=t,t})}))}},{key:"_initializeRegions",value:function(){var e=this;return this._regions={},this.chain(this.closeRegions,f(this.$$("[data-region]"),function(t){var n=e._createRegion(t);e._regions[n.name]=n}))}},{key:"_renderItems",value:function(){var e=this;return this.chain(d(this.items,function(t){var n=t.moduleOptions.region;n&&(e.regions[n]||e._error("Region: "+n+" is not defined"),e.regions[n].show(t))}),this)}},{key:"_createRegion",value:function(e){var t=e.getAttribute("data-region");return this.app._createRegion(e,t,this)}},{key:"_closeRegions",value:function(){var e=this._regions;return e?(delete this._regions,this.chain(d(e,function(e){return e.close()}),this)):this}},{key:"items",get:function(){return this._items||{}}},{key:"regions",get:function(){return this._regions||{}}}]),o}(l.Renderable),l.ActionCreator=function(n){function o(){return i(this,o),e(this,Object.getPrototypeOf(o).apply(this,arguments))}return t(o,n),a(o,[{key:"_initializeEvents",value:function(){r(Object.getPrototypeOf(o.prototype),"_initializeEvents",this).call(this),r(Object.getPrototypeOf(o.prototype),"_initializeEvents",this).call(this,this._option("actions"))}},{key:"_createEventHandler",value:function(e,t){var n=!!(this._option("actions")||{})[t.key];return n?this._createAction(e):r(Object.getPrototypeOf(o.prototype),"_createEventHandler",this).call(this,e,t)}},{key:"_createAction",value:function(e){var t=this,n=this.app.options.disabledClass,i=this._option("dataForActions")||{},r=i[e],o=this._option("actionCallbacks")||{},a=o[e];return function(i){var o=l.Adapter.getEventTarget(event);if(!l.Adapter.hasClass(o,n)){l.Adapter.addClass(o,n);var s=t._getActionPayload(o);t.chain(l.isFunction(r)?r.call(t,s,i):s,function(n){return n!==!1?t.module.dispatch(e,n):!1},function(e){return e!==!1?a&&a.call(t,e):!1}).then(function(){return l.Adapter.removeClass(o,n)},function(){return l.Adapter.removeClass(o,n)})}}}},{key:"_getActionPayload",value:function(e){for(var t=this._element,n=e,i=!1;n&&n!==t&&"FORM"!==n.tagName;)n=n.parentNode;n||(n=t);var r="FORM"===n.tagName?l.Adapter.getFormData(n):{};return f(n.querySelectorAll("[data-name][data-value]"),function(t){if(t===e)return i=e.getAttribute("data-name"),void(r[i]=e.getAttribute("data-value"));var n=t.getAttribute("data-name");if(!i||i!==n){var o=t.getAttribute("data-value"),a=r[n];l.isArray(a)?a.push(o):r[n]=null==a?o:[a,o]}}),r}}]),o}(l.Renderable),l.View=function(n){function o(){return i(this,o),e(this,Object.getPrototypeOf(o).apply(this,arguments))}return t(o,n),a(o,[{key:"_initialize",value:function(){return this.bindings={},this.chain(r(Object.getPrototypeOf(o.prototype),"_initialize",this).call(this),this._initializeDataBinding)}},{key:"_initializeDataBinding",value:function(){var e=this;this._dataBinding={},d(this._option("bindings"),function(t,n){var i=e.bindings[n]=e.module.store.models[n];i||e._error("No model:",n),t&&(e._dataBinding[n]={model:i,value:t,fn:function(){t===!0&&e._region&&e.render(e.renderOptions),l.isString(t)&&e._option(t)}})})}},{key:"_bindData",value:function(){var e=this;d(this._dataBinding,function(t){return e.listenTo(t.model,"changed",t.fn)})}},{key:"_unbindData",value:function(){this.stopListening(),this.bindings={}}},{key:"_setRegion",value:function(){for(var e,t=arguments.length,n=Array(t),i=0;t>i;i++)n[i]=arguments[i];(e=r(Object.getPrototypeOf(o.prototype),"_setRegion",this)).call.apply(e,[this].concat(n)),this._bindData()}},{key:"_close",value:function(){for(var e,t=arguments.length,n=Array(t),i=0;t>i;i++)n[i]=arguments[i];this.chain((e=r(Object.getPrototypeOf(o.prototype),"_close",this)).call.apply(e,[this].concat(n)),this._unbindData,this)}},{key:"_serializeData",value:function(){var e=this,t=r(Object.getPrototypeOf(o.prototype),"_serializeData",this).call(this);return d(this.bindings,function(e,n){return t[n]=e.get(!0)}),d(this._option("dataForTemplate"),function(n,i){return t[i]=n.call(e,t)}),t}}]),o}(l.ActionCreator),l.Module=function(n){function o(){return i(this,o),e(this,Object.getPrototypeOf(o).apply(this,arguments))}return t(o,n),a(o,[{key:"_initialize",value:function(){return this.app._modules[this.name+"--"+this.id]=this,this._initializeStore(),r(Object.getPrototypeOf(o.prototype),"_initialize",this).call(this)}},{key:"dispatch",value:function(e,t){this._store.dispatch(e,t)}},{key:"_initializeStore",value:function(){this._store=this.app._createStore(this,this._option("store"))}},{key:"_afterClose",value:function(){return delete this.app._modules[this.name+"--"+this.id],this._store._destory(),r(Object.getPrototypeOf(o.prototype),"_afterClose",this).call(this)}},{key:"_beforeRender",value:function(){var e=this;return this.chain(r(Object.getPrototypeOf(o.prototype),"_beforeRender",this).call(this),function(){return e._store._loadEagerModels()})}},{key:"_afterRender",value:function(){var e=this;return this.chain(r(Object.getPrototypeOf(o.prototype),"_afterRender",this).call(this),function(){return e._store._loadLazyModels()})}},{key:"store",get:function(){return this._store}}]),o}(l.RenderableContainer);var m=["blur","focus","scroll","resize"];l.Region=function(n){function r(t,n,o,a){i(this,r);var s=e(this,Object.getPrototypeOf(r).call(this,a||"Region",{},{app:t,module:n,_el:o,_delegated:{}}));return s._el||s._error("The DOM element for region is required"),t.delegateEvent(s),s}return t(r,n),a(r,[{key:"show",value:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return this._isCurrent(e)?n.forceRender===!1?this.Promise.resolve(this._current):this._current._render(n,!0):this.chain(l.isString(e)?this.app._createModule(e):e,function(e){return e instanceof l.Renderable||t._error("The item is expected to be an instance of Renderable"),e},[function(e){return t.chain(e._region&&e._region.close(),e)},function(){return t.close()}],function(e){var n=o(e,1),i=n[0];t._current=i;var r=i.module?i.module.name+":"+i.name:i.name;return t._getElement().setAttribute("data-current",r),i._setRegion(t),i},function(e){return e._render(n,!1)})}},{key:"close",value:function(){var e=this;return this.chain(this._current&&this._current._close(),function(){return delete e._current},this)}},{key:"$$",value:function(e){return this._getElement().querySelectorAll(e)}},{key:"_isCurrent",value:function(e){return this._current?this._current.name===e?!0:e&&e.id===this._current.id?!0:!1:!1}},{key:"_getElement",value:function(){return this._el}},{key:"_empty",value:function(){this._getElement().innerHTML=""}},{key:"_createDelegateListener",value:function(e){var t=this;return function(n){if(t._delegated[e]){var i=n.target;f(t._delegated[e].items,function(e){for(var r=t._getElement().querySelectorAll(e.selector),o=!1,a=0;a<r.length;a++){var s=r[a];if(s===i||s.contains(i)){o=s;break}}o&&e.fn.call(e.renderable,n)})}}}},{key:"_delegateDomEvent",value:function(e,t,n,i){var r=this._delegated[t];r||(r=this._delegated[t]={listener:this._createDelegateListener(t),items:[]},l.Adapter.addEventListener(this._getElement(),t,r.listener,-1!==m.indexOf(t))),r.items.push({selector:n,fn:i,renderable:e})}},{key:"_undelegateDomEvents",value:function(e){var t=this;d(this._delegated,function(n,i){var r=[],o=n;f(o.items,function(t){t.renderable!==e&&r.push(t)}),o.items=r,0===r.length&&(delete t._delegated[i],l.Adapter.removeEventListener(t._getElement(),i,o.listener))})}}]),r}(l.Base),l.TemplateEngine=function(n){function r(t){return i(this,r),e(this,Object.getPrototypeOf(r).call(this,"Template Engine",t,{_templateCache:{}}))}return t(r,n),a(r,[{key:"executeIdReplacement",value:function(e,t){var n=this,i={};f(e.querySelectorAll("[id]"),function(e){var r=e.getAttribute("id");i[r]&&n._error("Dom ID: "+r+" is already used"),i[r]=!0,e.setAttribute("id",t._wrapDomId(r))});var r=this._option("attributesReferToId")||["for","data-target","data-parent"];f(r,function(n){return f(e.querySelectorAll("["+n+"]"),function(e){var i=e.getAttribute(n),r="#"===i.charAt(0),o=r?"#"+t._wrapDomId(i.slice(1)):t._wrapDomId(i);e.setAttribute(n,o)})})}},{key:"_load",value:function(e){var t=e.id;return this._templateCache[t]?this._templateCache[t]:this._templateCache[t]=this._loadIt(e)}},{key:"_loadIt",value:function(e){return this._option(e instanceof l.Module?"loadModule":"loadView",e)}},{key:"_execute",value:function(e,t,n,i){var r=e instanceof l.Module?"executeModule":"executeView";return this._option(r,e,t,e._element,n,i)}}]),r}(l.Base),l.Store=function(n){function r(t,n){i(this,r);var o=e(this,Object.getPrototypeOf(r).call(this,"Store",n,{app:t.app,module:t,_models:{}}));return o._callbacks=o._option("callbacks"),o.app.delegateEvent(o),o}return t(r,n),a(r,[{key:"dispatch",value:function(e,t){var n=void 0,i=e,r=t;return l.isObject(i)&&(r=i.payload,i=i.name),n=this._callbacks[i],n||this._error("No action callback for name: "+e),this.chain(n.call(this._callbackContext,r))}},{key:"_initialize",value:function(){var e=this;this._initializeModels(),this._callbackContext=Object.assign({models:this.models,module:this.module,app:this.app},l.Request),d(this._callbacks,function(t,n){"app."===n.slice(0,4)&&e.listenTo(e.app,n,function(n){return t.call(e._callbackContext,n)})})}},{key:"_initializeModels",value:function(){var e=this;d(this._option("models"),function(t,n){var i=(l.isFunction(t)?t.call(e):t)||{};return i.shared===!0?void(e._models[n]=e.app.viewport.store[n]):void(e._models[n]=e.app._createModel(e,i))})}},{key:"_loadEagerModels",value:function(){return this.chain(d(this._models,function(e){return e.options.autoLoad===!0?l.Request.get(e):null}))}},{key:"_loadLazyModels",value:function(){return this.chain(d(this._models,function(e){var t=e.options.autoLoad;return t&&t!==!0?l.Request.get(e):null}))}},{key:"_destory",value:function(){this.stopListening()}},{key:"models",get:function(){return this._models}}]),r}(l.Base),l.Model=function(n){function r(t,n){i(this,r);var o=e(this,Object.getPrototypeOf(r).call(this,"Model",n,{app:t.module.app,module:t.module,store:t}));return o._data=o._option("data")||{},o._idKey=o._option("idKey")||o.app.options.idKey,o._params=Object.assign({},o._option("params")),o.app.delegateEvent(o),o}return t(r,n),a(r,[{key:"set",value:function(e,t){var n=this.options.parse?this._option("parse",e):e;this._data=this.options.root?n[this.options.root]:n,t&&this.changed()}},{key:"get",value:function(e){return e?p(this._data):this._data}},{key:"clear",value:function(e){this._data=l.isArray(this._data)?[]:{},e&&this.changed()}},{key:"changed",value:function(){this.trigger("changed")}},{key:"_url",value:function(){return this._option("url")||""}},{key:"fullUrl",get:function(){return l.Request._url(this)}},{key:"params",get:function(){return this._params}},{key:"data",get:function(){return this._data}}]),r}(l.Base),l.Loader=function(n){function r(t,n){return i(this,r),e(this,Object.getPrototypeOf(r).call(this,"Loader",n,{app:t}))}return t(r,n),a(r,null,[{key:"_analyse",value:function(e){if(!l.isString(e))return{loader:null,name:e};var t=e.split(":"),n=t.length>1?t.shift():null;return{loader:n,name:t.shift(),args:t}}}]),a(r,[{key:"loadResource",value:function(e){var t=this,n=this.app.options,i=n.scriptRoot,r=n.getResource,o=n.amd,a=i+"/"+e;return this.Promise.create(function(e,n){o?require([a],e,n):e(r?r.call(t.app,a):require("./"+a))})}},{key:"loadModuleResource",value:function(e,t){return this.loadResource(e.name+"/"+t)}},{key:"loadModule",value:function(e){return this.loadResource(e+"/"+this.app.options.fileNames.module)}},{key:"loadView",value:function(e,t){return this.loadModuleResource(t,""+this.app.options.fileNames.view+e)}},{key:"loadRouter",value:function(e){var t=this.app.options.fileNames.router;return this.loadResource(e?e+"/"+t:t)}}]),r}(l.Base),l.Application=function(r){function o(t){return i(this,o),e(this,Object.getPrototypeOf(o).call(this,t&&t.name||"Application",Object.assign({scriptRoot:"app",urlRoot:"",urlSuffix:"",caseSensitiveHash:!1,defaultRegion:g&&g.document.body,disabledClass:"disabled",getResource:null,idKey:"id",viewport:"viewport",fileNames:{module:"index",view:"view-",router:"router"},pagination:{pageSize:10,pageKey:"_page",pageSizeKey:"_pageSize",recordCountKey:"recordCount"}},t),{global:{},_modules:{},_loaders:{}}))}return t(o,r),a(o,[{key:"_initialize",value:function(){this._templateEngine=this._option("templateEngine"),this.registerLoader("default",new l.Loader(this),!0),this._region=this._createRegion(this._option("defaultRegion"),"Region")}},{key:"registerLoader",value:function(e,t,n){return this._loaders[e]=t,n&&(this._defaultLoader=t),this}},{key:"start",value:function(e){var t,i=this;return e&&(this._router=new l.Router(this)),this.chain(e?(t=this._router)._mountRoutes.apply(t,n(this._option("routers"))):!1,this._region.show(this._option("viewport")),function(e){return i.viewport=e},function(){return e&&i._router._start(e)},this)}},{key:"stop",value:function(){this.off(),this._region.close()}},{key:"navigate",value:function(e,t){this._router&&this._router.navigate(e,t)}},{key:"dispatch",value:function(e,t){var n=l.isObject(e)?e.name:e,i=l.isObject(e)?e.payload:t;this.trigger("app."+n,i)}},{key:"show",value:function(e,t,n){return this.viewport.regions[e].show(t,n)}},{key:"_getLoader",value:function(e,t){return e&&this._loaders[e]||t&&t._loader||this._defaultLoader}},{key:"_createModule",value:function(e,t){var n=this,i=l.Loader._analyse(e),r=i.name,o=i.loader,a=this._getLoader(o,parent);return this.chain(a.loadModule(r),function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return _.createModule(e.type,r,n,t,a,e)})}},{key:"_createView",value:function(e,t){var n=this,i=l.Loader._analyse(e),r=i.name,o=i.loader,a=this._getLoader(o,t);return this.chain(a.loadView(r,t),function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return _.createView(e.type,r,n,t,a,e)})}},{key:"_createRegion",value:function(e,t,n){var i=l.Loader._analyse(t),r=i.name,o=i.loader;return _.createRegion(o,this,n,e,r)}},{key:"_createStore",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return _.createStore(t.type,e,t)}},{key:"_createModel",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return _.createModel(t.type,e,t)}}]),o}(l.Base),Object.assign(l.Application.prototype,l.Event);var y=g&&g.history&&"pushState"in g.history,b=[/:([\w\d]+)/g,"([^/]+)",/\*([\w\d]+)/g,"(.*)"],k=function(){function e(t,n,r,o){i(this,e);var a=r.replace(b[0],b[1]).replace(b[2],b[3]);this.pattern=new RegExp("^"+a+"$",t.options.caseSensitiveHash?"g":"gi"),this.app=t,this.router=n,this.path=r,this.fn=o}return a(e,[{key:"match",value:function(e){return this.pattern.lastIndex=0,this.pattern.test(e)}},{key:"handle",value:function(e){var t,i=this;this.pattern.lastIndex=0;var r=this.pattern.exec(e).slice(1),o=this.router._getInterceptors(this.path);return o.push(this.fn),(t=this.router).chain.apply(t,n(f(o,function(e,t){return function(n){return e.apply(i.router,t>0?[n].concat(r):r)}})))}}]),e}();return l.Router=function(n){function r(t){i(this,r);var n=e(this,Object.getPrototypeOf(r).call(this,"Router",{},{app:t,_routes:[],_interceptors:{},_started:!1}));return n._EVENT_HANDLER=function(){return n._dispath(n._getHash())},n}return t(r,n),a(r,[{key:"navigate",value:function(e,t){this._started&&(y?g.history.pushState({},g.document.title,"#"+e):g.location.replace("#"+e),t!==!1&&this._dispath(e))}},{key:"_start",value:function(e){if(!this._started&&g){l.Adapter.addEventListener(g,"hashchange",this._EVENT_HANDLER,!1);var t=this._getHash()||e;this._started=!0,t&&this.navigate(t)}}},{key:"_stop",value:function(){this._started&&(l.Adapter.removeEventListener(g,"hashchange",this._EVENT_HANDLER),this._started=!1)}},{key:"_dispath",value:function(e){if(e!==this._previousHash){this._previousHash=e;for(var t=0;t<this._routes.length;t++){var n=this._routes[t];if(n.match(e))return void n.handle(e)}}}},{key:"_mountRoutes",value:function(){var e=this,t=c.call(arguments);return this.chain(f(t,function(t){return e.app._getLoader(t).loadRouter(t)}),function(n){return f(n,function(n,i){return e._addRoute(t[i],n)})})}},{key:"_addRoute",value:function(e,t){var n=this,i=t.routes,r=t.interceptors;d(l.isFunction(i)?i.apply(this):i,function(i,r){var o=(e+r).replace(/^\/|\/$/g,"");n._routes.unshift(new k(n.app,n,o,t[i]))}),d(l.isFunction(r)?r.apply(this):r,function(i,r){var o=(e+r).replace(/^\/|\/$/g,"");n._interceptors[o]=t[i]})}},{key:"_getInterceptors",value:function(e){var t=[],n=e.split("/");for(n.pop();n.length>0;){var i=n.join("/");this._interceptors[i]&&t.unshift(this._interceptors[i]),n.pop()}return this._interceptors[""]&&t.unshift(this._interceptors[""]),t}},{key:"_getHash",value:function(){return g.location.hash.slice(1)}}]),r}(l.Base),u});
//# sourceMappingURL=drizzle.min.js.map
