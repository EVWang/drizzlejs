!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.Drizzle=e()}(this,function(){"use strict";function t(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function e(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function n(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var i=function R(t,e,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,e);if(void 0===r){var i=Object.getPrototypeOf(t);return null===i?void 0:R(i,e,n)}if("value"in r)return r.value;var o=r.get;if(void 0!==o)return o.call(n)},o=function(){function t(t,e){var n=[],r=!0,i=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);r=!0);}catch(u){i=!0,o=u}finally{try{!r&&s["return"]&&s["return"]()}finally{if(i)throw o}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t},u={},l=u,c=[].slice,h=function(){},f=function(t,e){var n=[];if(!t)return n;if(t.map)return t.map(e);for(var r=0;r<t.length;r++)n.push(e(t[r],r,t));return n},p=function(t,e){var n=[],r=void 0;if(!t)return n;for(r in t)l.hasOwnProperty.call(t,r)&&n.push(e(t[r],r,t));return n},d=function E(t){if(l.isObject(t)){var e=function(){var e={};return p(t,function(t,n){e[n]=E(t)}),{v:e}}();if("object"===("undefined"==typeof e?"undefined":s(e)))return e.v}return l.isArray(t)?f(t,function(t){return E(t)}):t},v={View:{},Region:{},Module:{},Model:{},register:function(t,e,n){this[t][e]=n},create:function(t,e){for(var n=this[t][e]||l[t],r=arguments.length,i=Array(r>2?r-2:0),o=2;r>o;o++)i[o-2]=arguments[o];return new(Function.prototype.bind.apply(n,[null].concat(i)))}},_=0;f(["Function","Array","String","Object"],function(t){l["is"+t]=function(e){return l.toString.call(e)==="[object "+t+"]"}}),f(["Module","View","Region","Model","Store"],function(t){l["register"+t]=function(e,n){return v.register(t,e,n)},v["create"+t]=function(e){for(var n=arguments.length,r=Array(n>1?n-1:0),i=1;n>i;i++)r[i-1]=arguments[i];return v.create.apply(v,[t,e].concat(r))}}),Object.assign(l,{uniqueId:function(){var t=arguments.length<=0||void 0===arguments[0]?"":arguments[0];return""+t+ ++_},adapt:function(t){Object.assign(l.Adapter,t)}});var g={},m=function(t,e,n){return function(r){var i=r.target,o=!1;f(t.getElement().querySelectorAll(n),function(t){(t===i||t.contains(i))&&(o=t)}),o&&t.trigger(e,r)}},y=["blur","focus","scroll","resize"];l.Adapter={Promise:Promise,ajax:function(t){throw new Error("Ajax is not implemented",t)},ajaxResult:function(t){return t[0]},getEventTarget:function(t){return t.currentTarget||t.target},getFormData:function(t){throw new Error("getFormData is not implemented",t)},delegateDomEvent:function(t,e,n,r,i){var o=n+"-"+t.id,a=t.id+"-"+e.id;e.listenTo(t,o,i),g[a]||(g[a]={});var s=g[a][n]=m(t,o,r);this.addEventListener(t.getElement(),n,s,-1!==y.indexOf(n))},undelegateDomEvents:function(t,e){var n=this,r=t.id+"-"+e.id;e.stopListening(t),p(g[r],function(e,r){n.removeEventListener(t.getElement(),r,e)}),delete g[r]},addEventListener:function(t,e,n,r){t.addEventListener(e,n,r)},removeEventListener:function(t,e,n){t.removeEventListener(t,e,n)},hasClass:function(t,e){return t.classList.contains(e)},addClass:function(t,e){t.classList.add(e)},removeClass:function(t,e){t.classList.remove(e)}},l.Promise=function(){function t(e){r(this,t),this.context=e}return a(t,[{key:"create",value:function(t){var e=this;return new l.Adapter.Promise(function(n,r){t.call(e.context,n,r)})}},{key:"resolve",value:function(t){return l.Adapter.Promise.resolve(t)}},{key:"reject",value:function(t){return l.Adapter.Promise.reject(t)}},{key:"parallel",value:function(t){for(var e=this,n=arguments.length,r=Array(n>1?n-1:0),i=1;n>i;i++)r[i-1]=arguments[i];return this.create(function(n,i){var o=[],a=[],s={};return f(t,function(t,n){var i=l.isFunction(t)?t.apply(e.context,r):t;i&&i.then?(s[a.length]=n,a.push(i)):o[n]=i}),0===a.length?n(o):void l.Adapter.Promise.all(a).then(function(t){p(s,function(e,n){return o[n]=t[e]}),n(o)},function(t){i(t)})})}},{key:"chain",value:function(){for(var t=this,e=arguments.length,r=Array(e),i=0;e>i;i++)r[i]=arguments[i];var o=null,a=function s(e,r,i,a){var u=function(t){o=t,0===e.length?i(o):s(e,e.shift(),i,a)};if(l.isArray(r))0===r.length?u([]):t.parallel.apply(t,[r].concat(n(null!=o?[o]:[]))).then(u,a);else{var c=l.isFunction(r)?r.apply(t.context,null!=o?[o]:[]):r;c&&c.then?c.then(u,a):u(c)}};return 0===r.length?this.resolve():this.create(function(t,e){a(r,t,e,r.shift(),0)})}}]),t}(),l.Event={on:function(t,e,n){this._events||(this._events={}),(this._events[t]||(this._events[t]=[])).push({fn:e,ctx:n})},off:function(t,e){if(this._events&&t&&this._events[t]){if(!e)return void delete this._events[t];var n=[];return f(this._events[t],function(t){t.fn!==e&&n.push(t)}),0===n.length?void delete this._events[t]:void(this._events[t]=n)}},trigger:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;e>r;r++)n[r-1]=arguments[r];return t&&this._events&&this._events[t]?void f(this._events[t],function(t){return t.fn.apply(t.ctx,n)}):this},delegateEvent:function(t){var e=this,n="--"+t.id,r=t;return Object.assign(r,{_listeners:{},listenTo:function(t,e,n){(r._listeners[e]||(r._listeners[e]=[])).push({fn:n,obj:t}),t.on(e,n,r)},stopListening:function(t,n,i){if(!t)return p(r._listeners,function(t,e){return f(t,function(t){return t.obj.off(e,t.fn)})}),void(r._listeners={});if(!n)return p(r._listeners,function(t,n){return f(t,function(t){return e.off(n,t)})}),void(r._listeners={});var o=[];f(r._listeners[n],function(t){return i&&i!==t?o.push(t):e.off(n,t)}),r._listeners[n]=o,0===o.length&&delete r._listeners[n]},on:function(t,i,o){r.listenTo(e,t+n,o)},off:function(t,i){r.stopListening(e,t&&t+n,i)},trigger:function(t){if(!t)return r;for(var i=arguments.length,o=Array(i>1?i-1:0),a=1;i>a;a++)o[a-1]=arguments[a];o.unshift(t+n)&&e.trigger.apply(e,o)}}),this}},l.Request={get:function(t,e){return this._ajax("GET",t,t.params,e)},post:function(t,e){return this._ajax("POST",t,t.data,e)},put:function(t,e){return this._ajax("PUT",t,t.data,e)},del:function(t,e){return this._ajax("DELETE",t,t.data,e)},save:function(t,e){return t.data&&t.data[t._idKey]?this.put(t,e):this.post(t,e)},_url:function(t){var e=[],n=t.module._option("urlPrefix",t)||"",r=t.app._option("urlRoot",t)||"",i=t.app._option("urlSuffix",t)||"",o=t._url()||"";for(r&&e.push(r),n&&e.push(n),e.push(t.module.name);0===o.indexOf("../");)e.pop(),o=o.slice(3);return o&&e.push(o),t.data&&t.data[t._idKey]&&e.push(t.data[t._idKey]),i&&e.push(i),e.join("/")},_ajax:function(t,e,n,r){var i=Object.assign({type:t},r);return i.data=Object.assign({},n,i.data),i.url=this._url(e),l.Promise.create(function(t,n){l.Adapter.ajax(i).then(function(){for(var n=arguments.length,r=Array(n),o=0;n>o;o++)r[o]=arguments[o];e.set(l.Adapter.ajaxResult(r),!i.slient),t(r)},function(){for(var t=arguments.length,e=Array(t),r=0;t>r;r++)e[r]=arguments[r];return n(e)})})}},l.ComponentManager={_handlers:{},_componentCache:{},setDefaultHandler:function(t){var e=arguments.length<=1||void 0===arguments[1]?h:arguments[1];this._defaultHandler={creator:t,destructor:e}},register:function(t,e,n){this.handlers[t]={creator:e,destructor:n||h}},_create:function(t,e){var n=this,r=e.name,i=e.id,o=e.selector,a=e.options;r||t.error("Component name can not be null");var s=this._handlers[r]||this._defaultHandler;s||t.error("No handler for component:",r);var u=o?t.$$(o):t.$(i),c=i?i:l.uniqueId("comp");return t.chain(s.creator(t,u,a),function(e){var r=t.id+c,o=n._componentCache[r],u={id:r,handler:s,index:l.uniqueId(r),options:a};return l.isArray(o)?o.push(u):n._componentCache[r]=o?[o,u]:u,{id:i,component:e,index:u.index}})},_destroy:function(t,e){var n=this,r=t.id+e.id,i=this._componentCache[r],o=i;l.isArray(i)?(this._componentCache[r]=[],f(i,function(t){t.index!==e.index?n._componentCache[r].push(t):o=t}),0===this._componentCache[r].length&&delete this._componentCache[r]):delete this._componentCache[r],o.handler.destructor(t,e.component,o.options)}},l.Base=function(){function t(e){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],i=arguments[2];r(this,t),this.options=n,this.id=l.uniqueId("D"),this.name=e,this.Promise=new l.Promise(this),Object.assign(this,i),n.mixin&&this._mixin(n.mixin),this._loadedPromise=this._initialize()}return a(t,[{key:"_initialize",value:function(){}},{key:"_option",value:function(t){for(var e=this.options[t],n=arguments.length,r=Array(n>1?n-1:0),i=1;n>i;i++)r[i-1]=arguments[i];return l.isFunction(e)?e.apply(this,r):e}},{key:"_error",value:function(t){if(!l.isString(t))throw t;for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;e>r;r++)n[r-1]=arguments[r];throw new Error("["+(this.module?this.module.name+":":"")+this.name+"] "+t+" "+n.join(" "))}},{key:"_mixin",value:function(t){var e=this,n=arguments;p(t,function(t,r){var i=e[r];return i?void(l.isFunction(i)&&(e[r]=function(){var r=c.call(n);return r.unshift(i),t.apply(e,r)})):void(e[r]=t)})}},{key:"chain",value:function(){var t;return(t=this.Promise).chain.apply(t,arguments)}}]),t}(),l.Renderable=function(n){function i(e,n,o,a,s){r(this,i);var u=t(this,Object.getPrototypeOf(i).call(this,e,s,{app:n,module:o,components:{},_loader:a,_componentMap:{},_events:{}}));return u._eventHandlers=u._option("handlers"),u._templateEngine=u._option("templateEngine")||o&&o._templateEngine||n._templateEngine,n.delegateEvent(u),u}return e(i,n),a(i,[{key:"_initialize",value:function(){var t=this;return this.chain([this._templateEngine._load(this),this._initializeEvents()],function(e){var n=o(e,1),r=n[0];return t._template=r})}},{key:"render",value:function(t){return this._render(t,!0)}},{key:"$",value:function(t){return this.$$("#"+this._wrapDomId(t))[0]}},{key:"$$",value:function(t){return this._element.querySelectorAll(t)}},{key:"_render",value:function(){var t=this,e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=arguments[1];return this.region||this.error("Region is null"),this.renderOptions=e,this.chain(this._loadedPromise,this._destroyComponents,function(){return t.trigger("beforeRender")},function(){return t._option("beforeRender")},this._beforeRender,this._serializeData,function(e){return t._renderTemplate(e,n)},this._renderComponents,this._afterRender,function(){return t._option("afterRender")},function(){return t.trigger("afterRender")},this)}},{key:"_setRegion",value:function(t){this._region=t,this._bindEvents()}},{key:"_close",value:function(){var t=this;return this._region?this.chain(function(){return t.trigger("beforeClose")},function(){return t._option("beforeClose")},this._beforeClose,[this._unbindEvents,this.destroyComponents,function(){return t._region._empty(t)}],this._afterClose,function(){return t._option("afterClose")},function(){return t.trigger("afterClose")},function(){return delete t._region},this):this.Promise.resolve(this)}},{key:"_serializeData",value:function(){return{Global:this.app.global,Self:this}}},{key:"_renderTemplate",value:function(t,e){this._templateEngine._execute(this,t,this._template,e)}},{key:"_initializeEvents",value:function(t){var e=this;p(t||this._option("events"),function(t,n){var r=n.replace(/(^\s+)|(\s+$)/g,"").split(/\s+/),i={key:n};2!==r.length&&e._error("Invalid event key"),i.eventType=r[0],"*"===r[1].slice(-1)?(i.id=e._wrapDomId(r[1].slice(0,-1)),i.haveStar=!0,i.selector="[id^="+i.id+"]"):(i.id=e._wrapDomId(r[1]),i.selector="#"+i.id),i.handler=e._createEventHandler(t,i),e._events[n]=i})}},{key:"_createEventHandler",value:function(t,e){var n=this,r=e.haveStar,i=e.id,o=this.app.options.disabledClass;return function(e){n._eventHandlers[t]||n._error("No event handler for name:",t);var a=l.Adapter.getEventTarget(e),s=[e];l.Adapter.hasClass(a,o)||(r&&s.unshift(a.getAttribute("id").slice(i.length)),n._eventHandlers[t].apply(n,s))}}},{key:"_bindEvents",value:function(){var t=this;p(this._events,function(e){t._region._delegateDomEvent(t,e.eventType,e.selector,e.handler)})}},{key:"_unbindEvents",value:function(){this._region._undelegateDomEvents(this)}},{key:"_renderComponents",value:function(){var t=this;this.chain(f(this._option("components"),function(e){var n=l.isFunction(e)?e.call(t):e;return n?l.ComponentManager.create(t,n):null}),function(e){return f(e,function(e){if(e){var n=e.id,r=e.component,i=e.index,o=t.components[n];l.isArray(o)?o.push(r):t.components[n]=o?[o,r]:r,t._componentMap[i]=e}})})}},{key:"_destroyComponents",value:function(){var t=this;this.components={},p(this._componentMap,function(e){return l.ComponentManager.destroy(t,e)})}},{key:"_wrapDomId",value:function(t){return this.id+t}},{key:"_beforeRender",value:function(){}},{key:"_afterRender",value:function(){}},{key:"_beforeClose",value:function(){}},{key:"_afterClose",value:function(){}},{key:"_element",get:function(){return this._region?this._region.getElement(this):null}}]),i}(l.Base),l.RenderableContainer=function(n){function o(){return r(this,o),t(this,Object.getPrototypeOf(o).apply(this,arguments))}return e(o,n),a(o,[{key:"_initialize",value:function(){var t=i(Object.getPrototypeOf(o.prototype),"_initialize",this).call(this);return this._items={},this.chain(t,this._initializeItems)}},{key:"_afterRender",value:function(){return this.chain(this._initializeRegions,this._renderItems)}},{key:"_afterClose",value:function(){return this._closeRegions()}},{key:"_initializeItems",value:function(){var t=this;this.chain(p(this._option("items"),function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],n=arguments[1],r=l.isFunction(e)?e.call(t):e;return l.isString(r)&&(r={region:r}),t.app[e.isModule?"_createModule":"_createView"](n,parent).then(function(r){var i=r;return i.moduleOptions=e,t._items[n]=r,r})}))}},{key:"_initializeRegions",value:function(){var t=this;return this._regions={},this.chain(this.closeRegions,f(this.$$("[data-region]"),function(e){var n=t._createRegion(e);t._regions[n.name]=n}))}},{key:"_renderItems",value:function(){var t=this;return this.chain(p(this.items,function(e){var n=e.moduleOptions.region;n&&(t.regions[n]||t.error("Region: "+n+" is not defined"),t.regions[n].show(e))}),this)}},{key:"_createRegion",value:function(t){var e=t.getAttribute("data-region");return this.app._createRegion(t,e,this)}},{key:"_closeRegions",value:function(){var t=this._regions;return t?(delete this._regions,this.chain(p(t,function(t){return t.close()}),this)):this}},{key:"items",get:function(){return this._items||{}}},{key:"regions",get:function(){return this._regions||{}}}]),o}(l.Renderable),l.ActionCreator=function(n){function o(){return r(this,o),t(this,Object.getPrototypeOf(o).apply(this,arguments))}return e(o,n),a(o,[{key:"_initializeEvents",value:function(){i(Object.getPrototypeOf(o.prototype),"_initializeEvents",this).call(this),i(Object.getPrototypeOf(o.prototype),"_initializeEvents",this).call(this,this._actions)}},{key:"_createEventHandler",value:function(t,e){var n=!!(this._option("actions")||{})[e.key];return n?this._createAction(t):i(Object.getPrototypeOf(o.prototype),"_createEventHandler",this).call(this,t,e)}},{key:"_createAction",value:function(t){var e=this,n=this.app.options.disabledClass,r=this._option("dataForActions")||{},i=r[t],o=this._option("actionCallbacks")||{},a=o[t];return function(r){var o=l.Adapter.getEventTarget(event);if(!l.Adapter.hasClass(o,n)){l.Adapter.addClass(o,n);var s=e._getActionPayload(o);e.chain(l.isFunction(i)?i.call(e,s,r):s,function(n){return n!==!1?e.module.dispatch(t,n):!1},function(t){return t!==!1?a&&a.call(e,t):!1}).then(function(){return l.Adapter.removeClass(o,n)},function(){return l.Adapter.removeClass(o,n)})}}}},{key:"_getActionPayload",value:function(t){for(var e=this._element,n=t,r=!1;n&&n!==e&&"FORM"!==n.tagName;)n=n.parentNode;n||(n=e);var i="FORM"===n.tagName?l.Adapter.getFormData(n):{};return f(n.querySelectorAll("[data-name][data-value]"),function(e){if(e===t)return r=t.getAttribute("data-name"),void(i[r]=t.getAttribute("data-value"));var n=e.getAttribute("data-name");if(!r||r!==n){var o=e.getAttribute("data-value"),a=i[n];l.isArray(a)?a.push(o):i[n]=null==a?o:[a,o]}}),i}}]),o}(l.Renderable),l.View=function(n){function o(){return r(this,o),t(this,Object.getPrototypeOf(o).apply(this,arguments))}return e(o,n),a(o,[{key:"_initialize",value:function(){return this.bindings={},this.chain(i(Object.getPrototypeOf(o.prototype),"_initialize",this).call(this),this._initializeDataBinding)}},{key:"_initializeDataBinding",value:function(){var t=this;this._dataBinding={},p(this._option("bindings"),function(e,n){var r=t.bindings[n]=t.module.store[n];r||t._error("No model:",n),e&&(t._dataBinding[n]={model:r,value:e,fn:function(){e===!0&&t._region&&t.render(t.renderOptions),l.isString(e)&&t._option(e)}})})}},{key:"_bindData",value:function(){var t=this;p(this._dataBinding,function(e){return t.listenTo(e.model,"change",e.fn)})}},{key:"_unbindData",value:function(){this.stopListening(),this.bindings={}}},{key:"_setRegion",value:function(){for(var t,e=arguments.length,n=Array(e),r=0;e>r;r++)n[r]=arguments[r];(t=i(Object.getPrototypeOf(o.prototype),"_setRegion",this)).call.apply(t,[this].concat(n)),this._bindData()}},{key:"_close",value:function(){for(var t,e=arguments.length,n=Array(e),r=0;e>r;r++)n[r]=arguments[r];this.chain((t=i(Object.getPrototypeOf(o.prototype),"_close",this)).call.apply(t,[this].concat(n)),this._unbindData,this)}},{key:"_serializeData",value:function(){var t=this,e=i(Object.getPrototypeOf(o.prototype),"_serializeData",this).call(this);return p(this.bindings,function(t,n){return e[n]=t.get(!0)}),p(this._option("dataForTemplate"),function(n,r){return e[r]=n.call(t,e)}),e}}]),o}(l.ActionCreator),l.Module=function(n){function o(){return r(this,o),t(this,Object.getPrototypeOf(o).apply(this,arguments))}return e(o,n),a(o,[{key:"_initialize",value:function(){return this.app._modules[this.name+"--"+this.id]=this,i(Object.getPrototypeOf(o.prototype),"_initialize",this).call(this)}},{key:"dispatch",value:function(t,e){this._store.dispatch(t,e)}},{key:"_initializeStore",value:function(){this._store=this.app._createStore(this,this._option("store"))}},{key:"_afterClose",value:function(){return delete this.app._modules[this.name+"--"+this.id],this._store._destory(),i(Object.getPrototypeOf(o.prototype),"_afterClose",this).call(this)}},{key:"_beforeRender",value:function(){var t=this;return this.chain(i(Object.getPrototypeOf(o.prototype),"_beforeRender",this).call(this),function(){return t._store._loadEagerModels()})}},{key:"_afterRender",value:function(){var t=this;return this.chain(i(Object.getPrototypeOf(o.prototype),"_afterRender",this).call(this),function(){return t._store._loadLazyModels()})}},{key:"store",get:function(){return this._store}}]),o}(l.RenderableContainer),l.Region=function(n){function i(e,n,o){r(this,i);var a=t(this,Object.getPrototypeOf(i).call(this,o||"Region",{app:e.app,_el:n,module:e}));return a._el||a.error("The DOM element for region is required"),a}return e(i,n),a(i,[{key:"show",value:function(t){var e=this,n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return this._isCurrent(t)?t.forceRender===!1?this.Promise.resolve(this._current):this._current._render(n,!0):this.chain(l.isString(t)?this.app._createModule(t):t,function(t){return t instanceof l.Renderable||e.error("The item is expected to be an instance of Renderable"),t},[function(t){return e.chain(t._region&&t._region.close(),t)},function(){return e.close()}],function(t){var n=o(t,1),r=n[0];e._current=r;var i=r.module?r.module.name+":"+r.name:r.name;return e._getElement().setAttribute("data-current",i),r._setRegion(e)},function(t){return t._render(n,!1)})}},{key:"close",value:function(){var t=this;return this.chain(this._current&&this._current.close(),function(){return delete t._current},this)}},{key:"$$",value:function(t){return this._getElement().querySelectorAll(t)}},{key:"_isCurrent",value:function(t){return this._current?this._current.name===t?!0:t&&t.id===this._current.id?!0:!1:!1}},{key:"_getElement",value:function(){return this._el}},{key:"_empty",value:function(){this._getElement().innerHTML=""}},{key:"_delegateDomEvent",value:function(t,e,n,r){l.Adapter.delegateDomEvent(this,t,e,n,r)}},{key:"_undelegateDomEvents",value:function(t){l.Adapter.undelegateDomEvents(this,t)}}]),i}(l.Base),l.TemplateEngine=function(n){function i(e){return r(this,i),t(this,Object.getPrototypeOf(i).call(this,"Template Engine",e,{_templateCache:{}}))}return e(i,n),a(i,[{key:"_load",value:function(t){var e=t.id;return this._templateCache[e]?this._templateCache[e]:this._templateCache[e]=this._option("load",t)}},{key:"_execute",value:function(t,e,n){return this._option("execute",t,e,t._element,n)}}]),i}(l.Base),l.Store=function(n){function i(e,n){r(this,i);var o=t(this,Object.getPrototypeOf(i).call(this,"Store",n,{app:e.app,module:e,_models:{}}));return o._callbacks=o._option("callbacks"),o.app.delegateEvent(o),o}return e(i,n),a(i,[{key:"dispatch",value:function(t,e){var n=void 0,r=t,i=e;return l.isObject(r)&&(i=r.payload,r=r.name),n=this._callbacks[r],n||this.error("No action callback for name: "+t),this.chain(n.call(this._callbackContext,i))}},{key:"_initialize",value:function(){var t=this;this._initializeModels(),this._callbackContext=Object.assign({models:this.models,module:this.module,app:this.app},l.Request),p(this._callbacks,function(e,n){"app."===n.slice(0,4)&&t.listenTo(t.app,n,function(n){return e.call(t._callbackContext,n)})})}},{key:"_initializeModels",value:function(){var t=this;p(this._option("models"),function(e,n){var r=(l.isFunction(e)?e.call(t):r)||{};return r.shared===!0?void(t._models[n]=t.app.viewport.store[n]):void(t._models[n]=t.app._createModel(t,r))})}},{key:"_loadEagerModels",value:function(){return this.chain(p(this._models,function(t){return t.options.autoLoad===!0?l.Request.get(t):null}))}},{key:"_loadLazyModels",value:function(){return this.chain(p(this._models,function(t){var e=t.options.autoLoad;return e&&e!==!0?l.Request.get(t):null}))}},{key:"_destory",value:function(){this.stopListening()}},{key:"models",get:function(){return this._models}}]),i}(l.Base),l.Model=function(n){function i(e,n){r(this,i);var o=t(this,Object.getPrototypeOf(i).call(this,"Model",n,{app:e.module.app,module:e.module,store:e}));return o._data=o._option("data")||{},o._idKey=o._option("idKey")||o.app.options.idKey,o._params=Object.assign({},o._option("params")),o.app.delegateEvent(o),o}return e(i,n),a(i,[{key:"set",value:function(t,e){var n=this._option("parse",t);this._data=this.options.root?n[this.options.root]:n,e&&this.changed()}},{key:"get",value:function(t){return t?d(this._data):this._data}},{key:"clear",value:function(t){this._data=l.isArray(this._data)?[]:{},t&&this.changed()}},{key:"changed",value:function(){this.trigger("changed")}},{key:"_url",value:function(){return this._option("url")||""}},{key:"fullUrl",get:function(){return l.Request._url(this)}},{key:"params",get:function(){return this._params}},{key:"data",get:function(){return this._data}}]),i}(l.Base),l.Loader=function(n){function i(e,n){return r(this,i),t(this,Object.getPrototypeOf(i).call(this,"Loader",n,{app:e}))}return e(i,n),a(i,null,[{key:"_analyse",value:function(t){if(!l.isString(t))return{loader:null,name:t};var e=t.split(":"),n=e.length>1?e.shift():null;return{loader:n,name:e.shift(),args:e}}}]),a(i,[{key:"loadResource",value:function(t){var e=this,n=this.app.options,r=n.scriptRoot,i=n.getResource,o=n.amd,a=r+"/"+t;return this.Promise.create(function(t,n){o?require([a],function(e){return t(e)},function(t){return n(t)}):t(i?i.call(e.app,a):require("./"+a))})}},{key:"loadModuleResource",value:function(t,e){return this.loadResource(t.name+"/"+e)}},{key:"loadModule",value:function(t){return this.loadResource(t+"/"+this.app.options.fileNames.module)}},{key:"loadView",value:function(t,e){return this.loadModuleResource(e,""+this.app.options.fileNames.view+t)}},{key:"loadRouter",value:function(t){return this.loadResource(t+"/"+this.app.options.fileNames.router)}}]),i}(l.Base),l.Application=function(n){function i(e){return r(this,i),t(this,Object.getPrototypeOf(i).call(this,e&&e.name||"Application",Object.assign({scriptRoot:"app",urlRoot:"",urlSuffix:"",caseSensitiveHash:!1,defaultRegion:root.document.body,disabledClass:"disabled",attributesReferToId:["for","data-target","data-parent"],getResource:null,idKey:"id",viewport:"viewport",fileNames:{module:"index",view:"view-",router:"router"},pagination:{pageSize:10,pageKey:"_page",pageSizeKey:"_pageSize",recordCountKey:"recordCount"}},e),{global:{},_modules:{},_loaders:{}}))}return e(i,n),a(i,[{key:"_initialize",value:function(){this._templateEngine=this._option("templateEngine"),this.registerLoader("default",new l.Loader,!0),this._region=this._createRegion(this._option("defaultRegion"),"Region")}},{key:"registerLoader",value:function(t,e,n){return this.loaders[t]=e,n&&(this._defaultLoader=e),this}},{key:"start",value:function(t){var e=this;return t&&(this._router=new l.Router(this)),this.chain(t?this._router._mountRoutes(this._option("routers")):!1,this._region.show(this._option("viewport")),function(t){return e.viewport=t},function(){return t&&e._router._start(t)},this)}},{key:"stop",value:function(){this.off(),this._region.close()}},{key:"navigate",value:function(t,e){this._router&&this._router.navigate(t,e)}},{key:"dispatch",value:function(t,e){var n=l.isObject(t)?t.name:t,r=l.isObject(t)?t.payload:e;this.trigger("app."+n,r)}},{key:"show",value:function(t,e,n){this.viewport.regions[t].show(e,n)}},{key:"_getLoader",value:function(t,e){return t&&this._loaders[t]||e&&e._loader||this._defaultLoader}},{key:"_createModule",value:function(t,e){var n=this,r=l.Loader._analyse(t),i=r.name,o=r.loader,a=this._getLoader(o,e);return this.chain(a.loadModule(i),function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return v.createModule(t.type,i,n,e,a,t)})}},{key:"_createView",value:function(t,e){var n=this,r=l.Loader._analyse(t),i=r.name,o=r.loader,a=this._getLoader(o,e);return this.chain(a.loadView(i,e),function(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return v.createView(t.type,i,n,e,a,t)})}},{key:"_createRegion",value:function(t,e,n){var r=l.Loader._analyse(e),i=r.name,o=r.loader;return v.createRegion(o,n,t,i)}},{key:"_createStore",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return v.createStore(e.type,t,e)}},{key:"_createModel",value:function(t){var e=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return v.createModel(e.type,t,e)}}]),i}(l.Base),Object.assign(l.Application.prototype,l.Event);var b=root.history&&"pushState"in root.history,k=[/:([\w\d]+)/g,"([^/]+)",/\*([\w\d]+)/g,"(.*)"],O=function(){function t(e,n,i,o){r(this,t);var a=i.replace(k[0],k[1]).replace(k[2],k[3]);this.pattern=new RegExp("^"+a+"$",e.options.caseSensitiveHash?"g":"gi"),this.app=e,this.router=n,this.path=i,this.fn=o}return a(t,[{key:"match",value:function(t){return this.pattern.lastIndex=0,this.pattern.test(t)}},{key:"handle",value:function(t){var e,r=this;this.pattern.lastIndex=0;var i=this.pattern.exec(t).slice(1),o=this.router._getInterceptors(this.path);return o.push(this.fn),(e=this.router).chain.apply(e,n(f(o,function(t,e){return function(n){return t.apply(r.router,e>0?[n].concat(i):i)}})))}}]),t}();return l.Router=function(n){function i(e){r(this,i);var n=t(this,Object.getPrototypeOf(i).call(this,"Router",{},{app:e,_routes:[],_interceptors:{},_started:!1}));return n._EVENT_HANDLER=function(){return n._dispath(n._getHash())},n}return e(i,n),a(i,[{key:"navigate",value:function(t,e){b?root.history.pushState({},root.document.title,"#"+t):root.location.replace("#"+t),e!==!1&&this._dispath(t)}},{key:"_start",value:function(t){if(!this._started){l.Adapter.addEventListener(root,"hashchange",this._EVENT_HANDLER,!1);var e=this._getHash()||t;e&&this.navigate(e),this._started=!0}}},{key:"_stop",value:function(){l.Adapter.removeEventListener(root,"hashchange",this._EVENT_HANDLER),this._started=!1}},{key:"_dispath",value:function(t){if(t!==this._previousHash){this._previousHash=t;for(var e=0;e<this.routes.length;e++){var n=this.routes[e];if(n.match(t))return void n.handle(t)}}}},{key:"_mountRoutes",value:function(){var t=this,e=c.call(arguments);return this.chain(f(e,function(e){return t.app._getLoader(e).loadRouter(e)}),function(n){return f(n,function(n,r){return t._addRoute(e[r],n)})})}},{key:"_addRoute",value:function(t,e){var n=this,r=e.routes,i=e.interceptors;p(l.isFunction(r)?r.apply(this):r,function(r,i){var o=(t+i).replace(/^\/|\/$/g,"");n._routes.unshift(new O(n.app,n,o,e[r]))}),p(l.isFunction(i)?i.apply(this):i,function(r,i){var o=(t+i).replace(/^\/|\/$/g,"");n._interceptors[o]=e[r]})}},{key:"_getInterceptors",value:function(t){var e=[],n=t.split("/");for(n.pop();n.length>0;){var r=n.join("/");this._interceptors[r]&&e.unshift(this._interceptors[r]),n.pop()}return this.interceptors[""]&&e.unshift(this.interceptors[""]),e}},{key:"_getHash",value:function(){return root.location.hash.slice(1)}}]),i}(l.Base),u});
//# sourceMappingURL=drizzle.min.js.map
