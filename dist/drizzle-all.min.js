/*!
 * DrizzleJS v0.2.8
 * -------------------------------------
 * Copyright (c) 2015 Jaco Koo <jaco.koo@guyong.in>
 * Distributed under MIT license
 */
var slice=[].slice,extend=function(t,e){function n(){this.constructor=t}for(var r in e)hasProp.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty,indexOf=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};!function(t,e){var n,r;return"function"==typeof define&&define.amd?define(["jquery","handlebars"],function(n,r){return e(t,n,r)}):module&&module.exports?(n=require("jquery"),r=require("handlebars"),module.exports=e(t,n,r)):t.Drizzle=e(t,n)}(this,function(t,e,n){var r,i,o,s,a,u,h,p,l,c,d,f,g,m,y,v,R,w,x,D,E,L,_,C,I,T,S,b;for(o=a={version:"0.2.8"},I=t.Drizzle,x=0,S=["Function","Object","String","Array","Number","Boolean","Date","RegExp","Undefined","Null"],R=function(t){return o["is"+t]=function(e){return Object.prototype.toString.call(e)==="[object "+t+"]"}},E=0,_=S.length;_>E;E++)D=S[E],R(D);for(o.extend=function(){var t,e,n,r,i,s,a;if(s=arguments[0],i=2<=arguments.length?slice.call(arguments,1):[],!o.isObject(s))return s;for(e=0,n=i.length;n>e;e++){r=i[e];for(t in r)a=r[t],s[t]=a}return s},o.extend(o,{uniqueId:function(t){return(t?t:"")+ ++x},noConflict:function(){return t.Drizzle=oldReferrence,o},joinPath:function(){var t,e,n;return e=1<=arguments.length?slice.call(arguments,0):[],t=e.join("/"),n="",0===t.indexOf("http")&&(n=t.slice(0,7),t=t.slice(7)),t=t.replace(/\/+/g,"/"),n+t}}),o.Deferred={createDeferred:function(){return o.deferredCount||(o.deferredCount=1),o.deferredCount++,e.Deferred()},createRejectedDeferred:function(){var t,e;return t=1<=arguments.length?slice.call(arguments,0):[],e=this.createDeferred(),e.reject.apply(e,t),e},createResolvedDeferred:function(){var t,e;return t=1<=arguments.length?slice.call(arguments,0):[],e=this.createDeferred(),e.resolve.apply(e,t),e},deferred:function(){var t,e,n;return e=arguments[0],t=2<=arguments.length?slice.call(arguments,1):[],o.isFunction(e)&&(e=e.apply(this,t)),(null!=e?e.promise:void 0)?e.promise():(n=this.createDeferred(),n.resolve(e),n.promise())},chain:function(){var t,n,r,i;return i=1<=arguments.length?slice.call(arguments,0):[],r=this.createDeferred(),0===i.length?(r.resolve(),r.promise()):(n=[],t=function(s){return function(a,u){var h,p,l,c;return p=function(t){return!o.isArray(a)&&t.length<2&&(t=t[0]),n.push(t)},(o.isArray(a)?(c=function(){var t,e,r;for(r=[],t=0,e=a.length;e>t;t++)l=a[t],h=[l],u>0&&h.push(n[u-1]),r.push(this.deferred.apply(this,h));return r}.call(s),e.when.apply(e,c)):(h=[a],u>0?h.push(n[u-1]):void 0,s.deferred.apply(s,h))).done(function(){var e;return e=1<=arguments.length?slice.call(arguments,0):[],p(e),0===i.length?r.resolve(n[n.length-1]):t(i.shift(),++u)}).fail(function(){var t;return t=1<=arguments.length?slice.call(arguments,0):[],p(t),r.reject.apply(r,n)})}}(this),t(i.shift(),0),r.promise())}},o.Event={on:function(t,e,n){var r;return this.registeredEvents||(this.registeredEvents={}),((r=this.registeredEvents)[t]||(r[t]=[])).push({fn:e,context:n}),this},off:function(t,e,n){var r;return this.registeredEvents&&(r=this.registeredEvents[t])?(this.registeredEvents[t]=function(){var t,i,o;for(o=[],t=0,i=r.length;i>t;t++)D=r[t],(D.fn!==e||n&&n!==D.context)&&o.push(D);return o}(),0===this.registeredEvents[t].length&&delete this.registeredEvents[t],this):this},trigger:function(){var t,e,n,r,i;if(i=arguments[0],t=2<=arguments.length?slice.call(arguments,1):[],!this.registeredEvents||!(e=this.registeredEvents[i]))return this;for(n=0,r=e.length;r>n;n++)D=e[n],D.fn.apply(D.context,t);return this},delegateEvent:function(t){return o.extend(t,{on:function(e){return function(n,r,i){return t.listenTo(e,n+"."+t.id,r,i),t}}(this),off:function(e){return function(){var n;return n=1<=arguments.length?slice.call(arguments,0):[],n.length>0&&n.unshift(n.shift()+"."+t.id),n.unshift(e),t.stopListening.apply(t,n),t}}(this),trigger:function(e){return function(){var n,r;return r=arguments[0],n=2<=arguments.length?slice.call(arguments,1):[],n.unshift(r+"."+t.id),e.trigger.apply(e,n),t}}(this),listenTo:function(t,e,n,r){var i,o;return o=r||this,this.registeredListeners||(this.registeredListeners={}),((i=this.registeredListeners)[e]||(i[e]=[])).push({fn:n,obj:t,context:o}),t.on(e,n,o),this},stopListening:function(t,e,n){var r,i,o,s,a,u,h,p;if(!this.registeredListeners)return this;if(!t){u=this.registeredListeners;for(r in u)for(p=u[r],i=0,o=p.length;o>i;i++)D=p[i],D.obj.off(r,D.fn,this);return this.registeredListeners={},this}h=this.registeredListeners;for(r in h)if(p=h[r],!e||e===r){for(this.registeredListeners[r]=[],a=0,s=p.length;s>a;a++)D=p[a],D.obj!==t||n&&n!==D.fn?this.registeredListeners[r].push(D):D.obj.off(r,D.fn,D.context);0===this.registeredListeners[r].length&&delete this.registeredListeners[r]}return this}})}},o.Request={url:function(t){var e,n,r;for(n=t.app.options,r=[n.urlRoot],t.module.options.urlPrefix&&r.push(t.module.options.urlPrefix),r.push(t.module.name),e=t.url||"",o.isFunction(e)&&(e=e.apply(t));0===e.indexOf("../");)r.pop(),e=e.slice(3);return e&&r.push(e),t.data.id&&r.push(t.data.id),n.urlSuffix&&r.push(r.pop()+n.urlSuffix),o.joinPath.apply(o,r)},get:function(t,e){return this.ajax({type:"GET"},t,t.getParams(),e)},post:function(t,e){return this.ajax({type:"POST"},t,t.data,e)},put:function(t,e){return this.ajax({type:"PUT"},t,t.data,e)},del:function(t,e){return this.ajax({type:"DELETE"},t,t.data,e)},save:function(t,e){return t.data.id?this.put(t,e):this.post(t,e)},ajax:function(t,n,r,i){var s;return null==i&&(i={}),s=this.url(n),t=o.extend(t,{contentType:n.app.options.defaultContentType},i),r=o.extend(r,i.data),t.url=s,t.data=r,n.chain(e.ajax(t),function(t){var e,r,i;return e=t[0],r=t[1],i=t[2],n.set(e),i})}},a.Base=i=function(){function t(t){this.id=a.uniqueId(t),this.initialize()}return t.include=function(){var t,e,n,r,i,o;for(i=1<=arguments.length?slice.call(arguments,0):[],e=0,n=i.length;n>e;e++){r=i[e];for(t in r)o=r[t],this.prototype[t]=o}return this},t.include(a.Deferred),t.prototype.initialize=function(){},t.prototype.getOptionResult=function(t){return o.isFunction(t)?t.apply(this):t},t.prototype.extend=function(t){var e,n,r,i;if(t){e=function(t){return function(e,n){var r;return a.isFunction(n)?(r=t[e],t[e]=function(){var t;return t=1<=arguments.length?slice.call(arguments,0):[],r&&t.unshift(r),n.apply(this,t)}):t[e]?void 0:t[e]=n}}(this),r=[];for(n in t)i=t[n],r.push(e(n,i));return r}},t}(),s={scriptRoot:"app",urlRoot:"",urlSuffix:"",defaultContentType:"application/json",caseSensitiveHash:!1,attributesReferToId:["for","data-target","data-parent"],fileNames:{module:"index",templates:"templates",view:"view-",template:"template-",handler:"handler-",model:"model-",collection:"collection-",router:"router",templateSuffix:".html"},pagination:{defaultPageSize:10,pageKey:"_page",pageSizeKey:"_pageSize",recordCountKey:"recordCount"},defaultRouter:{routes:{"module/*name":"showModule"},showModule:function(t){return this.app.show(t)}},clickDeferred:function(){}},o.Application=r=function(t){function r(t){null==t&&(t={}),this.options=o.extend({},s,t),this.modules=new l.Container,this.global={},this.loaders={},this.regions=[],r.__super__.constructor.call(this,"a"),this.modules.delegateEvent(this)}return extend(r,t),r.prototype.initialize=function(){var t,n,r;this.registerLoader(new o.SimpleLoader(this)),this.registerLoader(new o.Loader(this),!0),n=o.Helpers;for(t in n)r=n[t],this.registerHelper(t,r);return this.setRegion(new o.Region(this,null,e(document.body)))},r.prototype.registerLoader=function(t,e){return this.loaders[t.name]=t,e?this.defaultLoader=t:void 0},r.prototype.registerHelper=function(t,e){var r;return r=this,n.registerHelper(t,function(){var t;return t=1<=arguments.length?slice.call(arguments,0):[],e.apply(this,[r,n].concat(t))})},r.prototype.getLoader=function(t){var e;return e=h.analyse(t).loader,e&&this.loaders[e]?this.loaders[e]:this.defaultLoader},r.prototype.setRegion=function(t){return this.region=t,this.regions.unshift(this.region)},r.prototype.startRoute=function(){var t,e,n;return t=arguments[0],e=2<=arguments.length?slice.call(arguments,1):[],this.router||(this.router=new o.Router(this)),this.chain((n=this.router).mountRoutes.apply(n,e),function(){return this.router.start(t)})},r.prototype.navigate=function(t,e){return this.router.navigate(t,e)},r.prototype.load=function(){var t,e;return e=1<=arguments.length?slice.call(arguments,0):[],this.chain(function(){var n,r,i;for(i=[],n=0,r=e.length;r>n;n++)t=e[n],i.push(this.getLoader(t).loadModule(t));return i}.call(this))},r.prototype.show=function(t,e){return this.region.show(t,e)},r.prototype.destory=function(){var t;return this.chain(function(){var e,n,r,i;for(r=this.regions,i=[],e=0,n=r.length;n>e;e++)t=r[e],i.push(t.close());return i}.call(this))},r.prototype.message={success:function(t,e){return alert(e||t)},info:function(t,e){return e||(e=t),alert(e||t)},error:function(t,e){return e||(e=t),alert(e||t)}},r}(o.Base),o.Model=p=function(t){function e(t,n,r){var i,o;this.app=t,this.module=n,this.options=null!=r?r:{},this.data=this.options.data||{},this.params={},this.options.pageable&&(i=this.app.options.pagination,o=this.pagination={page:this.options.page||1,pageCount:0,pageSize:this.options.pageSize||i.defaultPageSize,pageKey:this.options.pageKey||i.pageKey,pageSizeKey:this.options.pageSizeKey||i.pageSizeKey,recordCountKey:this.options.recordCountKey||i.recordCountKey}),e.__super__.constructor.call(this,"d"),this.module.container.delegateEvent(this)}return extend(e,t),e.prototype.set=function(t){var e;return this.data=o.isFunction(this.options.parse)?this.options.parse(t):t,(e=this.pagination)&&(e.recordCount=this.data[e.recordCountKey],e.pageCount=Math.ceil(e.recordCount/e.pageSize)),this.options.root&&(this.data=this.data[this.options.root]),this},e.prototype.append=function(t){return o.isObject(this.data)?o.extend(this.data,t):o.isArray(this.data)&&(this.data=this.data.concat(o.isArray(t)?t:[t])),this},e.prototype.setForm=function(t){var e,n,r,i,s;if(t&&t.serializeArray){for(e={},s=t.serializeArray(),n=0,r=s.length;r>n;n++)D=s[n],i=e[D.name],void 0===i?e[D.name]=D.value:(o.isArray(i)||(i=e[D.name]=[e[D.name]]),i.push(e.value));return this.data=e}},e.prototype.find=function(t,e){var n,r,i,s;if(!o.isArray(this.data))return null;for(i=this.data,s=[],n=0,r=i.length;r>n;n++)D=i[n],D[t]===e&&s.push(D);return s},e.prototype.findOne=function(t,e){var n,r,i;if(!o.isArray(this.data))return null;for(i=this.data,n=0,r=i.length;r>n;n++)if(D=i[n],D[t]===e)return D},e.prototype.url=function(){return this.getOptionResult(this.options.url)||""},e.prototype.getFullUrl=function(){return o.Request.url(this)},e.prototype.toJSON=function(){return this.data},e.prototype.getParams=function(){var t,e;return t={},(e=this.pagination)&&(t[e.pageKey]=e.page,t[e.pageSizeKey]=e.pageSize),o.extend(t,this.params,this.options.params)},e.prototype.clear=function(){var t;return this.data={},(t=this.pagination)?(t.page=1,t.pageCount=0):void 0},e.prototype.turnToPage=function(t,e){var n;return(n=this.pagination)&&t<=n.pageCount&&t>=1?(n.page=t,this.get(e)):this.createRejectedDeferred()},e.prototype.firstPage=function(t){var e;return(e=this.pagination)&&1===e.page?this.createRejectedDeferred():this.turnToPage(1,t)},e.prototype.lastPage=function(t){var e;return(e=this.pagination)&&e.page===e.pageCount?this.createRejectedDeferred():this.turnToPage(this.pagination.pageCount,t)},e.prototype.nextPage=function(t){return this.turnToPage(this.pagination.page+1,t)},e.prototype.prevPage=function(t){return this.turnToPage(this.pagination.page-1,t)},e.prototype.getPageInfo=function(){var t,e;return(e=this.pagination)?(t=this.data.length>0?{start:(e.page-1)*e.pageSize+1,end:e.page*e.pageSize,total:e.recordCount}:{start:0,end:0,total:0},t.end>t.total&&(t.end=t.total),t):{}},e}(o.Base),b=["get","post","put","del","save"],w=function(t){return o.Model.prototype[t]=function(e){return this.chain(o.Request[t](this,e),function(t){var e;return e=t[t.length-1],this.trigger("sync"),e})}},L=0,C=b.length;C>L;L++)D=b[L],w(D);return o.Region=f=function(t){function n(t,r,i){if(this.app=t,this.module=r,this.el=i instanceof e?i:e(i),n.__super__.constructor.call(this,"r"),0===this.el.size())throw new Error("Can not find DOM element: "+i)}return extend(n,t),n.types={},n.register=function(t,e){return this.types[t]=e},n.create=function(t,e,r,i){var o;return new(o=this.types[t]||n)(e,r,i)},n.prototype.getEl=function(){return this.el},n.prototype.getCurrentItem=function(){return this.currentItem},n.prototype.setCurrentItem=function(t){return this.currentItem=t},n.prototype.show=function(t,e){var n;return null==e&&(e={}),(n=this.getCurrentItem(t,e))&&(o.isObject(t)&&t.id===n.id||o.isString(t)&&o.Loader.analyse(t).name===n.name)?e.forceRender===!1?this.createResolvedDeferred(n):this.chain(n.render(e),n):this.chain(o.isString(t)?this.app.getLoader(t).loadModule(t):t,function(t){if(!t.render||!t.setRegion)throw new Error("Can not show item: "+t);return t},[function(t){return t.region&&t.region.close(),t},function(){return this.close(n)}],function(t){var n;return n=t[0],n.setRegion(this),this.setCurrentItem(n,e),n},function(t){return t.render(e)})},n.prototype.close=function(){return D=this.currentItem,delete this.currentItem,this.chain(function(){return D?D.close():void 0},this)},n.prototype.delegateEvent=function(t,e,n,r){var i;return i=e+".events"+this.id+t.id,n?this.el.on(i,n,r):this.el.on(i,r)},n.prototype.undelegateEvents=function(t){return this.el.off(".events"+this.id+t.id)},n.prototype.$$=function(t){return this.el.find(t)},n.prototype.setHtml=function(t){return this.el.html(t)},n.prototype.empty=function(){return this.el.empty()},n}(o.Base),o.View=v=function(t){function n(t,e,r,i){this.name=t,this.module=e,this.loader=r,this.options=null!=i?i:{},this.app=this.module.app,this.eventHandlers={},n.__super__.constructor.call(this,"v"),this.module.container.delegateEvent(this)}return extend(n,t),n.ComponentManager={handlers:{},register:function(t,e,n,r){return null==n&&(n=function(){}),null==r&&(r=function(){}),this.handlers[t]={creator:e,destructor:n,initializer:r,initialized:!1}},create:function(t,e){var n,r,i,o,s,a,u;if(null==e&&(e={}),i=e.id,o=e.name,u=e.selector,a=e.options,!o)throw new Error("Component name can not be null");if(!i)throw new Error("Component id can not be null");return n=u?t.$$(u):i?t.$(i):t.getEl(),r=this.handlers[o]||{creator:function(t,e,n){if(!e[o])throw new Error("No component handler for name: "+o);return e[o](n)},destructor:function(t,e,n){return e[o]("destroy")},initialized:!0},s=!r.initialized&&r.initializer?r.initializer():null,r.initialized=!0,t.chain(s,r.creator(t,n,a),function(t){return{id:i,component:t,info:{destructor:r.destructor,options:a}}})},destroy:function(t,e,n){return"function"==typeof n.destructor?n.destructor(t,e,n.options):void 0}},n.prototype.initialize=function(){return this.options.extend&&this.extend(this.options.extend),this.loadDeferred=this.chain([this.loadTemplate(),this.loadHandlers()])},n.prototype.loadTemplate=function(){var t;return this.module.separatedTemplate!==!0?this.chain(this.module.loadDeferred,function(){return this.template=this.module.template}):(t=this.getOptionResult(this.options.template)||this.name,this.chain(this.app.getLoader(t).loadSeparatedTemplate(this,t),function(t){return this.template=t}))},n.prototype.loadHandlers=function(){var t;return t=this.getOptionResult(this.options.handlers)||this.name,this.chain(this.app.getLoader(t).loadHandlers(this,t),function(t){return o.extend(this.eventHandlers,t)})},n.prototype.bindData=function(){return this.module.loadDeferred.done(function(t){return function(){var e,n,r,i,o,s,a;e=t.getOptionResult(t.options.bind)||{},t.data={},i=function(e,n){var r,i,o;return o=n.split("#"),r=o[0],i=o[1],t.listenTo(e,r,function(){var t;if(t=1<=arguments.length?slice.call(arguments,0):[],!r||!i)throw new Error("Incorrect binding string format:"+n);return"function"==typeof this[i]?this[i].apply(this,t):void 0})},s=[];for(o in e){if(a=e[o],t.data[o]=t.module.data[o],!t.data[o])throw new Error("Model: "+o+" doesn't exists");a&&(r=a.replace(/\s+/g,"").split(","),s.push(function(){var t,e,s;for(s=[],e=0,t=r.length;t>e;e++)n=r[e],s.push(i(this.data[o],n));return s}.call(t)))}return s}}(this))},n.prototype.unbindData=function(){return this.stopListening(),delete this.data},n.prototype.wrapDomId=function(t){return""+this.id+t},n.prototype.setRegion=function(t){var e,n,r,i,s,a,u,h,p;this.region=t,e=this.getOptionResult(this.options.events)||{},u=[];for(i in e){if(p=e[i],!o.isString(p))throw new Error("The value defined in events must be a string");a=i.replace(/(^\s+)|(\s+$)/g,"").split(/\s+/),s=a[0],r=a[1],r&&(h="*"===r.charAt(r.length-1)?"[id^="+(r=this.wrapDomId(r.slice(0,-1)))+"]":"#"+(r=this.wrapDomId(r))),n=this.createHandler(s,r,h,p),u.push(this.region.delegateEvent(this,s,h,n))}return u},n.prototype.createHandler=function(t,n,r,i){var o;return o=this,function(){var t,s,a,u,h;return t=1<=arguments.length?slice.call(arguments,0):[],a=e(this),a.hasClass("disabled")?void 0:(r&&"#"!==r.charAt(0)&&(u=a.attr("id"),t.unshift(u.slice(n.length))),"defer"===a.data("after-click")&&(s=o.createDeferred(),a.addClass("disabled"),s.always(function(){return a.removeClass("disabled")}),null!=(h=o.options.clickDeferred||o.app.options.clickDeferred)&&h.call(this,s,a),t.unshift(s)),o.loadDeferred.done(function(){var e;if(e=o.eventHandlers[i],!e)throw new Error("No handler defined with name: "+i);return e.apply(o,t)}))}},n.prototype.getEl=function(){return this.region?this.region.getEl(this):null},n.prototype.$=function(t){if(!this.region)throw new Error("Region is null");return this.region.$$("#"+this.wrapDomId(t))},n.prototype.$$=function(t){if(!this.region)throw new Error("Region is null");return this.getEl().find(t)},n.prototype.close=function(){return this.region?this.chain(function(){var t;return null!=(t=this.options.beforeClose)?t.apply(this):void 0},[function(){return this.region.undelegateEvents(this)},function(){return this.unbindData()},function(){return this.destroyComponents()},function(){return this.unexportRegions()},function(){return this.region.empty(this)}],function(){var t;return null!=(t=this.options.afterClose)?t.apply(this):void 0},function(){return delete this.region},this):this.createResolvedDeferred(this)},n.prototype.render=function(t){if(null==t&&(t={}),!this.region)throw new Error("No region to render in");return this.renderOptions=t,this.chain(this.loadDeferred,[this.unbindData,this.destroyComponents,this.unexportRegions],this.bindData,function(){var t;return null!=(t=this.options.beforeRender)?t.apply(this):void 0},this.beforeRender,this.serializeData,this.options.adjustData||function(t){return t},this.executeTemplate,this.executeIdReplacement,this.renderComponent,this.exportRegions,this.afterRender,function(){var t;return null!=(t=this.options.afterRender)?t.apply(this):void 0},this)},n.prototype.beforeRender=function(){},n.prototype.destroyComponents=function(){var t,e,r;t=this.components||{};for(e in t)r=t[e],n.ComponentManager.destroy(this,r,this.componentInfos[e]);return this.components={},this.componentInfos={}},n.prototype.serializeData=function(){var t,e,n,r;t={},n=this.data;for(e in n)r=n[e],t[e]=r.toJSON();return t},n.prototype.executeTemplate=function(t){var e;return t.Global=this.app.global,t.View=this,e=this.template(t),this.region.setHtml(e,this)},n.prototype.executeIdReplacement=function(){var t,n,r,i,o,s;for(s={},this.$$("[id]").each(function(t){return function(n,r){var i;if(r=e(r),i=r.attr("id"),s[i])throw new Error("The id:"+i+" is used more than once.");return s[i]=!0,r.attr("id",t.wrapDomId(i))}}(this)),i=this.app.options.attributesReferToId||[],o=[],r=0,n=i.length;n>r;r++)t=i[r],o.push(this.$$("["+t+"]").each(function(n){return function(r,i){var o,s;return i=e(i),o=i.attr(t),s="#"===o.charAt(0),s?i.attr(t,"#"+n.wrapDomId(o.slice(1))):i.attr(t,n.wrapDomId(o))}}(this)));return o},n.prototype.renderComponent=function(){var t,e,r;return e=this.getOptionResult(this.options.components)||[],r=function(){var r,i,o;for(o=[],i=0,r=e.length;r>i;i++)t=e[i],t=this.getOptionResult(t),o.push(t?n.ComponentManager.create(this,t):void 0);return o}.call(this),this.chain(r,function(t){return function(e){var n,r,i,o,s;for(s=[],o=0,i=e.length;i>o;o++)n=e[o],n&&(r=n.id,t.components[r]=n.component,s.push(t.componentInfos[r]=n.info));return s}}(this))},n.prototype.exportRegions=function(){return this.exportedRegions={},this.$$("[data-region]").each(function(t){return function(n,r){var i;return r=e(r),i=r.data("region"),t.exportedRegions[i]=t.module.addRegion(i,r)}}(this))},n.prototype.unexportRegions=function(){var t,e;return this.chain(function(){var n,r;n=this.exportedRegions,r=[];for(t in n)e=n[t],r.push(e.close());return r}.call(this),function(){var n,r;n=this.exportedRegions,r=[];for(t in n)e=n[t],r.push(this.module.removeRegion(t));return r}.call(this))},n.prototype.afterRender=function(){},n}(i),c=function(t){function e(){this.modules={},e.__super__.constructor.apply(this,arguments)}return extend(e,t),e.include(o.Event),e.prototype.checkId=function(t){if(!t||!o.isString(t))throw new Error("id: "+t+" is invalid");if(this.modules[t])throw new Error("id: "+t+" is already used")},e.prototype.get=function(t){return this.modules[t]},e.prototype.changeId=function(t,e){var n;if(t!==e){if(this.checkId(e),n=this.modules[t],!n)throw new Error("module id: "+t+" not exists");return delete this.modules[t],n.id=e,this.modules[e]=n}},e.prototype.add=function(t){return this.checkId(t.id),this.modules[t.id]=t},e.prototype.remove=function(t){return delete this.modules[t]},e}(o.Base),u=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return extend(e,t),e.prototype.initialize=function(){return this.isLayout=!0,this.loadDeferred=this.chain([this.loadTemplate(),this.loadHandlers()]),delete this.bindData},e.prototype.setRegion=function(){return e.__super__.setRegion.apply(this,arguments),this.regionInfo=this.module.regionInfo},e}(o.View),o.Module=l=function(t){function n(t,e,r,i){var o;this.name=t,this.app=e,this.loader=r,this.options=null!=i?i:{},o=this.name.split("/"),this.baseName=o[o.length-1],this.container=this.options.container||this.app.modules,this.separatedTemplate=this.options.separatedTemplate===!0,this.regions={},n.__super__.constructor.call(this,"m"),this.container.add(this),this.container.delegateEvent(this)}return extend(n,t),n.Container=c,n.Layout=u,n.prototype.initialize=function(){return this.options.extend&&this.extend(this.options.extend),this.loadDeferred=this.createDeferred(),this.chain([this.loadTemplate(),this.loadLayout(),this.loadData(),this.loadItems()],function(){return this.loadDeferred.resolve()})},n.prototype.loadTemplate=function(){return this.separatedTemplate?void 0:this.chain(this.loader.loadTemplate(this),function(t){return this.template=t})},n.prototype.loadLayout=function(){var t,e;return t=this.getOptionResult(this.options.layout),e=o.isString(t)?t:null!=t?t.name:void 0,e||(e="layout"),this.chain(this.app.getLoader(e).loadLayout(this,e,t),function(t){return function(e){return t.layout=e}}(this))},n.prototype.loadData=function(){var t,e,n,r,i;this.data={},r=[],n=this.getOptionResult(this.options.data)||{},this.autoLoadDuringRender=[],this.autoLoadAfterRender=[],t=function(t){return function(e,n){var i;return i=o.Loader.analyse(e).name,n=t.getOptionResult(n),n&&("after"===n.autoLoad||"afterRender"===n.autoLoad?t.autoLoadAfterRender.push(i):n.autoLoad&&t.autoLoadDuringRender.push(i)),r.push(t.chain(t.app.getLoader(e).loadModel(n,t),function(t){return this.data[i]=t}))}}(this);for(e in n)i=n[e],t(e,i);return this.chain(r)},n.prototype.loadItems=function(){var t,e,n,r;this.items={},this.inRegionItems=[],r=[],e=this.getOptionResult(this.options.items)||[],t=function(t){return function(e,n){var i,s;return n=t.getOptionResult(n),n&&o.isString(n)&&(n={region:n}),i=n.isModule,s=t.chain(t.app.getLoader(e)[i?"loadModule":"loadView"](e,t,n),function(e){return t.items[e.name]=e,e.regionInfo=n,n.region?t.inRegionItems.push(e):void 0}),r.push(s)}}(this);for(n in e)D=e[n],t(n,D);return this.chain(r)},n.prototype.addRegion=function(t,e){var n;return n=e.data("region-type"),this.regions[t]=f.create(n,this.app,this,e)},n.prototype.removeRegion=function(t){return delete this.regions[t]},n.prototype.render=function(t){if(null==t&&(t={}),!this.region)throw new Error("No region to render in");return this.renderOptions=t,t.id&&this.container.changeId(this.id,t.id),this.chain(this.loadDeferred,function(){var t;return null!=(t=this.options.beforeRender)?t.apply(this):void 0},function(){return this.layout.setRegion(this.region)},this.fetchDataDuringRender,function(){return this.layout.render()},function(){var t;return null!=(t=this.options.afterLayoutRender)?t.apply(this):void 0},function(){var t,n,r,i;return t=function(){var t,e,o,s;for(o=this.inRegionItems,s=[],e=0,t=o.length;t>e;e++){if(i=o[e],n=i.regionInfo.region,r=this.regions[n],!r)throw new Error("Can not find region: "+n);s.push(r.show(i))}return s}.call(this),e.when.apply(e,t)},function(){var t;return null!=(t=this.options.afterRender)?t.apply(this):void 0},this.fetchDataAfterRender,this)},n.prototype.setRegion=function(t){this.region=t},n.prototype.close=function(){return this.chain(function(){var t;return null!=(t=this.options.beforeClose)?t.apply(this):void 0},function(){return this.layout.close()},function(){var t,e,n,r;e=this.regions,n=[];for(t in e)r=e[t],n.push(r.close());return n},function(){var t;return null!=(t=this.options.afterClose)?t.apply(this):void 0},function(){return this.container.remove(this.id)},this)},n.prototype.fetchDataDuringRender=function(){var t;return this.chain(function(){var e,n,r,i,o;for(i=this.autoLoadDuringRender,o=[],r=0,n=i.length;n>r;r++)t=i[r],o.push("function"==typeof(e=this.data[t]).get?e.get():void 0);return o}.call(this))},n.prototype.fetchDataAfterRender=function(){var t;return this.chain(function(){var e,n,r,i,o;for(i=this.autoLoadAfterRender,o=[],r=0,n=i.length;n>r;r++)t=i[r],o.push("function"==typeof(e=this.data[t]).get?e.get():void 0);return o}.call(this))},n}(o.Base),o.Loader=h=function(t){function e(t){this.app=t,this.name="default",this.fileNames=this.app.options.fileNames,e.__super__.constructor.apply(this,arguments)}return extend(e,t),e.TemplateCache={},e.analyse=function(t){var e,n,r;return o.isString(t)?(r=t.split(":"),n=r[0],t=r[1],e=3<=r.length?slice.call(r,2):[],t||(t=n,n=null),{loader:n,name:t,args:e}):{loader:null,name:t}},e.prototype.loadResource=function(t,e){var n,r;return t=o.joinPath(this.app.options.scriptRoot,t),e&&(t=e+"!"+t),n=this.createDeferred(),r=function(e){var r;if((null!=(r=e.requireModules)?r[0]:void 0)===t)return define(t,null),require.undef(t),require([t],function(){}),n.resolve(null);throw n.reject(null),e},require([t],function(t){return function(e){return o.isFunction(e)&&(e=e(t.app)),n.resolve(e)}}(this),r),n.promise()},e.prototype.loadModuleResource=function(t,e,n){return this.loadResource(o.joinPath(t.name,e),n)},e.prototype.loadModule=function(t,n){var r;return r=e.analyse(t).name,this.chain(this.loadResource(o.joinPath(r,this.fileNames.module)),function(t){return function(e){var i;return i=new o.Module(r,t.app,t,e),n&&(i.module=n),i}}(this))},e.prototype.loadView=function(t,n,r){return t=e.analyse(t).name,this.chain(this.loadModuleResource(n,this.fileNames.view+t),function(e){return function(r){return new o.View(t,n,e,r)}}(this))},e.prototype.loadLayout=function(t,n,r){return null==r&&(r={}),n=e.analyse(n).name,this.chain(r.templateOnly===!1?this.loadModuleResource(t,n):{},function(e){return function(i){return new o.Module.Layout(n,t,e,o.extend(r,i))}}(this))},e.prototype.innerLoadTemplate=function(t,r){var i,s;return i=r+this.fileNames.templateSuffix,s=e.TemplateCache[t.name+i],s||(s=e.TemplateCache[t.name+i]=this.loadModuleResource(t,i,"text")),this.chain(s,function(t){return o.isString(t)&&(t=e.TemplateCache[i]=n.compile(t)),t})},e.prototype.loadTemplate=function(t){var e;return e=this.fileNames.templates,this.innerLoadTemplate(t,e)},e.prototype.loadSeparatedTemplate=function(t,e){var n;return n=this.fileNames.template+e,this.innerLoadTemplate(t.module,n)},e.prototype.loadModel=function(t,e){return null==t&&(t=""),t instanceof o.Model?t:(o.isString(t)&&(t={url:t}),new o.Model(this.app,e,t))},e.prototype.loadHandlers=function(t,e){return t.options.handlers||{}},e.prototype.loadRouter=function(t){var n;return n=e.analyse(t).name,t=o.joinPath(n,this.fileNames.router),"/"===t.charAt(0)&&(t=t.slice(1)),this.loadResource(t)},e}(o.Base),o.SimpleLoader=y=function(t){function e(){e.__super__.constructor.apply(this,arguments),this.name="simple"}return extend(e,t),e.prototype.loadModule=function(t,e){var n,r;return r=h.analyse(t).name,n=new o.Module(r,this.app,this,{separatedTemplate:!0}),e&&(n.parentModule=e),this.deferred(n)},e.prototype.loadView=function(t,e,n){return t=h.analyse(t).name,this.deferred(new o.View(t,e,this,{}))},e}(o.Loader),T=t.history&&indexOf.call(t.history,"pushState")>=0,g=function(){function t(t,e,n,r){var i;this.app=t,this.router=e,this.path=n,this.fn=r,i=this.path.replace(this.regExps[0],this.regExps[1]).replace(this.regExps[2],this.regExps[3]),this.pattern=new RegExp("^"+i+"$",this.app.options.caseSensitiveHash?"g":"gi")}return t.prototype.regExps=[/:([\w\d]+)/g,"([^/]+)",/\*([\w\d]+)/g,"(.*)"],t.prototype.match=function(t){return this.pattern.lastIndex=0,this.pattern.test(t)},t.prototype.handle=function(t){var e,n,r,i,o,s;return this.pattern.lastIndex=0,e=this.pattern.exec(t).slice(1),s=this.router.getDependencies(this.path),s.push(this),n=function(){var t,n,i;for(i=[],r=n=0,t=s.length;t>n;r=++n)o=s[r],i.push(function(t,n){return function(r){return t.fn.apply(t,n>0?[r].concat(e):e)}}(o,r));return i}(),(i=this.router).chain.apply(i,n)},t}(),o.Router=m=function(n){function r(t){this.app=t,this.routes=[],this.routeMap={},this.dependencies={},this.started=!1,r.__super__.constructor.call(this,"ro")}return extend(r,n),r.prototype.initialize=function(){return this.addRoute("/",this.app.options.defaultRouter)},r.prototype.getHash=function(){return t.location.hash.slice(1)},r.prototype.start=function(n){var r,i;if(!this.started)return this.started=!0,i=T?"popstate.dr":"hashchange.dr",e(t).on(i,function(t){return function(){return t.dispatch(t.getHash())}}(this)),(r=this.getHash())?this.navigate(r,!0):n?this.navigate(n,!0):void 0},r.prototype.stop=function(){return e(t).off(".dr"),this.started=!1},r.prototype.dispatch=function(t){var e,n,r,i;if(this.previousHash!==t)for(this.previousHash=t,r=this.routes,n=0,e=r.length;e>n;n++)if(i=r[n],i.match(t))return i.handle(t)},r.prototype.navigate=function(e,n){return T?t.history.pushState({},t.document.title,"#"+e):t.location.replace("#"+e),n?this.dispatch(e):void 0},r.prototype.mountRoutes=function(){var t,e;return e=1<=arguments.length?slice.call(arguments,0):[],this.chain(function(){var n,r,i;for(i=[],r=0,n=e.length;n>r;r++)t=e[r],i.push(this.app.getLoader(t).loadRouter(t));return i}.call(this),function(t){var n,r,i,o,s;for(o=[],n=i=0,r=t.length;r>i;n=++i)s=t[n],o.push(this.addRoute(e[n],s));return o})},r.prototype.addRoute=function(t,e){var n,r,i,s,a,u,h,p;u=this.getOptionResult(e.routes),n=this.getOptionResult(e.deps);for(r in n)p=n[r],i=o.joinPath(t,r).replace(/^\//,""),h="/"===p.charAt(0)?p.slice(1):o.joinPath(t,p),this.dependencies[i]=h.replace(/^\//,"");s=[];for(r in u){if(p=u[r],i=o.joinPath(t,r).replace(/(^\/|\/$)/g,""),!o.isFunction(e[p]))throw new Error("Route ["+r+": "+p+"] is not defined");a=new g(this.app,this,i,e[p]),this.routes.unshift(a),s.push(this.routeMap[i]=a)}return s},r.prototype.getDependencies=function(t){var e,n;for(n=[],e=this.dependencies[t];null!=e;)n.unshift(this.routeMap[e]),e=this.dependencies[e];return n},r}(o.Base),o.Helpers={layout:function(t,e,n){return this.View.isLayout?n.fn(this):""},view:function(t,e,n,r){return this.View.isLayout||this.View.name!==n?"":r.fn(this);

}},o.MultiRegion=d=function(t){function n(){n.__super__.constructor.apply(this,arguments),this.items={},this.elements={}}return extend(n,t),n.prototype.activate=function(t){},n.prototype.createElement=function(t,n){var r;return r=e("<div></div>"),this.el.append(r),r},n.prototype.getEl=function(t){var e,n;return t?(e=null!=(n=t.regionInfo)?n.key:void 0,e?this.elements[e]||(this.elements[e]=this.createElement(e,t)):null):this.el},n.prototype.close=function(t){var e,n;if(t){if(e=null!=(n=t.regionInfo)?n.key:void 0,!e||!this.items[e])return this.createResolvedDeferred(this);if(this.items[e].id!==t.id)throw new Error("Trying to close an item which is not in the region");return this.chain(function(){return t.close()},function(){return delete this.items[e]},this)}return this.chain(function(){var t,e,n,r;e=this.items,n=[];for(t in e)r=e[t],n.push(r.close());return n},function(){return this.items={},this.elements={}},this)},n.prototype.getCurrentItem=function(t,e){var n,r,i;return null==e&&(e={}),r=o.isString(t)?e.regionKey:null!=(i=t.regionInfo)?i.key:void 0,r?(n=this.items[r])?n:{regionInfo:{key:r}}:null},n.prototype.setCurrentItem=function(t,e){var n,r;return n=t.regionInfo||(t.regionInfo={}),r=n.key||(n.key=e.regionKey||o.uniqueId("K")),this.items[r]=t},n.prototype.setHtml=function(t,e){return this.getEl(e).html(t)},n.prototype.empty=function(t){return t?this.getEl(t).remove():this.el.empty()},n}(o.Region),a});